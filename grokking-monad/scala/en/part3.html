<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-03-22 Sun 01:50 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Grokking Monad in Scala - Free</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<meta name="description" content="Kind and Free Monad"
>
<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/toc.css"/>
<link rel="stylesheet" href="/style/tufte.css"/>
<link rel="alternate" type="application/rss+xml" title="Jichao Ouyang" href="https://feeds.oyanglul.us/JichaoOuyangsBlog"/>
<meta property="og:title" content="Grokking Monad in Scala" />
<meta property="og:description" content="Free Monad" />
<meta property="og:type" content="article" />
<meta content="https://static-2.gumroad.com/res/gumroad/1806288866681/asset_previews/dd7001d38dd3151e4f02f72579258e2f/retina/don_27t_20wish_20for_20it.work_20for_20it..png" property="og:image">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJRFJGX"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header>
    <a accesskey="h" href="/index.html"> HOME </a> |
    <a href="#" id="edit-in-github">EDIT</a> |
    <a href="https://feeds.oyanglul.us/JichaoOuyangsBlog">RSS</a> |
    <a href="https://blog.oyanglul.us/theindex">INDEX</a> |
    <a accesskey="H" href="/jichao.ouyang.html">ABOUT</a> |
    <a href="https://github.com/jcouyang/blog">GITHUB</a>
</header>
</div>
<div id="content">
<header>
<h1 class="title">Grokking Monad in Scala - Free</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org201698a">Kind</a>
<ul>
<li><a href="#org15246b4">FunctionK</a></li>
<li><a href="#org4a1d7f2">Kind Projector</a></li>
<li><a href="#org7d82be9">Rank N Type</a></li>
<li><a href="#orgbaddedb">Natural Transformation</a></li>
</ul>
</li>
<li><a href="#org7efcaaa">Free</a>
<ul>
<li><a href="#org7688e0d">Free Structure</a></li>
<li><a href="#org26f7fc5">CoYoneda Lemma (Trick)</a></li>
<li><a href="#org3929f95">Effects</a></li>
<li><a href="#orgeb1270c">Free your program</a></li>
<li><a href="#org1cb33ec">Interpret your program</a></li>
<li><a href="#orge922336"><span class="todo TODO">TODO</span> What really happened here</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li><a href="./part2.html">part2: Monads</a></li>
<li><b><a href="./part3.html">part3: Advanced Monads</a></b> 👈</li>
</ul>

<div class="epigraph"><blockquote>
<p>
This is the literal programming file that generates <a href="https://github.com/jcouyang/scala-dojo/blob/master/src/test/scala/4-1-kind.scala">4-1-kind.scala</a> and <a href="https://github.com/jcouyang/scala-dojo/blob/master/src/test/scala/4-2-free.scala">4-2-free.scala</a>
</p>

<p>
you can actually run <code>sbt "testOnly *Kind"</code> and <code>sbt "testOnly *Free"</code> for exercises
</p>

</blockquote></div>

<div id="outline-container-org201698a" class="outline-2">
<h2 id="org201698a">Kind</h2>
<div class="outline-text-2" id="text-org201698a">
<p>
Kinds are types for types. Like a function for parameters of type and return a type.
e.g. <code>List[_]</code> is a Kind, it has a <code>hole</code> represented as <code>_</code> in it, which is like parameter in function.
If you fill the hole with a type <code>String</code>, then you will get a type <code>List[String]</code>.
</p>

<p>
Recall our <code>Printable[_]</code> kind defined in <code>3.1.Functor</code>, we'vecreatede implement of typeclass <code>Contravariant</code>
over kind <code>Printable</code>, which means no matter what type you fill into the hole of <code>Printable[_]</code>, it should
fulfill constrain of typeclass <code>Contravariant</code>.
</p>

<p>
You can also define a function over Kind <code>F[_] -&gt; G[_]</code>, which is called <i>FunctionK</i> , just like function over type.
</p>
</div>


<div id="outline-container-org15246b4" class="outline-3">
<h3 id="org15246b4">FunctionK</h3>
<div class="outline-text-3" id="text-org15246b4">
<p>
to define a FuntionK in cats, we can simply use fish arrow <code>~&gt;</code>
</p>

<p>
e.g. a FuntionK from <code>List</code> to <code>Option</code>
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">import</span> cats.~&gt;
<span style="color: #00008b;">val</span> <span style="color: #b8860b;">first</span> <span style="color: #00008b;">=</span> <span style="color: #00008b;">new</span> (<span style="color: #6b8e23;">List</span> ~&gt; <span style="color: #6b8e23;">Option</span>) {
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">apply</span>[<span style="color: #6b8e23;">A</span>](l<span style="color: #00008b;">:</span><span style="color: #36648b;">List</span>[<span style="color: #6b8e23;">A</span>])<span style="color: #00008b;">:</span> <span style="color: #36648b;">Option</span>[<span style="color: #6b8e23;">A</span>] <span style="color: #00008b;">=</span> l.headOption
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a1d7f2" class="outline-3">
<h3 id="org4a1d7f2">Kind Projector</h3>
<div class="outline-text-3" id="text-org4a1d7f2">
<p>
you'll notice that we've include a compiler plugin <code>kind-projector</code><label for="1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="1" class="margin-toggle"/><span class="sidenote">
<a href="https://github.com/non/kind-projector">https://github.com/non/kind-projector</a>
</span> in <code>build.sbt</code>
</p>

<p>
it provides us pretty syntactic suger for such case
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">val</span> <span style="color: #b8860b;">first</span> <span style="color: #00008b;">=</span> <span style="color: #6b8e23;">Lambda</span>[<span style="color: #6b8e23;">List</span> ~&gt; <span style="color: #6b8e23;">Option</span>](<span style="color: #00008b;">_</span>.headOption)
</pre>
</div>

<p>
which will be expanded to exactly the same code as what we defined before.
</p>
</div>
</div>

<div id="outline-container-org7d82be9" class="outline-3">
<h3 id="org7d82be9">Rank N Type</h3>
<div class="outline-text-3" id="text-org7d82be9">
<p>
But why this is useful than function, the <code>fnk</code> in <code>spherePrintable</code> can be easily replace with a
simple function and it should behave still the same.
</p>

<p>
let's create another function that use <code>Sphere ~&gt; Box</code>, to make tuple of sphere <code>(Sphere[String], Sphere[Int])</code> printable
</p>

<p>
you will get some compile error as such
</p>
<pre class="example">
[error] /Users/jichao.ouyang/Develop/scala-dojo/src/main/scala/Free.scala:21:35: type mismatch;
[error]  found   : free.Sphere[A]
[error]  required: free.Sphere[C]
[error]       val box1 = fn(tupleOfSphere._1)
[error]                                   ^
[error] /Users/jichao.ouyang/Develop/scala-dojo/src/main/scala/Free.scala:22:35: type mismatch;
[error]  found   : free.Sphere[B]
[error]  required: free.Sphere[C]
[error]       val box2 = fn(tupleOfSphere._2)
[error]                                   ^
</pre>

<p>
Apparently when your <code>fn</code> is sticked to a <code>C</code> type, it's not convertible to neither A nor B type, even if you stick it
to <code>A</code> type, then the <code>tupleOfSphere._2</code> can't convert to <code>A</code> either.
</p>

<p>
This is <i>Rank 1 Type</i>, because all types A, B, C are fixed in the same rank of <code>tuplePrintable</code>'s polymorphism.
</p>

<p>
To make such code compile, you'll need to make <code>fn</code> as <code>Rank 2 Type</code>, which means <code>fn</code> will not be fixed in the first rank of <code>tuplePrintable</code> polymorphism, it's type polymorphism will be in another rank totally independent from the <code>tuplePrintable</code>
</p>
</div>
</div>

<div id="outline-container-orgbaddedb" class="outline-3">
<h3 id="orgbaddedb">Natural Transformation</h3>
<div class="outline-text-3" id="text-orgbaddedb">
<p>
If your kinds are happened to be a Functor, then this functionK becomes <i>Natural Transformation</i>
</p>

<p>
There's nothing different except that Natural Transformation will provide you a property:
</p>

<div class="epigraph"><blockquote>
<p>
applying FunctionK before or after a Functor <code>map</code> makes no difference
</p>

</blockquote></div>

<p>
hence <code>fnk(fa.map(f))</code> is exactly the same as <code>fnk(fa).map(f)</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org7efcaaa" class="outline-2">
<h2 id="org7efcaaa">Free</h2>
<div class="outline-text-2" id="text-org7efcaaa">
<p>
<i>Free Monad</i> means you can get a <b><b>free</b></b> monad from any <code>Functor</code>
</p>
</div>

<div id="outline-container-org7688e0d" class="outline-3">
<h3 id="org7688e0d">Free Structure</h3>
<div class="outline-text-3" id="text-org7688e0d">
<p>
A Free Structure is basically very similar to <code>Cons</code> and <code>Nil</code> of
<code>List</code>, we call such similarity <i>Isomorphic</i>
</p>

<div class="org-src-container">
<pre class="src src-scala">seal <span style="color: #00008b;">trait</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>[<span style="color: #00008b;">_</span>], <span style="color: #6b8e23;">A</span>]
<span style="color: #228b22;">final</span> <span style="color: #00008b;">case</span> <span style="color: #00008b;">class</span> <span style="color: #36648b;">Pure</span>[<span style="color: #6b8e23;">S</span>[<span style="color: #00008b;">_</span>], <span style="color: #6b8e23;">A</span>](a<span style="color: #00008b;">:</span> <span style="color: #36648b;">A</span>) <span style="color: #00008b;">extends</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">A</span>]
<span style="color: #228b22;">final</span> <span style="color: #00008b;">case</span> <span style="color: #00008b;">class</span> <span style="color: #36648b;">Suspend</span>[<span style="color: #6b8e23;">S</span>[<span style="color: #00008b;">_</span>], <span style="color: #6b8e23;">A</span>](a<span style="color: #00008b;">:</span> <span style="color: #36648b;">S</span>[<span style="color: #6b8e23;">Free</span>[<span style="color: #6b8e23;">S</span>,<span style="color: #6b8e23;">A</span>]]) <span style="color: #00008b;">extends</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">A</span>]
</pre>
</div>

<p>
<code>Pure</code> is like <code>Nil</code> representing the end of structure, and <code>Suspend</code>
to <code>Cons</code> means there is something else left behind.
</p>

<p>
To make it a Monad, which could be something like
</p>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #228b22;">implicit</span> <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">catsFreeMonadForFree</span>[<span style="color: #6b8e23;">S</span>[<span style="color: #00008b;">_</span>]](<span style="color: #228b22;">implicit</span> <span style="color: #6b8e23;">F</span><span style="color: #00008b;">:</span><span style="color: #36648b;">Functor</span>[<span style="color: #6b8e23;">S</span>])<span style="color: #00008b;">:</span> <span style="color: #36648b;">Monad</span>[<span style="color: #6b8e23;">Free</span>[<span style="color: #6b8e23;">S</span>, ?]] <span style="color: #00008b;">=</span>
  <span style="color: #00008b;">new</span> <span style="color: #36648b;">Monad</span>[<span style="color: #6b8e23;">Free</span>[<span style="color: #6b8e23;">S</span>, ?]] {
    <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">pure</span>[<span style="color: #6b8e23;">A</span>](a<span style="color: #00008b;">:</span> <span style="color: #36648b;">A</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">A</span>] <span style="color: #00008b;">=</span> <span style="color: #6b8e23;">Pure</span>(a)
    <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">map</span>[<span style="color: #6b8e23;">A</span>, <span style="color: #6b8e23;">B</span>](fa<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">A</span>])(f<span style="color: #00008b;">:</span> <span style="color: #36648b;">A</span> <span style="color: #00008b;">=&gt;</span> <span style="color: #6b8e23;">B</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">B</span>] <span style="color: #00008b;">=</span> fa.flatMap(a<span style="color: #00008b;">=&gt;</span><span style="color: #6b8e23;">Pure</span>(f(a)))
    <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">flatMap</span>[<span style="color: #6b8e23;">A</span>, <span style="color: #6b8e23;">B</span>](a<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">A</span>])(f<span style="color: #00008b;">:</span> <span style="color: #36648b;">A</span> <span style="color: #00008b;">=&gt;</span> <span style="color: #6b8e23;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">B</span>])<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">S</span>, <span style="color: #6b8e23;">B</span>] <span style="color: #00008b;">=</span> a <span style="color: #00008b;">match</span> {
      <span style="color: #00008b;">case</span> <span style="color: #36648b;">Pure</span>(<span style="color: #b8860b;">a</span>) <span style="color: #00008b;">=&gt;</span> f(a)
      <span style="color: #00008b;">case</span> <span style="color: #36648b;">Suspend</span>(<span style="color: #b8860b;">a</span>) <span style="color: #00008b;">=&gt;</span> <span style="color: #6b8e23;">Suspend</span>(<span style="color: #6b8e23;">F</span>.map(a)(next<span style="color: #00008b;">=&gt;</span>next.flatMap(f)))
    }
  }
</pre>
</div>

<p>
while you probably noticed that we need <code>S</code> to be a <code>Functor</code> first, so that we can
<code>map</code> it's next step and continuous <code>flatMap</code>
</p>
</div>
</div>

<div id="outline-container-org26f7fc5" class="outline-3">
<h3 id="org26f7fc5">CoYoneda Lemma (Trick)</h3>
<div class="outline-text-3" id="text-org26f7fc5">
<p>
The problem becomes "how can we get a free functor from any <code>S[_]</code>?" then
</p>

<p>
This is when we need to introduce <i>CoYoneda Lemma</i>:
</p>

<p>
A <code>CoYoneda[F[_], A]</code> consists of two things
</p>

<ul class="org-ul">
<li>a function <code>B =&gt; A</code></li>
<li>a <code>F[B]</code></li>
</ul>

<p>
Since <code>B</code> can share the same polymorphism of <code>A</code> and <code>F</code>, they are in the same rank<label for="2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="2" class="margin-toggle"/><span class="sidenote">
hope you still remember what "rank" is from 4-1-kind
</span>, so we
can simply add <code>B</code> into the type parameter of <code>CoYoneda</code> as well, thus it becomes <code>CoYoneda[F[_], A, B]</code>,
which we could simply represent it as scala case class:
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">case</span> <span style="color: #00008b;">class</span> <span style="color: #36648b;">CoYoneda</span>[<span style="color: #6b8e23;">F</span>[<span style="color: #00008b;">_</span>], <span style="color: #6b8e23;">A</span>, <span style="color: #6b8e23;">B</span>](fb<span style="color: #00008b;">:</span> <span style="color: #36648b;">F</span>[<span style="color: #6b8e23;">B</span>], f<span style="color: #00008b;">:</span> <span style="color: #36648b;">B</span> <span style="color: #00008b;">=&gt;</span> <span style="color: #6b8e23;">A</span>)
</pre>
</div>

<p>
And define a functor over CoYoneda is very straightforward:
</p>
<div class="org-src-container">
<pre class="src src-scala"><span style="color: #228b22;">implicit</span> <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">functorForCoyoneda</span> <span style="color: #00008b;">=</span> <span style="color: #00008b;">new</span> <span style="color: #36648b;">Functor</span>[<span style="color: #6b8e23;">CoYoneda</span>[<span style="color: #6b8e23;">F</span>, ?, <span style="color: #6b8e23;">B</span>]] {
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">map</span>[<span style="color: #6b8e23;">A</span>, <span style="color: #6b8e23;">C</span>](fa<span style="color: #00008b;">:</span><span style="color: #36648b;">CoYoneda</span>[<span style="color: #6b8e23;">F</span>, <span style="color: #6b8e23;">A</span>, <span style="color: #6b8e23;">B</span>])(f<span style="color: #00008b;">:</span> <span style="color: #36648b;">A</span><span style="color: #00008b;">=&gt;</span><span style="color: #6b8e23;">C</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">CoYoneda</span>[<span style="color: #6b8e23;">F</span>, <span style="color: #6b8e23;">C</span>, <span style="color: #6b8e23;">B</span>] {
    <span style="color: #6b8e23;">CoYoneda</span>(fa.fb, (f compose fa.f)) <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">(f compose fa.f) has type B =&gt; C</span>
  }
}
</pre>
</div>

<p>
It's actully very similar to <i>Continuation Passing Style</i>, which just continous composing function
<code>f</code> to the function inside CoYoneda.
</p>

<p>
Now we know how to map over a <code>CoYoneda</code>, but how can we get a <code>CoYoneda</code>
from any <code>F[_]</code>?
</p>

<p>
<i>CoYoneda Lemma</i> (Trick)
</p>

<p>
The trick is to use the magical <code>identity</code> function <code>A=&gt;A</code>, then we'll get a <code>CoYoneda[F, A, A]</code> from any <code>F[_]</code>
, and eventually, <code>F[_]</code> become a Functor because any <code>CoYoneda</code> is Functor.
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">def</span> <span style="color: #6a5acd;">lift</span>[<span style="color: #6b8e23;">F</span>[<span style="color: #00008b;">_</span>], <span style="color: #6b8e23;">A</span>](fa<span style="color: #00008b;">:</span> <span style="color: #36648b;">F</span>[<span style="color: #6b8e23;">A</span>])<span style="color: #00008b;">:</span><span style="color: #36648b;">CoYoneda</span>[<span style="color: #6b8e23;">F</span>, <span style="color: #6b8e23;">A</span>, <span style="color: #6b8e23;">A</span>] <span style="color: #00008b;">=</span>
  <span style="color: #6b8e23;">CoYoneda</span>(fa, identity<span style="color: #00008b;">:</span><span style="color: #36648b;">A</span><span style="color: #00008b;">=&gt;</span><span style="color: #6b8e23;">A</span>)
</pre>
</div>

<p>
To construct a Free Monad, we can use the CoYoneda Trick to lift any <code>F[_]</code>, and put the CoYoneda to Free.
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">def</span> <span style="color: #6a5acd;">liftF</span>[<span style="color: #6b8e23;">F</span>[<span style="color: #00008b;">_</span>], <span style="color: #6b8e23;">A</span>](value<span style="color: #00008b;">:</span> <span style="color: #36648b;">F</span>[<span style="color: #6b8e23;">A</span>])<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">F</span>, <span style="color: #6b8e23;">A</span>] <span style="color: #00008b;">=</span> <span style="color: #6b8e23;">Suspend</span>(lift(value))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3929f95" class="outline-3">
<h3 id="org3929f95">Effects</h3>
<div class="outline-text-3" id="text-org3929f95">
<p>
Let's forget about CoYoneda<label for="3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="3" class="margin-toggle"/><span class="sidenote">
it's totally fine if you didn't follow, you don't actually need to understand how Free is implemented to use it.
</span> for now, I'm gonna show you how easy to use cat's Free<label for="4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="4" class="margin-toggle"/><span class="sidenote">
Free Monad from cats already embedded CoYoneda trick in it's implementation, namely <code>Flatmaped</code>.
</span> to free your ADT and get a free program
then, separate your effect from the core business logic.
</p>

<p>
Imagine we have a document database to query, it's easy to abstract 3 method on it:
</p>

<ul class="org-ul">
<li><code>get(key: String)</code></li>
<li><code>put(key: String, value: String)</code></li>
<li><code>delete(key: String)</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">object</span> <span style="color: #6b8e23;">Database</span> {
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">get</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span> <span style="color: #00008b;">=</span> {
    println(<span style="color: #8b0000;">"querying database"</span>)
    s<span style="color: #8b0000;">"value for key </span><span style="color: #b8860b;">$key</span><span style="color: #8b0000;">"</span>
  }

  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">put</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>, value<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>) <span style="color: #00008b;">=</span>{
    println(s<span style="color: #8b0000;">"saving </span><span style="color: #b8860b;">$key</span><span style="color: #8b0000;"> to database"</span>)
  }

  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">delete</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>) <span style="color: #00008b;">=</span> {
    println(s<span style="color: #8b0000;">"deleteing </span><span style="color: #b8860b;">$key</span><span style="color: #8b0000;">"</span>)
  }
}
</pre>
</div>

<p>
All of these actions are actually effects, because they will potentially cause some state changes outside the scope where the method is executed.
</p>

<p>
While testing those methods could be a nightmare as well, you have to either setup a real database or mock these methods' implementation
</p>

<p>
You will find it's too hard to mock a <code>object</code>, so the test could end up with a integration test which require real database, or refactor <code>Database</code> to a normal class so you can mock it properly.
</p>

<p>
It's hard to test because:
</p>
<ul class="org-ul">
<li>imperative: when you call the method, the effect actually happen</li>
<li>stateful: the effect and result depends on database, which is out of the scope of <code>Database</code></li>
</ul>

<p>
To make your program more declarative and testable, we can describe all database interactions using ADT
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #228b22;">sealed</span> <span style="color: #00008b;">trait</span> <span style="color: #36648b;">DbEff</span>[<span style="color: #6b8e23;">A</span>]
<span style="color: #00008b;">case</span> <span style="color: #00008b;">class</span> <span style="color: #36648b;">Put</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>, value<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>) <span style="color: #00008b;">extends</span> <span style="color: #36648b;">DbEff</span>[<span style="color: #6b8e23;">Unit</span>]
<span style="color: #00008b;">case</span> <span style="color: #00008b;">class</span> <span style="color: #36648b;">Get</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>) <span style="color: #00008b;">extends</span> <span style="color: #36648b;">DbEff</span>[<span style="color: #6b8e23;">String</span>]
<span style="color: #00008b;">case</span> <span style="color: #00008b;">class</span> <span style="color: #36648b;">Delete</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>) <span style="color: #00008b;">extends</span> <span style="color: #36648b;">DbEff</span>[<span style="color: #6b8e23;">Unit</span>]
</pre>
</div>

<p>
All these ADTs is just describing what kind of behavior a database can provide, and what value they should return.
</p>

<p>
no database interaction will actually happen when you construct those ADTs
</p>
</div>
</div>

<div id="outline-container-orgeb1270c" class="outline-3">
<h3 id="orgeb1270c">Free your program</h3>
<div class="outline-text-3" id="text-orgeb1270c">
<p>
to lift those ADTs into Free, simply using <code>liftF</code> <label for="5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="5" class="margin-toggle"/><span class="sidenote">
here we're using cats free implementation, which already have CoYoneda embedded in <code>Free</code> implementation, so we don't need to <code>lift</code> the value to <code>CoYoneda</code> our self.
</span> we've introduced in <a href="#org26f7fc5">CoYoneda Lemma (Trick)</a>
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">object</span> <span style="color: #6b8e23;">DbEff</span> {
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">get</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">DbEff</span>, <span style="color: #6b8e23;">String</span>] <span style="color: #00008b;">=</span> <span style="color: #6b8e23;">Free</span>.liftF[<span style="color: #6b8e23;">DbEff</span>, <span style="color: #6b8e23;">String</span>](<span style="color: #6b8e23;">Get</span>(key))
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">put</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>, v<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">DbEff</span>, <span style="color: #6b8e23;">Unit</span>] <span style="color: #00008b;">=</span> ???
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">delete</span>(key<span style="color: #00008b;">:</span> <span style="color: #36648b;">String</span>)<span style="color: #00008b;">:</span> <span style="color: #36648b;">Free</span>[<span style="color: #6b8e23;">DbEff</span>, <span style="color: #6b8e23;">Unit</span>] <span style="color: #00008b;">=</span> ???
}
</pre>
</div>

<p>
<code>put</code> and <code>delete</code> should be pretty much the same
</p>

<p>
to lift your <code>program</code> defined before to free, the simplest trick is to change all <code>=</code> to <code>&lt;-</code> and remove <code>val</code>
</p>

<div class="org-src-container">
<pre class="src src-scala"><span style="color: #00008b;">object</span> <span style="color: #6b8e23;">program</span> {                         <span style="color: #00008b;">object</span> <span style="color: #6b8e23;">freeProgram</span> {
  <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">apply</span>() <span style="color: #00008b;">=</span> {                          <span style="color: #00008b;">val</span> <span style="color: #b8860b;">oldKey</span> <span style="color: #00008b;">=</span> <span style="color: #8b0000;">"123"</span>
    <span style="color: #00008b;">val</span> <span style="color: #b8860b;">oldKey</span> <span style="color: #00008b;">=</span> <span style="color: #8b0000;">"123"</span>                     <span style="color: #00008b;">def</span> <span style="color: #6a5acd;">apply</span>() <span style="color: #00008b;">=</span> <span style="color: #00008b;">for</span> {
    <span style="color: #00008b;">val</span> <span style="color: #b8860b;">oldVal</span> <span style="color: #00008b;">=</span> <span style="color: #6b8e23;">Database</span>.get(oldKey)        oldVal <span style="color: #00008b;">&lt;-</span> <span style="color: #6b8e23;">DbEff</span>.get(oldKey)
    <span style="color: #00008b;">val</span> <span style="color: #b8860b;">newVal</span> <span style="color: #00008b;">=</span> s<span style="color: #8b0000;">"this is new: </span><span style="color: #b8860b;">$oldVal</span><span style="color: #8b0000;">"</span>     newVal <span style="color: #00008b;">=</span> s<span style="color: #8b0000;">"this is new: </span><span style="color: #b8860b;">$oldVal</span><span style="color: #8b0000;">"</span>
    <span style="color: #00008b;">val</span> <span style="color: #b8860b;">newKey</span> <span style="color: #00008b;">=</span> oldKey.reverse              newKey <span style="color: #00008b;">=</span> oldKey.reverse
    <span style="color: #6b8e23;">Database</span>.put(newKey, newVal)             <span style="color: #00008b;">_</span> <span style="color: #00008b;">&lt;-</span> <span style="color: #6b8e23;">DbEff</span>.put(newKey, newVal)
    <span style="color: #6b8e23;">Database</span>.delete(oldKey)                  <span style="color: #00008b;">_</span> <span style="color: #00008b;">&lt;-</span> <span style="color: #6b8e23;">DbEff</span>.delete(oldKey)
  }                                        } <span style="color: #00008b;">yield</span> ()
}                                        }
</pre>
</div>

<p>
Just like that, every thing just lifted in to Free, instead of actually querying the database.
</p>
</div>
</div>

<div id="outline-container-org1cb33ec" class="outline-3">
<h3 id="org1cb33ec">Interpret your program</h3>
<div class="outline-text-3" id="text-org1cb33ec">
<p>
Since our program is organized, we can define an interpreter just for test, without actually talk to database, but
simulating the interactions between your program and database. <label for="6" class="margin-toggle sidenote-number"></label><input type="checkbox" id="6" class="margin-toggle"/><span class="sidenote">
remember the <code>Lambda</code> trick from <a href="#org4a1d7f2">Kind Projector</a> ?
</span>
</p>

<p>
So, if you <code>foldMap</code> your program over the interpreter
</p>

<p>
A nice message will tell you when <code>sbt "testOnly *Free"</code>
</p>

<pre class="example">
[info] - should run on fake interpreter to verify your program logic *** FAILED ***
[info]   unexpecting interaction: Delete(321) (4-2-free.scala:17)
</pre>

<p>
You'll know what to fix, seems we have some business bug in <code>freeProgram</code>
</p>
</div>
</div>

<div id="outline-container-orge922336" class="outline-3">
<h3 id="orge922336"><span class="todo TODO">TODO</span> What really happened here</h3>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="https://github.com/non/kind-projector">https://github.com/non/kind-projector</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
hope you still remember what "rank" is from 4-1-kind
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
it's totally fine if you didn't follow, you don't actually need to understand how Free is implemented to use it.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
Free Monad from cats already embedded CoYoneda trick in it's implementation, namely <code>Flatmaped</code>.
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
here we're using cats free implementation, which already have CoYoneda embedded in <code>Free</code> implementation, so we don't need to <code>lift</code> the value to <code>CoYoneda</code> our self.
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
remember the <code>Lambda</code> trick from <a href="#org4a1d7f2">Kind Projector</a> ?
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<footer>
  <p>Author: root
    <a class="github-button" href="https://github.com/sponsors/jcouyang" data-icon="octicon-heart" aria-label="Sponsor @jcouyang on GitHub">Sponsor</a>
    <a aria-label="Follow @jcouyang on GitHub" data-count-aria-label="# followers on GitHub" data-count-api="/users/jcouyang#followers" data-count-href="/jcouyang/followers" href="https://github.com/jcouyang" class="github-button">Follow</a>
  </p>
  <p>Created: 2018-11-19 Mon 00:00</p>
  <p>Generated by: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.3.6) &#215; <a href="https://github.com/jcouyang/orgpress">OrgPress</a></p>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.
  <input type="swiftype" class="st-default-search-input" placeholder="Search"/>
  <a class="gumroad-button" href="https://gum.co/grokking-monad?wanted=true" target="_blank" data-gumroad-single-product="true">范畴论装逼指南，请自觉排队装逼</a>
  <div id="danmaku-comments"></div>
  <div id="disqus_thread"></div>
</footer>
</div>
</body>
</html>
