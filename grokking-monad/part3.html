<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-10-08 Sat 10:58 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>èŒƒç•´è®ºå®Œå…¨è£…é€¼æ‰‹å†Œ / Grokking Monad</title>
<meta name="author" content="æ¬§é˜³ç»§è¶…" />
<meta name="description" content="å·ä¸‰ æåŸºçŒ«å‘¢" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/toc.css"/>
<link rel="stylesheet" href="/style/tufte.css"/>
<link rel="stylesheet" href="/style/main.css"/>
<link rel="alternate" type="application/rss+xml" title="Jichao Ouyang" href="https://feeds.oyanglul.us/JichaoOuyangsBlog"/>
</head>
<body>
<div id="preamble" class="status">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJRFJGX"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header>
    <a accesskey="h" href="/index.html"> HOME </a> |
    <a href="#" id="edit-in-github">EDIT</a> |
    <a href="https://feeds.oyanglul.us/JichaoOuyangsBlog">RSS</a> |
    <a href="https://blog.oyanglul.us/theindex">INDEX</a> |
    <a accesskey="H" href="/jichao.ouyang.html">ABOUT</a> |
    <a href="https://github.com/jcouyang/blog">GITHUB</a>
</header>
</div>
<div id="content" class="content">
<header>
<h1 class="title">èŒƒç•´è®ºå®Œå…¨è£…é€¼æ‰‹å†Œ / Grokking Monad</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9d9ec5e">ç¬¬ä¸‰éƒ¨åˆ†:<ruby>æåŸºçŒ«å‘¢<rt>Advanced Monads</rt></ruby></a>
<ul>
<li><a href="#org94a258b">RWS</a></li>
<li><a href="#org2d76bbe">Monad Transform</a>
<ul>
<li><a href="#orga95d62b">ReaderT</a></li>
</ul>
</li>
<li><a href="#org4cd7db0">Alternative</a></li>
<li><a href="#org3847a38">MonadPlus</a></li>
<li><a href="#orgde953a0">ST Monad</a></li>
<li><a href="#orgd7125c4">Free Monad</a>
<ul>
<li><a href="#org39f2302">Free</a></li>
<li><a href="#org4526f48">Coyoneda</a></li>
<li><a href="#org3872010">Free Functor</a></li>
<li><a href="#orgf41b63e">Interpreter</a></li>
</ul>
</li>
<li><a href="#orgdaccf82"><span class="todo TODO">TODO</span> Free Monoid</a></li>
<li><a href="#org12cde21"><span class="todo TODO">TODO</span> Eff</a></li>
<li><a href="#orgffa68b7"><span class="todo TODO">TODO</span> Comonad</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li><a href="./part1.html">ç¬¬ä¸€éƒ¨åˆ†ï¼šçŒ«è®º</a></li>
<li><a href="./part2.html">ç¬¬äºŒéƒ¨åˆ†ï¼šé£Ÿç”¨çŒ«å‘¢</a></li>
<li><a href="./part3.html"><b>ç¬¬ä¸‰éƒ¨åˆ†ï¼šæåŸºçŒ«å‘¢</b></a> ğŸ‘ˆ</li>
</ul>

<div id="outline-container-org9d9ec5e" class="outline-2">
<h2 id="org9d9ec5e">ç¬¬ä¸‰éƒ¨åˆ†:<ruby>æåŸºçŒ«å‘¢<rt>Advanced Monads</rt></ruby></h2>
<div class="outline-text-2" id="text-org9d9ec5e">
<p>
ç¬¬äºŒéƒ¨åˆ†ä»‹ç»äº†ä¸€äº›å®ç”¨çš„monad instancesï¼Œè¿™äº› monad éƒ½é€šè¿‡åŒæ ·çš„æŠ½è±¡æ–¹å¼ï¼Œè§£å†³äº†åˆ†ç¦»è®¡ç®—ä¸å‰¯ä½œç”¨çš„å·¥ä½œã€‚
</p>

<p>
é€šè¿‡å®ƒä»¬å¯ä»¥è§£å†³å¤§å¤šæ•°çš„åŸºæœ¬é—®é¢˜ï¼Œä½†æ˜¯æ­£å¯¹äºå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦ä¸€äº›æ›´é«˜é˜¶çš„ monad æˆ–è€… patternã€‚
</p>

<p>
å½“æœ‰äº†ç¬¬ä¸€éƒ¨åˆ†çš„ç†è®ºåŸºç¡€å’Œç¬¬äºŒéƒ¨åˆ†çš„å®è·µï¼Œè¿™éƒ¨åˆ†è¦ä»‹ç»çš„çŒ«å‘¢å…¶å®å¹¶ä¸æ˜¯å¾ˆæåŸºã€‚é€šè¿‡è¿™ä¸€éƒ¨åˆ†ä»‹ç»çš„æåŸºçŒ«å‘¢ï¼Œ
æˆ‘ä»¬è¿˜å¯ä»¥åƒ IO monad ä¸€æ ·ï¼Œé€šè¿‡ free æˆ–è€… Eff è‡ªå®šä¹‰è‡ªå·±çš„è®¡ç®—ï¼Œå’Œå¯èƒ½å¸¦å‰¯ä½œç”¨çš„è§£é‡Šå™¨ã€‚
</p>
</div>

<div id="outline-container-org94a258b" class="outline-3">
<h3 id="org94a258b">RWS</h3>
<div class="outline-text-3" id="text-org94a258b">
<p>
RWS æ˜¯ç¼©å†™ Reader Writer State monad, æ‰€ä»¥æ˜æ˜¾æ˜¯ä¸‰ä¸ªmonadçš„åˆä½“ã€‚å¦‚æœå·²ç»å¿˜è®° Reader Writer æˆ–è€… Stateï¼Œè¯·åˆ°ç¬¬äºŒéƒ¨åˆ†å¤ä¹ ä¸€ä¸‹ã€‚
</p>

<p>
ä¸€æ—¦æŠŠä¸‰ä¸ª monad åˆä½“ï¼Œæ„å‘³ç€å¯ä»¥åœ¨åŒä¸€ä¸ª monad ä½¿ç”¨ä¸‰ä¸ª monad çš„æ–¹æ³•ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ Reader çš„ ask, State çš„ get, put, å’Œ Writer çš„ tell
</p>

<pre class="code"><code><span style="font-weight: bold;">readWriteState</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">do</span>
  e <span style="font-weight: bold;">&lt;-</span> ask
  a <span style="font-weight: bold;">&lt;-</span> get
  <span style="color: #81A1C1;">let</span> res <span style="font-weight: bold;">=</span> a <span style="font-weight: bold;">+</span> e
  put res
  tell [res]
  return res
<span style="font-weight: bold;">runRWS</span> readWriteState 1 2
<span style="color: #677691;">-- </span><span style="color: #677691;">(3 3 [3])</span>
</code></pre>

<p>
æ³¨æ„åˆ°è·Ÿ Reader å’Œ State ä¸€æ ·ï¼Œrunçš„æ—¶å€™è¾“å…¥åˆå§‹å€¼
</p>

<p>
å…¶ä¸­ 1 ä¸º Reader çš„å€¼ï¼Œ2 ä¸º State çš„åˆå§‹çŠ¶æ€.
</p>
</div>
</div>

<div id="outline-container-org2d76bbe" class="outline-3">
<h3 id="org2d76bbe">Monad Transform</h3>
<div class="outline-text-3" id="text-org2d76bbe">
<p>
ä½ ä¼šå‘ç° RWS ä¸€èµ·ç”¨æŒºå¥½çš„ï¼Œèƒ½è¯»èƒ½å†™èƒ½æ‰“ logï¼Œä½†æ˜¯å·²ç»å›ºå®šå¥½æ­é…äº†ï¼Œåªèƒ½æ˜¯ RWS ï¼Œå¦‚æœæˆ‘è¿˜æƒ³åŠ å…¥å…¶å®ƒçš„ Monadï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ
</p>

<p>
è¿™æ—¶å€™ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åŠ ä¸ª Tï¼Œæ¯”å¦‚å¯¹äº Readerï¼Œæˆ‘ä»¬æœ‰ ReaderTï¼ŒRWSï¼Œä¹Ÿæœ‰å¯¹åº”çš„ RWSTã€‚å…¶ä¸­ T ä»£è¡¨ Transformã€‚
</p>
</div>

<div id="outline-container-orga95d62b" class="outline-4">
<h4 id="orga95d62b">ReaderT</h4>
<div class="outline-text-4" id="text-orga95d62b">
<p>
è®©æˆ‘æ¥é€šè¿‡ç®€å•çš„ ReaderT æ¥è§£é‡Šåˆ°åº•ä»€ä¹ˆæ˜¯ T å§, é¦–å…ˆè·Ÿ Reader ä¸€æ ·æˆ‘ä»¬æœ‰ä¸ª runReaderT
</p>

<pre class="code"><code><span style="color: #81A1C1;">newtype</span> <span style="color: #81A1C1;">ReaderT</span> e m a <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">ReaderT</span> { runReaderT <span style="font-weight: bold;">::</span> e <span style="font-weight: bold;">-&gt;</span> m a }
</code></pre>

<p>
æ¯”è¾ƒä¸€ä¸‹ Reader çš„å®šä¹‰
</p>
<pre class="code"><code><span style="color: #81A1C1;">newtype</span> <span style="color: #81A1C1;">Reader</span> e a <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Reader</span> { runReader <span style="font-weight: bold;">::</span> (e <span style="font-weight: bold;">-&gt;</span> a) }
</code></pre>

<p>
æœ‰æ²¡æœ‰å‘ç°å¤šäº†ä¸€ä¸ª m, ä¹Ÿå°±æ˜¯è¯´, <code>runReader e</code> ä¼šè¿”å› a, ä½†æ˜¯ <code>runReaderT e</code> åˆ™ä¼šè¿”å› <code>m a</code>
</p>


<figure id="orgf6d2983">
<img src="images/p3-ReaderT.png" alt="p3-ReaderT.png">

</figure>

<pre class="code"><code><span style="color: #81A1C1;">instance</span> (<span style="color: #81A1C1;">Monad</span> m) <span style="font-weight: bold;">=&gt;</span> <span style="color: #81A1C1;">Monad</span> (<span style="color: #81A1C1;">ReaderT</span> e m) <span style="color: #81A1C1;">where</span>
    return   <span style="font-weight: bold;">=</span> lift <span style="font-weight: bold;">.</span> return
    r <span style="font-weight: bold;">&gt;&gt;=</span> k  <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">ReaderT</span> <span style="font-weight: bold;">$</span> <span style="font-weight: bold;">\</span> e <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">do</span>
        a <span style="font-weight: bold;">&lt;-</span> runReaderT r e
        runReaderT (k a) e
</code></pre>

<p>
å†çœ‹çœ‹ monad çš„å®ç°, ä¹Ÿæ˜¯ä¸€æ ·çš„, å…ˆ run ä¸€ä¸‹ <code>r e</code> å¾—åˆ°ç»“æœ <code>a</code>, åº”ç”¨å‡½æ•° <code>k</code> åˆ° <code>a</code>, å† run ä¸€æŠŠ.
</p>


<p>
é—®é¢˜æ˜¯, è¿™é‡Œçš„ <code>return</code> é‡Œé¢çš„ <code>lift</code> æ˜¯å“ªæ¥çš„?
</p>

<pre class="code"><code><span style="color: #81A1C1;">instance</span> <span style="color: #81A1C1;">MonadTrans</span> (<span style="color: #81A1C1;">ReaderT</span> e) <span style="color: #81A1C1;">where</span>
  lift m <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">ReaderT</span> (const m)
</code></pre>


<figure id="org1a1dece">
<img src="images/p3-MonadTrans-ReaderT-e-m.png" alt="p3-MonadTrans-ReaderT-e-m.png">

</figure>

<p>
è¿™ä¸ªå‡½æ•° <code>lift</code> è¢«å®šä¹‰åœ¨ MonadTrans çš„å®ä¾‹ä¸­, ç®€å•çš„æŠŠ m æ”¾åˆ° ReaderT ç»“æœä¸­.
</p>

<p>
ä¾‹å¦‚, <code>lift (Just 1)</code> ä¼šå¾—åˆ° ReaderT, å…¶ä¸­ e éšæ„, m ä¸º Maybe Num
</p>

<p>
é‡ç‚¹éœ€è¦ä½“ä¼šçš„æ˜¯, Reader å¯ä»¥è¶Šè¿‡ Maybe ç›´æ¥æ“ä½œåˆ° Num, å®Œäº†å†åŒ…å›æ¥.
</p>

<p>
æœ‰äº† ReaderT, æ­é… Id Monad å°±å¾ˆå®¹æ˜“åˆ›å»ºå‡ºæ¥ Reader Monad
</p>

<pre class="code"><code><span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">Reader</span> r a<span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">ReaderT</span> r <span style="color: #81A1C1;">Identity</span> a
</code></pre>

<p>
è¶Šè¿‡ Id read åˆ° Id å†…éƒ¨, å®Œäº†å†ç”¨ Id åŒ…å›æ¥, ä¸å°±æ˜¯ Reader äº†ä¹ˆ
</p>

<pre class="code"><code><span style="color: #81A1C1;">ReaderT</span> { runReaderT <span style="font-weight: bold;">::</span> r <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">Identity</span> a }
<span style="color: #677691;">-- </span><span style="color: #677691;">Identity a is a</span>
<span style="color: #81A1C1;">ReaderT</span> { runReaderT <span style="font-weight: bold;">::</span> r <span style="font-weight: bold;">-&gt;</span> a }
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org4cd7db0" class="outline-3">
<h3 id="org4cd7db0">Alternative</h3>
<div class="outline-text-3" id="text-org4cd7db0">
<p>
è¿™ä¸ª typeclass æä¾› <code>&lt;|&gt;</code> å‡½æ•°, è¡¨ç¤ºè¦ä¹ˆè®¡ç®—å·¦è¾¹, è¦ä¹ˆè®¡ç®—å³è¾¹
</p>

<pre class="code"><code><span style="color: #81A1C1;">class</span> <span style="color: #81A1C1;">Applicative</span> f <span style="font-weight: bold;">=&gt;</span> <span style="color: #81A1C1;">Alternative</span> f <span style="color: #81A1C1;">where</span>
    empty <span style="font-weight: bold;">::</span> f a
    (<span style="font-weight: bold;">&lt;|&gt;</span>) <span style="font-weight: bold;">::</span> f a <span style="font-weight: bold;">-&gt;</span> f a <span style="font-weight: bold;">-&gt;</span> f a
</code></pre>


<figure id="org220871a">
<img src="images/p3-Alternative.png" alt="p3-Alternative.png">

</figure>

<p>
å…¶å®å°±æ˜¯ Applicative çš„ <code>æˆ–</code>
</p>

<p>
æ¯”å¦‚:
</p>
<pre class="code"><code><span style="color: #81A1C1;">Just</span> 1 <span style="font-weight: bold;">&lt;|&gt;</span> <span style="color: #81A1C1;">Just</span> 2 <span style="color: #677691;">-- </span><span style="color: #677691;">Just 1</span>
<span style="color: #81A1C1;">Just</span> 1 <span style="font-weight: bold;">&lt;|&gt;</span> <span style="color: #81A1C1;">Nothing</span> <span style="color: #677691;">-- </span><span style="color: #677691;">Just 1</span>
<span style="color: #81A1C1;">Nothing</span> <span style="font-weight: bold;">&lt;|&gt;</span> <span style="color: #81A1C1;">Just</span> 1 <span style="color: #677691;">-- </span><span style="color: #677691;">Just 1</span>
<span style="color: #81A1C1;">Nothing</span> <span style="font-weight: bold;">&lt;|&gt;</span> <span style="color: #81A1C1;">Nothing</span> <span style="color: #677691;">-- </span><span style="color: #677691;">Nothing</span>
</code></pre>
</div>
</div>

<div id="outline-container-org3847a38" class="outline-3">
<h3 id="org3847a38">MonadPlus</h3>
<div class="outline-text-3" id="text-org3847a38">
<p>
è¿™è·Ÿ Alternative æ˜¯ä¸€æ¯›ä¸€æ ·çš„, åªæ˜¯é™åˆ¶çš„æ›´ç»†, å¿…é¡»æ˜¯ Monadæ‰è¡Œ
</p>

<pre class="code"><code><span style="color: #81A1C1;">class</span> (<span style="color: #81A1C1;">Alternative</span> m, <span style="color: #81A1C1;">Monad</span> m) <span style="font-weight: bold;">=&gt;</span> <span style="color: #81A1C1;">MonadPlus</span> m <span style="color: #81A1C1;">where</span>
   mzero <span style="font-weight: bold;">::</span> m a
   mzero <span style="font-weight: bold;">=</span> empty
   mplus <span style="font-weight: bold;">::</span> m a <span style="font-weight: bold;">-&gt;</span> m a <span style="font-weight: bold;">-&gt;</span> m a
   mplus <span style="font-weight: bold;">=</span> (<span style="font-weight: bold;">&lt;|&gt;</span>)
</code></pre>

<p>
çœ‹, å®ç°ä¸­ç›´æ¥å°±è°ƒç”¨äº† Alternative çš„ <code>empty</code> å’Œ <code>&lt;|&gt;</code>
</p>
</div>
</div>

<div id="outline-container-orgde953a0" class="outline-3">
<h3 id="orgde953a0">ST Monad</h3>
<div class="outline-text-3" id="text-orgde953a0">
<p>
ST Monad è·Ÿ State Monad çš„åŠŸèƒ½æœ‰äº›åƒ, ä¸è¿‡æ›´å‰å®³çš„æ˜¯, ä»–ä¸æ˜¯ immutable çš„, è€Œæ˜¯ "immutable" çš„åœ¨åŸåœ°åšä¿®æ”¹. æ”¹å®Œä¹‹å runST åˆç„¶ä»–å›åˆ°äº† immutable çš„ Haskell ä¸–ç•Œ.
</p>

<pre class="code"><code><span style="font-weight: bold;">sumST</span> <span style="font-weight: bold;">::</span> <span style="color: #81A1C1;">Num</span> a <span style="font-weight: bold;">=&gt;</span> [a] <span style="font-weight: bold;">-&gt;</span> a
<span style="font-weight: bold;">sumST</span> xs <span style="font-weight: bold;">=</span> runST <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">do</span>           <span style="color: #677691;">-- </span><span style="color: #677691;">do &#21518;&#38754;&#30340;&#20107;&#24773;&#20250;&#26159;&#19981;&#38169;&#30340;&#20869;&#23384;&#25805;&#20316;, runST &#21487;&#20197;&#25226;&#23427;&#25289;&#20250;&#32431;&#30340;&#19990;&#30028;</span>
    n <span style="font-weight: bold;">&lt;-</span> newSTRef 0             <span style="color: #677691;">-- </span><span style="color: #677691;">&#22312;&#20869;&#23384;&#20013;&#21019;&#24314;&#19968;&#22359;&#24182;&#25351;&#21040; STRef</span>
    forM_ xs <span style="font-weight: bold;">$</span> <span style="font-weight: bold;">\</span>x <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">do</span>         <span style="color: #677691;">-- </span><span style="color: #677691;">&#36825;&#36319;&#21629;&#20196;&#24335;&#30340;for&#24490;&#29615;&#25913;&#20889;&#21464;&#37327;&#26159;&#19968;&#27611;&#19968;&#26679;&#30340;</span>
        modifySTRef n (<span style="font-weight: bold;">+</span>x)
    readSTRef n                 <span style="color: #677691;">-- </span><span style="color: #677691;">&#36820;&#22238;&#25913;&#23436;&#20043;&#21518;&#30340; n &#30340;&#20540;</span>
</code></pre>
</div>
</div>

<div id="outline-container-orgd7125c4" class="outline-3">
<h3 id="orgd7125c4">Free Monad</h3>
<div class="outline-text-3" id="text-orgd7125c4">
<p>
ä¸Šä¸€ç« è¯´è¿‡çš„ RWS Monad æ¯•ç«Ÿæ˜¯å›ºå®šæ­é…ï¼Œå½“ä½ çš„ä¸šåŠ¡éœ€è¦æ›´å¤šçš„ Monad æ¥è¡¨ç¤º Effect æ—¶ï¼Œ
æˆ‘ä»¬å°±éœ€è¦æœ‰é‚£ä¹ˆä¸ªå°çŒªæ‰‹å¸®æˆ‘ä»¬å®šä¹‰è‡ªå·±çš„ Monadã€‚
</p>

<p>
é‚£å°±æ˜¯ Free, Free å¯ä»¥å°†ä»»æ„ datatype lift æˆä¸º Monad
</p>
</div>

<div id="outline-container-org39f2302" class="outline-4">
<h4 id="org39f2302">Free</h4>
<div class="outline-text-4" id="text-org39f2302">
<p>
å…ˆçœ‹ Free ä»€ä¹ˆå®šä¹‰:
</p>

<pre class="code"><code><span style="color: #81A1C1;">data</span> <span style="color: #81A1C1;">Free</span> f a <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> (f (<span style="color: #81A1C1;">Free</span> f a)) <span style="font-weight: bold;">|</span> <span style="color: #81A1C1;">Return</span> a
</code></pre>

<pre class="code"><code>seal <span style="color: #81A1C1;">trait</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>]
<span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">class</span> <span style="color: #81A1C1;">Roll</span>[<span style="color: #81A1C1;">S</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">S</span>[<span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>,<span style="color: #81A1C1;">A</span>]]) <span style="color: #81A1C1;">extends</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">A</span>]
<span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">class</span> <span style="color: #81A1C1;">Return</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>) <span style="color: #81A1C1;">extends</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">A</span>]
</code></pre>

<p>
å…¶ä¸­ <code>f</code> å°±æ˜¯ä½ ä¸šåŠ¡éœ€è¦çš„ effect ç±»å‹, <code>a</code> æ˜¯è¿™ä¸ª effect æ‰€äº§ç”Ÿçš„è¿”å›å€¼ç±»å‹ã€‚
</p>

<p>
å³è¾¹ä¸¤ç§æ„é€ å‡½æ•°ï¼Œå¦‚æœæŠŠ <code>Role</code> æ”¹æˆ <code>Cons</code>, <code>Return</code> æ”¹æˆ <code>Nil</code> çš„è¯, æ˜¯ä¸æ˜¯è·Ÿ List å…¶å®æ˜¯ <ruby>åŒæ„<rt>isomophic</rt></ruby> çš„å‘¢? æ‰€ä»¥å¦‚æœæƒ³è±¡æˆ List, é‚£ä¹ˆ <code>f</code> åœ¨è¿™é‡Œå°±ç›¸å½“äº List ä¸­çš„ä¸€ä¸ªå…ƒç´ .
</p>

<p>
åˆ°é‚£æ—¶, <code>&gt;&gt;=</code> çš„æ“ä½œåˆè·Ÿ List ç•¥æœ‰ä¸åŒ, æˆ‘ä»¬éƒ½çŸ¥é“ <code>&gt;&gt;=</code> ä¼šæŠŠæ¯ä¸€ä¸ªå…ƒç´  map æˆ List, ç„¶å flatten, ä½† Free å…¶å®æ˜¯ç”¨æ¥æ„å»º
é¡ºåºçš„ effect çš„, æ‰€ä»¥:
</p>

<pre class="code"><code><span style="color: #81A1C1;">instance</span> <span style="color: #81A1C1;">Functor</span> f <span style="font-weight: bold;">=&gt;</span> <span style="color: #81A1C1;">Monad</span> (<span style="color: #81A1C1;">Free</span> f) <span style="color: #81A1C1;">where</span>
  return a        <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Return</span> a
  <span style="color: #81A1C1;">Return</span> a <span style="font-weight: bold;">&gt;&gt;=</span> fn <span style="font-weight: bold;">=</span> fn a
  <span style="color: #81A1C1;">Roll</span> ffa <span style="font-weight: bold;">&gt;&gt;=</span> fn <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> fmap (<span style="font-weight: bold;">&gt;&gt;=</span> fn) ffa
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">implicit</span> <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">monadForFree</span>[<span style="color: #81A1C1;">S</span>[<span style="color: #81A1C1;">_</span>]](<span style="color: #81A1C1;">implicit</span> <span style="color: #81A1C1;">F</span><span style="color: #81A1C1;">:</span><span style="color: #81A1C1;">Functor</span>[<span style="color: #81A1C1;">S</span>])<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Monad</span>[<span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, ?]] <span style="color: #81A1C1;">=</span>
  <span style="color: #81A1C1;">new</span> <span style="color: #81A1C1;">Monad</span>[<span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, ?]] {
    <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">pure</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Return</span>(a)
    <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">map</span>[<span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">B</span>](fa<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">A</span>])(f<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span> <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">B</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">B</span>] <span style="color: #81A1C1;">=</span> fa.flatMap(a<span style="color: #81A1C1;">=&gt;</span><span style="color: #81A1C1;">Return</span>(f(a)))
    <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">flatMap</span>[<span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">B</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">A</span>])(f<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span> <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">B</span>])<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">S</span>, <span style="color: #81A1C1;">B</span>] <span style="color: #81A1C1;">=</span> a <span style="color: #81A1C1;">match</span> {
      <span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">Return</span>(<span style="font-weight: bold;">a</span>) <span style="color: #81A1C1;">=&gt;</span> f(a)
      <span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">Roll</span>(<span style="font-weight: bold;">a</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">F</span>.map(a)(<span style="color: #81A1C1;">_</span>.flatMap(f)))
    }
  }
</code></pre>
<p>
ä½ ä¼šå‘ç° <code>&gt;&gt;=</code> ä¼šé€’å½’çš„ <code>fmap</code> åˆ° <code>Roll</code> ä¸Š, ç›´åˆ°æœ€åä¸€ä¸ª <code>Return</code>.
</p>

<p>
æ¯”å¦‚, å¦‚æœä½ æœ‰ä¸€ä¸ª program æœ‰ä¸‰ç§å‰¯ä½œç”¨ Eff1, Eff2, Eff3
</p>

<pre class="code"><code><span style="color: #81A1C1;">data</span> <span style="color: #81A1C1;">Eff</span> a <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Eff1</span> a <span style="font-weight: bold;">|</span> <span style="color: #81A1C1;">Eff2</span> a <span style="font-weight: bold;">|</span> <span style="color: #81A1C1;">Eff3</span> a
<span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">do</span>
 a <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> 1
 b <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> 2
 c <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> 3
 return a <span style="font-weight: bold;">+</span> b <span style="font-weight: bold;">+</span> c
</code></pre>
<pre class="code"><code><span style="color: #81A1C1;">sealed</span> <span style="color: #81A1C1;">trait</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>] {
  <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">eff1</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Free</span>.liftF[<span style="color: #81A1C1;">Eff</span>, <span style="color: #81A1C1;">A</span>](<span style="color: #81A1C1;">Eff1</span>(a))
  <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">eff2</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Free</span>.liftF[<span style="color: #81A1C1;">Eff</span>, <span style="color: #81A1C1;">A</span>](<span style="color: #81A1C1;">Eff2</span>(a))
  <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">eff3</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Free</span>.liftF[<span style="color: #81A1C1;">Eff</span>, <span style="color: #81A1C1;">A</span>](<span style="color: #81A1C1;">Eff3</span>(a))
}
<span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">class</span> <span style="color: #81A1C1;">Eff1</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>) <span style="color: #81A1C1;">extends</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>]
<span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">class</span> <span style="color: #81A1C1;">Eff2</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>) <span style="color: #81A1C1;">extends</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>]
<span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">class</span> <span style="color: #81A1C1;">Eff3</span>[<span style="color: #81A1C1;">A</span>](a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span>) <span style="color: #81A1C1;">extends</span> <span style="color: #81A1C1;">Eff</span>[<span style="color: #81A1C1;">A</span>]

<span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">for</span> {
  a <span style="color: #81A1C1;">&lt;-</span> eff1(<span style="color: #81A1C1;">1</span>)
  b <span style="color: #81A1C1;">&lt;-</span> eff2(<span style="color: #81A1C1;">2</span>)
  c <span style="color: #81A1C1;">&lt;-</span> eff3(<span style="color: #81A1C1;">3</span>)
} <span style="color: #81A1C1;">yield</span> a + b + c
</code></pre>

<p>
å¦‚æœæˆ‘ä»¬æŠŠ program å±•å¼€, æ¯ä¸€æ­¥ <code>&gt;&gt;=</code> å¤§æ¦‚æ˜¯è¿™æ ·:
</p>

<pre class="code"><code>liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> 1
</code></pre>

<p>
å±•å¼€æ—¢æ˜¯:
</p>

<pre class="code"><code><span style="color: #81A1C1;">Roll</span> (<span style="color: #81A1C1;">Eff1</span> (<span style="color: #81A1C1;">Return</span> 1))
</code></pre>

<p>
ä»£å…¥åˆ° program å³:
</p>
<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> (<span style="color: #81A1C1;">Eff1</span> (<span style="color: #81A1C1;">Return</span> 1)) <span style="font-weight: bold;">&gt;&gt;=</span> <span style="font-weight: bold;">\</span>a <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">do</span>
   b <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> 2
   c <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> 3
   return a <span style="font-weight: bold;">+</span> b <span style="font-weight: bold;">+</span> c
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff1</span>(<span style="color: #81A1C1;">Return</span>(<span style="color: #81A1C1;">1</span>))).flatMap(a<span style="color: #81A1C1;">=&gt;</span>
  <span style="color: #81A1C1;">for</span> {
    b <span style="color: #81A1C1;">&lt;-</span> eff2(<span style="color: #81A1C1;">2</span>)
    c <span style="color: #81A1C1;">&lt;-</span> eff3(<span style="color: #81A1C1;">3</span>)
  } <span style="color: #81A1C1;">yield</span> a + b + c
)
</code></pre>
<p>
ç”¨ Free çš„ <code>&gt;&gt;=</code> å…¬å¼ <code>Roll ffa &gt;&gt;= fn = Roll $ fmap (&gt;&gt;= fn) ffa</code> å»å±•å¼€ä¸Šé¢å°±å¾—åˆ°:
</p>

<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> (<span style="color: #81A1C1;">Return</span> 1 <span style="font-weight: bold;">&gt;&gt;=</span> fn1)) <span style="color: #81A1C1;">where</span>
  fn1 <span style="font-weight: bold;">=</span> <span style="font-weight: bold;">\</span>a <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">do</span>
   b <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> 2
   c <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> 3
   return a <span style="font-weight: bold;">+</span> b <span style="font-weight: bold;">+</span> c
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">fn1</span> <span style="color: #81A1C1;">=</span> (a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Int</span>) <span style="color: #81A1C1;">=&gt;</span>
    <span style="color: #81A1C1;">for</span> {
      b <span style="color: #81A1C1;">&lt;-</span> eff2(<span style="color: #81A1C1;">2</span>)
      c <span style="color: #81A1C1;">&lt;-</span> eff3(<span style="color: #81A1C1;">3</span>)
    } <span style="color: #81A1C1;">yield</span> a + b + c

<span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff1</span>(<span style="color: #81A1C1;">Return</span>(<span style="color: #81A1C1;">1</span>).flatMap(fn1)))
</code></pre>
<p>
<code>Return 1 &gt;&gt;= fn1</code> æˆ‘ä»¬éƒ½çŸ¥é“æ€ä¹ˆå±•å¼€:
</p>

<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> (fn1 1) <span style="color: #81A1C1;">where</span>
  fn1 <span style="font-weight: bold;">=</span> <span style="font-weight: bold;">\</span>a <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">do</span>
   b <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> 2
   c <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> 3
   return a <span style="font-weight: bold;">+</span> b <span style="font-weight: bold;">+</span> c
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">fn1</span> <span style="color: #81A1C1;">=</span> (a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Int</span>) <span style="color: #81A1C1;">=&gt;</span>
    <span style="color: #81A1C1;">for</span> {
      b <span style="color: #81A1C1;">&lt;-</span> eff2(<span style="color: #81A1C1;">2</span>)
      c <span style="color: #81A1C1;">&lt;-</span> eff3(<span style="color: #81A1C1;">3</span>)
    } <span style="color: #81A1C1;">yield</span> a + b + c

<span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff1</span>(fn1(<span style="color: #81A1C1;">1</span>)))
</code></pre>

<p>
å±•å¼€ <code>fn1</code>
</p>

<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> <span style="color: #81A1C1;">do</span>
   b <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> 2
   c <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> 3
   return 1 <span style="font-weight: bold;">+</span> b <span style="font-weight: bold;">+</span> c
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff1</span>(<span style="color: #81A1C1;">for</span> {
      b <span style="color: #81A1C1;">&lt;-</span> eff2(<span style="color: #81A1C1;">2</span>)
      c <span style="color: #81A1C1;">&lt;-</span> eff3(<span style="color: #81A1C1;">3</span>)
    } <span style="color: #81A1C1;">yield</span> <span style="color: #81A1C1;">1</span> + b + c))
</code></pre>

<p>
åŒæ ·çš„æ­¥éª¤å±•å¼€ Eff2
</p>
<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> <span style="color: #81A1C1;">do</span>
   c <span style="font-weight: bold;">&lt;-</span> liftF <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> 3
   return 1 <span style="font-weight: bold;">+</span> 2 <span style="font-weight: bold;">+</span> c
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff1</span>(<span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff2</span>(<span style="color: #81A1C1;">for</span> {
      c <span style="color: #81A1C1;">&lt;-</span> eff3(<span style="color: #81A1C1;">3</span>)
    } <span style="color: #81A1C1;">yield</span> <span style="color: #81A1C1;">1</span> + <span style="color: #81A1C1;">2</span> + c))))
</code></pre>

<p>
å’Œ Eff3
</p>

<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> <span style="color: #81A1C1;">do</span>
   return 1 <span style="font-weight: bold;">+</span> 2 <span style="font-weight: bold;">+</span> 3
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff1</span>(<span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff2</span>(<span style="color: #81A1C1;">Roll</span>(<span style="color: #81A1C1;">Eff3</span>(<span style="color: #81A1C1;">Return</span>(<span style="color: #81A1C1;">1</span> + <span style="color: #81A1C1;">2</span> + <span style="color: #81A1C1;">3</span>)))))))
</code></pre>

<p>
æœ€åçš„ program æ˜¯ä¸æ˜¯å¾ˆåƒ List çš„ Cons å’Œ Nil å‘¢?
</p>

<pre class="code"><code><span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff1</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff2</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Roll</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Eff3</span> <span style="font-weight: bold;">$</span> <span style="color: #81A1C1;">Return</span> 1 <span style="font-weight: bold;">+</span> 2 <span style="font-weight: bold;">+</span> 3
</code></pre>


<p>
ä½†æ˜¯, ç»†å¿ƒçš„ä½ å¯èƒ½æ—©éƒ½å‘ç°äº† <code>Eff</code> è¿™è´§å¿…é¡»æ˜¯ä¸ª <code>Functor</code> æ‰è¡Œ. é‚£æˆ‘ä»¬å¦‚ä½•éšä¾¿å®šä¹‰ä¸€ä¸ª <code>data Eff</code> ç›´æ¥èƒ½ç”Ÿæˆ <code>Functor Eff</code> çš„å®ä¾‹å‘¢?
</p>
</div>
</div>

<div id="outline-container-org4526f48" class="outline-4">
<h4 id="org4526f48">Coyoneda</h4>
<div class="outline-text-4" id="text-org4526f48">
<p>
å¸Œæœ›ä½ è¿˜ä¾ç„¶è®°å¾—ç¬¬ä¸€éƒ¨åˆ†çš„ç±³ç”° <del>å…±</del> å¼•ç†
</p>

<pre class="code"><code><span style="color: #81A1C1;">data</span> <span style="color: #81A1C1;">CoYoneda</span> f a <span style="font-weight: bold;">=</span> forall b<span style="font-weight: bold;">.</span> <span style="color: #81A1C1;">CoYoneda</span> (b <span style="font-weight: bold;">-&gt;</span> a) (f b)
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">trait</span> <span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>] {
  <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">P</span>
  <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">fi</span><span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">P</span>]
  <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">ks</span><span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">P</span> <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">A</span>
}
<span style="color: #81A1C1;">object</span> <span style="color: #81A1C1;">CoYoneda</span>{
  <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">Aux</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">B</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>] { <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">P</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">B</span> }
  <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">apply</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">B</span>](f<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">B</span> <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">A</span>)(fa<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">B</span>])<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Aux</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">B</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">new</span> <span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>] {
    <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">P</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">B</span>
    <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">fi</span> <span style="color: #81A1C1;">=</span> fa
    <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">ks</span> <span style="color: #81A1C1;">=</span> f
  }
}
</code></pre>


<figure id="org20004e2">
<img src="images/p3-CoYoneda.png" alt="p3-CoYoneda.png">

</figure>

<p>
äº‹å®ä¸Šå¾ˆç®€å•å¯ä»¥æŠŠä»»ä½• <code>f</code> å˜æˆ <code>CoYoneda f</code>
</p>

<pre class="code"><code><span style="font-weight: bold;">phi</span> <span style="font-weight: bold;">::</span> f a <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">CoYoneda</span> f a
<span style="font-weight: bold;">phi</span> fa <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">CoYoneda</span> id fa
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">phi</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">A</span>](fa<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">A</span>])<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Aux</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> apply(identity)(fa)
</code></pre>


<figure id="org69bab44">
<img src="images/p3-CoYoneda-phi.png" alt="p3-CoYoneda-phi.png">

</figure>

<p>
è¯€çªå°±æ˜¯ <code>id</code>, ä¹Ÿå°±æ˜¯ä½ æŠŠ <code>b</code> å˜æˆ <code>a</code>, å†æŠŠ <code>fa</code> æ”¾åˆ° <code>CoYoneda</code> é‡Œå°±å¥½äº†
</p>

<p>
å½“ <code>f</code> æ˜¯ <code>Functor</code> æ—¶, åˆå¯ä»¥æŠŠ <code>CoYoneda</code> å˜æˆ <code>f</code>
</p>

<pre class="code"><code><span style="font-weight: bold;">psi</span> <span style="font-weight: bold;">::</span> <span style="color: #81A1C1;">Functor</span> f <span style="font-weight: bold;">=&gt;</span> <span style="color: #81A1C1;">CoYoneda</span> f a <span style="font-weight: bold;">-&gt;</span> f a
<span style="font-weight: bold;">psi</span> (<span style="color: #81A1C1;">CoYoneda</span> g fa) <span style="font-weight: bold;">=</span> fmap g fa
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">psi</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>]<span style="color: #81A1C1;">:</span><span style="color: #81A1C1;">Functor</span>, <span style="color: #81A1C1;">A</span>](fa<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>])<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Functor</span>[<span style="color: #81A1C1;">F</span>].map(fa.fi)(fa.ki)
</code></pre>


<figure id="org61b1328">
<img src="images/p3-CoYoneda-psi.png" alt="p3-CoYoneda-psi.png">

</figure>

<p>
åè¿‡æ¥çš„è¿™ä¸ªä¸é‡è¦, é‡è¦çš„æ˜¯ <code>phi</code>, å› ä¸ºå¦‚æœä½ å¯ä»¥æŠŠä»»ä½• <code>f</code> å˜æˆ <code>CoYoneda f</code>, è€Œ <code>CoYoneda f</code> åˆæ˜¯ <code>Functor</code>,
æˆ‘ä»¬ä¸å°±å…è´¹å¾—åˆ°ä¸€ä¸ª <code>Functor</code>?
</p>

<pre class="code"><code><span style="color: #81A1C1;">instance</span> <span style="color: #81A1C1;">Functor</span> (<span style="color: #81A1C1;">Coyoneda</span> f) <span style="color: #81A1C1;">where</span>
  fmap f (<span style="color: #81A1C1;">Coyoneda</span> g fb) <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Coyoneda</span> (f <span style="font-weight: bold;">.</span> g) fb
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">implicit</span> <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">freeFunctorForCoyoneda</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>]]<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Functor</span>[<span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">_</span>]] <span style="color: #81A1C1;">=</span>
  <span style="color: #81A1C1;">new</span> <span style="color: #81A1C1;">Functor</span>[<span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">_</span>]] {
    <span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">map</span>[<span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">B</span>, <span style="color: #81A1C1;">C</span>](cfa<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Aux</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>, <span style="color: #81A1C1;">C</span>])(f<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A</span> <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">B</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Aux</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">B</span>, <span style="color: #81A1C1;">C</span>] <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">new</span> <span style="color: #81A1C1;">CoYoneda</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">B</span>] {
      <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">P</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">C</span>
      <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">fi</span><span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">C</span>] <span style="color: #81A1C1;">=</span> cfa.fi
      <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">ki</span><span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">C</span> <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">B</span> <span style="color: #81A1C1;">=</span> f compose cfa.ki
    }
  }
</code></pre>
</div>
</div>
<div id="outline-container-org3872010" class="outline-4">
<h4 id="org3872010">Free Functor</h4>
<div class="outline-text-4" id="text-org3872010">
<p>
æ¯”å¦‚æˆ‘ä»¬çš„ <code>Eff</code> å°±å¯ä»¥ç›´æ¥é€šè¿‡ <code>phi</code> å˜æˆ <code>CoYoneda Eff</code>, ä»è€Œå¾—åˆ°å…è´¹çš„ Functor
</p>

<pre class="code"><code><span style="color: #81A1C1;">data</span> <span style="color: #81A1C1;">Eff</span> a <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Eff1</span> a <span style="font-weight: bold;">|</span> <span style="color: #81A1C1;">Eff2</span> a <span style="font-weight: bold;">|</span> <span style="color: #81A1C1;">Eff3</span> a
<span style="font-weight: bold;">program</span> <span style="font-weight: bold;">=</span> <span style="color: #81A1C1;">Roll</span> (phi (<span style="color: #81A1C1;">Eff1</span> (<span style="color: #81A1C1;">Roll</span> (phi (<span style="color: #81A1C1;">Eff2</span> (<span style="color: #81A1C1;">Return</span> <span style="color: #81A1C1;">Int</span>))))))
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Roll</span>(phi(<span style="color: #81A1C1;">Eff1</span>(<span style="color: #81A1C1;">Roll</span>((phi(<span style="color: #81A1C1;">Eff2</span>(<span style="color: #81A1C1;">Roll</span>(phi(<span style="color: #81A1C1;">Eff3</span>(<span style="color: #81A1C1;">Return</span>(<span style="color: #81A1C1;">1</span> + <span style="color: #81A1C1;">2</span> + <span style="color: #81A1C1;">3</span>)))))))))))
</code></pre>


<figure id="orga0ff091">
<img src="images/p3-Free.png" alt="p3-Free.png">

</figure>
</div>
</div>

<div id="outline-container-orgf41b63e" class="outline-4">
<h4 id="orgf41b63e">Interpreter</h4>
<div class="outline-text-4" id="text-orgf41b63e">
<p>
æ„é€ å®Œä¸€ä¸ª free program å,æˆ‘ä»¬å¾—åˆ°çš„æ˜¯ä¸€ä¸ªåµŒå¥—çš„æ•°æ®ç»“æ„, å½“æˆ‘ä»¬éœ€è¦ run è¿™ä¸ª program æ—¶, æˆ‘ä»¬éœ€è¦ foldMap ä¸€ä¸ª
Interpreter å»ä¸€å±‚å±‚æ‹¨å¼€ è¿™ä¸ª free program.
</p>

<pre class="code"><code><span style="font-weight: bold;">foldMap</span> <span style="font-weight: bold;">::</span> <span style="color: #81A1C1;">Monad</span> m <span style="font-weight: bold;">=&gt;</span> (<span style="color: #81A1C1;">forall</span> x <span style="font-weight: bold;">.</span> f x <span style="font-weight: bold;">-&gt;</span> m x) <span style="font-weight: bold;">-&gt;</span> <span style="color: #81A1C1;">Free</span> f a <span style="font-weight: bold;">-&gt;</span> m a
<span style="font-weight: bold;">foldMap</span> <span style="color: #81A1C1;">_</span> (<span style="color: #81A1C1;">Return</span> a)  <span style="font-weight: bold;">=</span> return a
<span style="font-weight: bold;">foldMap</span> f (<span style="color: #81A1C1;">Roll</span> a) <span style="font-weight: bold;">=</span> f a <span style="font-weight: bold;">&gt;&gt;=</span> foldMap f
</code></pre>

<pre class="code"><code><span style="color: #81A1C1;">def</span> <span style="font-weight: bold;">foldMap</span>[<span style="color: #81A1C1;">F</span>[<span style="color: #81A1C1;">_</span>], <span style="color: #81A1C1;">M</span>[<span style="color: #81A1C1;">_</span>]<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Monad</span>, <span style="color: #81A1C1;">A</span>](free<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Free</span>[<span style="color: #81A1C1;">F</span>, <span style="color: #81A1C1;">A</span>])(fk<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">F</span> ~&gt; <span style="color: #81A1C1;">M</span>)<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">M</span>[<span style="color: #81A1C1;">A</span>] <span style="color: #81A1C1;">=</span> free <span style="color: #81A1C1;">match</span> {
  <span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">Return</span>(<span style="font-weight: bold;">a</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">Monad</span>[<span style="color: #81A1C1;">M</span>].pure(a)
  <span style="color: #81A1C1;">case</span> <span style="color: #81A1C1;">Roll</span>(<span style="font-weight: bold;">a</span>) <span style="color: #81A1C1;">=&gt;</span> fk(a).flatMap(foldMap(<span style="color: #81A1C1;">_</span>)(fk))
}
</code></pre>
</div>
</div>
</div>
<div id="outline-container-orgdaccf82" class="outline-3">
<h3 id="orgdaccf82"><span class="todo TODO">TODO</span> Free Monoid</h3>
</div>
<div id="outline-container-org12cde21" class="outline-3">
<h3 id="org12cde21"><span class="todo TODO">TODO</span> Eff</h3>
</div>

<div id="outline-container-orgffa68b7" class="outline-3">
<h3 id="orgffa68b7"><span class="todo TODO">TODO</span> Comonad</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer>
  <p>Author: æ¬§é˜³ç»§è¶…
    <a class="github-button" href="https://github.com/sponsors/jcouyang" data-icon="octicon-heart" aria-label="Sponsor @jcouyang on GitHub">Sponsor</a>
    <a aria-label="Follow @jcouyang on GitHub" data-count-aria-label="# followers on GitHub" data-count-api="/users/jcouyang#followers" data-count-href="/jcouyang/followers" href="https://github.com/jcouyang" class="github-button">Follow</a>
    <a href="https://twitter.com/oyanglulu" class="twitter-follow-button" data-show-screen-name="false" data-show-count="false">Follow @oyanglulu</a>
  </p>
  <p>Created: 2018-07-28 Sat 00:00</p>
  <p>Generated by: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.1 (<a href="https://orgmode.org">Org</a> mode 9.5.3) &#215; <a href="https://github.com/jcouyang/orgpress">OrgPress</a></p>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.
  <input type="swiftype" class="st-default-search-input" placeholder="Search"/>
  <a class="gumroad-button" href="https://gum.co/grokking-monad?wanted=true" target="_blank" data-gumroad-single-product="true">èŒƒç•´è®ºè£…é€¼æŒ‡å—ï¼Œè¯·è‡ªè§‰æ’é˜Ÿè£…é€¼</a>
  <div id="danmaku-comments"></div>
  <div id="disqus_thread"></div>
</footer>
</div>
</body>
</html>
