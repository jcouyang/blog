<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2019-04-01 Mon 13:35 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>èŒƒç•´è®ºå®Œå…¨è£…é€¼æ‰‹å†Œ / Grokking Monad</title>
<meta name="generator" content="Org mode">
<meta name="author" content="æ¬§é˜³ç»§è¶…">
<meta name="description" content="å·ä¸‰ æåŸºçŒ«å‘¢"
>
<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/toc.css"/>
<link rel="stylesheet" href="/style/tufte.css"/>
<link rel="alternate" type="application/rss+xml" title="Jichao Ouyang" href="https://feeds.oyanglul.us/JichaoOuyangsBlog"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJRFJGX"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header>
    <a accesskey="h" href="/index.html"> HOME </a> |
    <a href="#" id="edit-in-github">EDIT</a> |
    <a href="https://feeds.oyanglul.us/JichaoOuyangsBlog">RSS</a> |
    <a accesskey="H" href="/jichao.ouyang.html">ABOUT</a> |
    <a href="https://github.com/jcouyang/blog">GITHUB</a>
</header>
</div>
<div id="content">
<header>
<h1 class="title">èŒƒç•´è®ºå®Œå…¨è£…é€¼æ‰‹å†Œ / Grokking Monad</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org701798e">ç¬¬ä¸‰éƒ¨åˆ†:<ruby>æåŸºçŒ«å‘¢<rt>Advanced Monads</rt></ruby></a>
<ul>
<li><a href="#orge038dcf">RWS</a></li>
<li><a href="#org1359962">Monad Transform</a>
<ul>
<li><a href="#org933b1fe">ReaderT</a></li>
</ul>
</li>
<li><a href="#org5b96e49">Alternative</a></li>
<li><a href="#org7aa39d2">MonadPlus</a></li>
<li><a href="#orgfb563d0">ST Monad</a></li>
<li><a href="#org120cadb">Free Monad</a>
<ul>
<li><a href="#orgf74c4ea">Free</a></li>
<li><a href="#org66ee4d6">Coyoneda</a></li>
<li><a href="#org3d94ff0">Free Functor</a></li>
<li><a href="#org67c3737">Interpreter</a></li>
</ul>
</li>
<li><a href="#orgf736452"><span class="todo TODO">TODO</span> Free Monoid</a></li>
<li><a href="#org93965d0"><span class="todo TODO">TODO</span> Eff</a></li>
<li><a href="#org6661053"><span class="todo TODO">TODO</span> Comonad</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li><a href="./part1.html">ç¬¬ä¸€éƒ¨åˆ†ï¼šçŒ«è®º</a></li>
<li><a href="./part2.html">ç¬¬äºŒéƒ¨åˆ†ï¼šé£Ÿç”¨çŒ«å‘¢</a></li>
<li><a href="./part3.html"><b>ç¬¬ä¸‰éƒ¨åˆ†ï¼šæåŸºçŒ«å‘¢</b></a> ğŸ‘ˆ</li>
</ul>

<div id="outline-container-org701798e" class="outline-2">
<h2 id="org701798e">ç¬¬ä¸‰éƒ¨åˆ†:<ruby>æåŸºçŒ«å‘¢<rt>Advanced Monads</rt></ruby></h2>
<div class="outline-text-2" id="text-org701798e">
<p>
ç¬¬äºŒéƒ¨åˆ†ä»‹ç»äº†ä¸€äº›å®ç”¨çš„monad instancesï¼Œè¿™äº› monad éƒ½é€šè¿‡åŒæ ·çš„æŠ½è±¡æ–¹å¼ï¼Œè§£å†³äº†åˆ†ç¦»è®¡ç®—ä¸å‰¯ä½œç”¨çš„å·¥ä½œã€‚
</p>

<p>
é€šè¿‡å®ƒä»¬å¯ä»¥è§£å†³å¤§å¤šæ•°çš„åŸºæœ¬é—®é¢˜ï¼Œä½†æ˜¯æ­£å¯¹äºå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦ä¸€äº›æ›´é«˜é˜¶çš„ monad æˆ–è€… patternã€‚
</p>

<p>
å½“æœ‰äº†ç¬¬ä¸€éƒ¨åˆ†çš„ç†è®ºåŸºç¡€å’Œç¬¬äºŒéƒ¨åˆ†çš„å®è·µï¼Œè¿™éƒ¨åˆ†è¦ä»‹ç»çš„çŒ«å‘¢å…¶å®å¹¶ä¸æ˜¯å¾ˆæåŸºã€‚é€šè¿‡è¿™ä¸€éƒ¨åˆ†ä»‹ç»çš„æåŸºçŒ«å‘¢ï¼Œ
æˆ‘ä»¬è¿˜å¯ä»¥åƒ IO monad ä¸€æ ·ï¼Œé€šè¿‡ free æˆ–è€… Eff è‡ªå®šä¹‰è‡ªå·±çš„è®¡ç®—ï¼Œå’Œå¯èƒ½å¸¦å‰¯ä½œç”¨çš„è§£é‡Šå™¨ã€‚
</p>
</div>

<div id="outline-container-orge038dcf" class="outline-3">
<h3 id="orge038dcf">RWS</h3>
<div class="outline-text-3" id="text-orge038dcf">
<p>
RWS æ˜¯ç¼©å†™ Reader Writer State monad, æ‰€ä»¥æ˜æ˜¾æ˜¯ä¸‰ä¸ªmonadçš„åˆä½“ã€‚å¦‚æœå·²ç»å¿˜è®° Reader Writer æˆ–è€… Stateï¼Œè¯·åˆ°ç¬¬äºŒéƒ¨åˆ†å¤ä¹ ä¸€ä¸‹ã€‚
</p>

<p>
ä¸€æ—¦æŠŠä¸‰ä¸ª monad åˆä½“ï¼Œæ„å‘³ç€å¯ä»¥åœ¨åŒä¸€ä¸ª monad ä½¿ç”¨ä¸‰ä¸ª monad çš„æ–¹æ³•ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ Reader çš„ ask, State çš„ get, put, å’Œ Writer çš„ tell
</p>

<pre class="code"><code><span style="color: #6a5acd;">readWriteState</span> <span style="color: #b8860b;">=</span> <span style="color: #00008b;">do</span>
  e <span style="color: #b8860b;">&lt;-</span> ask
  a <span style="color: #b8860b;">&lt;-</span> get
  <span style="color: #00008b;">let</span> res <span style="color: #b8860b;">=</span> a <span style="color: #b8860b;">+</span> e
  put res
  tell [res]
  return res
<span style="color: #6a5acd;">runRWS</span> readWriteState 1 2
<span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">(3 3 [3])</span>
</code></pre>

<p>
æ³¨æ„åˆ°è·Ÿ Reader å’Œ State ä¸€æ ·ï¼Œrunçš„æ—¶å€™è¾“å…¥åˆå§‹å€¼
</p>

<p>
å…¶ä¸­ 1 ä¸º Reader çš„å€¼ï¼Œ2 ä¸º State çš„åˆå§‹çŠ¶æ€.
</p>
</div>
</div>

<div id="outline-container-org1359962" class="outline-3">
<h3 id="org1359962">Monad Transform</h3>
<div class="outline-text-3" id="text-org1359962">
<p>
ä½ ä¼šå‘ç° RWS ä¸€èµ·ç”¨æŒºå¥½çš„ï¼Œèƒ½è¯»èƒ½å†™èƒ½æ‰“ logï¼Œä½†æ˜¯å·²ç»å›ºå®šå¥½æ­é…äº†ï¼Œåªèƒ½æ˜¯ RWS ï¼Œå¦‚æœæˆ‘è¿˜æƒ³åŠ å…¥å…¶å®ƒçš„ Monadï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ
</p>

<p>
è¿™æ—¶å€™ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯åŠ ä¸ª Tï¼Œæ¯”å¦‚å¯¹äº Readerï¼Œæˆ‘ä»¬æœ‰ ReaderTï¼ŒRWSï¼Œä¹Ÿæœ‰å¯¹åº”çš„ RWSTã€‚å…¶ä¸­ T ä»£è¡¨ Transformã€‚
</p>
</div>

<div id="outline-container-org933b1fe" class="outline-4">
<h4 id="org933b1fe">ReaderT</h4>
<div class="outline-text-4" id="text-org933b1fe">
<p>
è®©æˆ‘æ¥é€šè¿‡ç®€å•çš„ ReaderT æ¥è§£é‡Šåˆ°åº•ä»€ä¹ˆæ˜¯ T å§, é¦–å…ˆè·Ÿ Reader ä¸€æ ·æˆ‘ä»¬æœ‰ä¸ª runReaderT
</p>

<pre class="code"><code><span style="color: #00008b;">newtype</span> <span style="color: #36648b;">ReaderT</span> e m a <span style="color: #b8860b;">=</span> <span style="color: #36648b;">ReaderT</span> { runReaderT <span style="color: #b8860b;">::</span> e <span style="color: #b8860b;">-&gt;</span> m a }
</code></pre>

<p>
æ¯”è¾ƒä¸€ä¸‹ Reader çš„å®šä¹‰
</p>
<pre class="code"><code><span style="color: #00008b;">newtype</span> <span style="color: #36648b;">Reader</span> e a <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Reader</span> { runReader <span style="color: #b8860b;">::</span> (e <span style="color: #b8860b;">-&gt;</span> a) }
</code></pre>

<p>
æœ‰æ²¡æœ‰å‘ç°å¤šäº†ä¸€ä¸ª m, ä¹Ÿå°±æ˜¯è¯´, <code>runReader e</code> ä¼šè¿”å› a, ä½†æ˜¯ <code>runReaderT e</code> åˆ™ä¼šè¿”å› <code>m a</code>
</p>


<figure>
<img src="images/p3-ReaderT.png" alt="p3-ReaderT.png">

</figure>

<pre class="code"><code><span style="color: #00008b;">instance</span> (<span style="color: #36648b;">Monad</span> m) <span style="color: #b8860b;">=&gt;</span> <span style="color: #36648b;">Monad</span> (<span style="color: #36648b;">ReaderT</span> e m) <span style="color: #00008b;">where</span>
    return   <span style="color: #b8860b;">=</span> lift <span style="color: #b8860b;">.</span> return
    r <span style="color: #b8860b;">&gt;&gt;=</span> k  <span style="color: #b8860b;">=</span> <span style="color: #36648b;">ReaderT</span> <span style="color: #b8860b;">$</span> <span style="color: #b8860b;">\</span> e <span style="color: #b8860b;">-&gt;</span> <span style="color: #00008b;">do</span>
        a <span style="color: #b8860b;">&lt;-</span> runReaderT r e
        runReaderT (k a) e
</code></pre>

<p>
å†çœ‹çœ‹ monad çš„å®ç°, ä¹Ÿæ˜¯ä¸€æ ·çš„, å…ˆ run ä¸€ä¸‹ <code>r e</code> å¾—åˆ°ç»“æœ <code>a</code>, åº”ç”¨å‡½æ•° <code>k</code> åˆ° <code>a</code>, å† run ä¸€æŠŠ.
</p>


<p>
é—®é¢˜æ˜¯, è¿™é‡Œçš„ <code>return</code> é‡Œé¢çš„ <code>lift</code> æ˜¯å“ªæ¥çš„?
</p>

<pre class="code"><code><span style="color: #00008b;">instance</span> <span style="color: #36648b;">MonadTrans</span> (<span style="color: #36648b;">ReaderT</span> e) <span style="color: #00008b;">where</span>
  lift m <span style="color: #b8860b;">=</span> <span style="color: #36648b;">ReaderT</span> (const m)
</code></pre>


<figure>
<img src="images/p3-MonadTrans-ReaderT-e-m.png" alt="p3-MonadTrans-ReaderT-e-m.png">

</figure>

<p>
è¿™ä¸ªå‡½æ•° <code>lift</code> è¢«å®šä¹‰åœ¨ MonadTrans çš„å®ä¾‹ä¸­, ç®€å•çš„æŠŠ m æ”¾åˆ° ReaderT ç»“æœä¸­.
</p>

<p>
ä¾‹å¦‚, <code>lift (Just 1)</code> ä¼šå¾—åˆ° ReaderT, å…¶ä¸­ e éšæ„, m ä¸º Maybe Num
</p>

<p>
é‡ç‚¹éœ€è¦ä½“ä¼šçš„æ˜¯, Reader å¯ä»¥è¶Šè¿‡ Maybe ç›´æ¥æ“ä½œåˆ° Num, å®Œäº†å†åŒ…å›æ¥.
</p>

<p>
æœ‰äº† ReaderT, æ­é… Id Monad å°±å¾ˆå®¹æ˜“åˆ›å»ºå‡ºæ¥ Reader Monad
</p>

<pre class="code"><code><span style="color: #00008b;">type</span> <span style="color: #36648b;">Reader</span> r a<span style="color: #b8860b;">=</span> <span style="color: #36648b;">ReaderT</span> r <span style="color: #36648b;">Identity</span> a
</code></pre>

<p>
è¶Šè¿‡ Id read åˆ° Id å†…éƒ¨, å®Œäº†å†ç”¨ Id åŒ…å›æ¥, ä¸å°±æ˜¯ Reader äº†ä¹ˆ
</p>

<pre class="code"><code><span style="color: #36648b;">ReaderT</span> { runReaderT <span style="color: #b8860b;">::</span> r <span style="color: #b8860b;">-&gt;</span> <span style="color: #36648b;">Identity</span> a }
<span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">Identity a is a</span>
<span style="color: #36648b;">ReaderT</span> { runReaderT <span style="color: #b8860b;">::</span> r <span style="color: #b8860b;">-&gt;</span> a }
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org5b96e49" class="outline-3">
<h3 id="org5b96e49">Alternative</h3>
<div class="outline-text-3" id="text-org5b96e49">
<p>
è¿™ä¸ª typeclass æä¾› <code>&lt;|&gt;</code> å‡½æ•°, è¡¨ç¤ºè¦ä¹ˆè®¡ç®—å·¦è¾¹, è¦ä¹ˆè®¡ç®—å³è¾¹
</p>

<pre class="code"><code><span style="color: #00008b;">class</span> <span style="color: #36648b;">Applicative</span> f <span style="color: #b8860b;">=&gt;</span> <span style="color: #36648b;">Alternative</span> f <span style="color: #00008b;">where</span>
    empty <span style="color: #b8860b;">::</span> f a
    (<span style="color: #b8860b;">&lt;|&gt;</span>) <span style="color: #b8860b;">::</span> f a <span style="color: #b8860b;">-&gt;</span> f a <span style="color: #b8860b;">-&gt;</span> f a
</code></pre>


<figure>
<img src="images/p3-Alternative.png" alt="p3-Alternative.png">

</figure>

<p>
å…¶å®å°±æ˜¯ Applicative çš„ <code>æˆ–</code>
</p>

<p>
æ¯”å¦‚:
</p>
<pre class="code"><code><span style="color: #36648b;">Just</span> 1 <span style="color: #b8860b;">&lt;|&gt;</span> <span style="color: #36648b;">Just</span> 2 <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">Just 1</span>
<span style="color: #36648b;">Just</span> 1 <span style="color: #b8860b;">&lt;|&gt;</span> <span style="color: #36648b;">Nothing</span> <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">Just 1</span>
<span style="color: #36648b;">Nothing</span> <span style="color: #6a5acd;">&lt;|&gt;</span> <span style="color: #36648b;">Just</span> 1 <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">Just 1</span>
<span style="color: #36648b;">Nothing</span> <span style="color: #6a5acd;">&lt;|&gt;</span> <span style="color: #36648b;">Nothing</span> <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">Nothing</span>
</code></pre>
</div>
</div>

<div id="outline-container-org7aa39d2" class="outline-3">
<h3 id="org7aa39d2">MonadPlus</h3>
<div class="outline-text-3" id="text-org7aa39d2">
<p>
è¿™è·Ÿ Alternative æ˜¯ä¸€æ¯›ä¸€æ ·çš„, åªæ˜¯é™åˆ¶çš„æ›´ç»†, å¿…é¡»æ˜¯ Monadæ‰è¡Œ
</p>

<pre class="code"><code><span style="color: #00008b;">class</span> (<span style="color: #36648b;">Alternative</span> m, <span style="color: #36648b;">Monad</span> m) <span style="color: #b8860b;">=&gt;</span> <span style="color: #36648b;">MonadPlus</span> m <span style="color: #00008b;">where</span>
   mzero <span style="color: #b8860b;">::</span> m a
   mzero <span style="color: #b8860b;">=</span> empty
   mplus <span style="color: #b8860b;">::</span> m a <span style="color: #b8860b;">-&gt;</span> m a <span style="color: #b8860b;">-&gt;</span> m a
   mplus <span style="color: #b8860b;">=</span> (<span style="color: #b8860b;">&lt;|&gt;</span>)
</code></pre>

<p>
çœ‹, å®ç°ä¸­ç›´æ¥å°±è°ƒç”¨äº† Alternative çš„ <code>empty</code> å’Œ <code>&lt;|&gt;</code>
</p>
</div>
</div>

<div id="outline-container-orgfb563d0" class="outline-3">
<h3 id="orgfb563d0">ST Monad</h3>
<div class="outline-text-3" id="text-orgfb563d0">
<p>
ST Monad è·Ÿ State Monad çš„åŠŸèƒ½æœ‰äº›åƒ, ä¸è¿‡æ›´å‰å®³çš„æ˜¯, ä»–ä¸æ˜¯ immutable çš„, è€Œæ˜¯ "immutable" çš„åœ¨åŸåœ°åšä¿®æ”¹. æ”¹å®Œä¹‹å runST åˆç„¶ä»–å›åˆ°äº† immutable çš„ Haskell ä¸–ç•Œ.
</p>

<pre class="code"><code><span style="color: #6a5acd;">sumST</span> <span style="color: #b8860b;">::</span> <span style="color: #36648b;">Num</span> a <span style="color: #b8860b;">=&gt;</span> [a] <span style="color: #b8860b;">-&gt;</span> a
<span style="color: #6a5acd;">sumST</span> xs <span style="color: #b8860b;">=</span> runST <span style="color: #b8860b;">$</span> <span style="color: #00008b;">do</span>           <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">do &#21518;&#38754;&#30340;&#20107;&#24773;&#20250;&#26159;&#19981;&#38169;&#30340;&#20869;&#23384;&#25805;&#20316;, runST &#21487;&#20197;&#25226;&#23427;&#25289;&#20250;&#32431;&#30340;&#19990;&#30028;</span>
    n <span style="color: #b8860b;">&lt;-</span> newSTRef 0             <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">&#22312;&#20869;&#23384;&#20013;&#21019;&#24314;&#19968;&#22359;&#24182;&#25351;&#21040; STRef</span>
    forM_ xs <span style="color: #b8860b;">$</span> <span style="color: #b8860b;">\</span>x <span style="color: #b8860b;">-&gt;</span> <span style="color: #00008b;">do</span>         <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">&#36825;&#36319;&#21629;&#20196;&#24335;&#30340;for&#24490;&#29615;&#25913;&#20889;&#21464;&#37327;&#26159;&#19968;&#27611;&#19968;&#26679;&#30340;</span>
        modifySTRef n (<span style="color: #b8860b;">+</span>x)
    readSTRef n                 <span style="color: #8c8c8c; font-style: italic;">-- </span><span style="color: #8c8c8c; font-style: italic;">&#36820;&#22238;&#25913;&#23436;&#20043;&#21518;&#30340; n &#30340;&#20540;</span>
</code></pre>
</div>
</div>

<div id="outline-container-org120cadb" class="outline-3">
<h3 id="org120cadb">Free Monad</h3>
<div class="outline-text-3" id="text-org120cadb">
<p>
ä¸Šä¸€ç« è¯´è¿‡çš„ RWS Monad æ¯•ç«Ÿæ˜¯å›ºå®šæ­é…ï¼Œå½“ä½ çš„ä¸šåŠ¡éœ€è¦æ›´å¤šçš„ Monad æ¥è¡¨ç¤º Effect æ—¶ï¼Œ
æˆ‘ä»¬å°±éœ€è¦æœ‰é‚£ä¹ˆä¸ªå°çŒªæ‰‹å¸®æˆ‘ä»¬å®šä¹‰è‡ªå·±çš„ Monadã€‚
</p>

<p>
é‚£å°±æ˜¯ Free, Free å¯ä»¥å°†ä»»æ„ datatype lift æˆä¸º Monad
</p>
</div>

<div id="outline-container-orgf74c4ea" class="outline-4">
<h4 id="orgf74c4ea">Free</h4>
<div class="outline-text-4" id="text-orgf74c4ea">
<p>
å…ˆçœ‹ Free ä»€ä¹ˆå®šä¹‰:
</p>

<pre class="code"><code><span style="color: #00008b;">data</span> <span style="color: #36648b;">Free</span> f a <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> (f (<span style="color: #36648b;">Free</span> f a)) <span style="color: #b8860b;">|</span> <span style="color: #36648b;">Return</span> a
</code></pre>

<p>
å…¶ä¸­ <code>f</code> å°±æ˜¯ä½ ä¸šåŠ¡éœ€è¦çš„ effect ç±»å‹, <code>a</code> æ˜¯è¿™ä¸ª effect æ‰€äº§ç”Ÿçš„è¿”å›å€¼ç±»å‹ã€‚
</p>

<p>
å³è¾¹ä¸¤ç§æ„é€ å‡½æ•°ï¼Œå¦‚æœæŠŠ <code>Role</code> æ”¹æˆ <code>Cons</code>, <code>Return</code> æ”¹æˆ <code>Nil</code> çš„è¯, æ˜¯ä¸æ˜¯è·Ÿ List å…¶å®æ˜¯ <ruby>åŒæ„<rt>isomophic</rt></ruby> çš„å‘¢? æ‰€ä»¥å¦‚æœæƒ³è±¡æˆ List, é‚£ä¹ˆ <code>f</code> åœ¨è¿™é‡Œå°±ç›¸å½“äº List ä¸­çš„ä¸€ä¸ªå…ƒç´ .
</p>

<p>
åˆ°é‚£æ—¶, <code>&gt;&gt;=</code> çš„æ“ä½œåˆè·Ÿ List ç•¥æœ‰ä¸åŒ, æˆ‘ä»¬éƒ½çŸ¥é“ <code>&gt;&gt;=</code> ä¼šæŠŠæ¯ä¸€ä¸ªå…ƒç´  map æˆ List, ç„¶å flatten, ä½† Free å…¶å®æ˜¯ç”¨æ¥æ„å»º
é¡ºåºçš„ effect çš„, æ‰€ä»¥:
</p>

<pre class="code"><code><span style="color: #00008b;">instance</span> <span style="color: #36648b;">Functor</span> f <span style="color: #b8860b;">=&gt;</span> <span style="color: #36648b;">Monad</span> (<span style="color: #36648b;">Free</span> f) <span style="color: #00008b;">where</span>
  return a        <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Return</span> a
  <span style="color: #36648b;">Return</span> a <span style="color: #b8860b;">&gt;&gt;=</span> fn <span style="color: #b8860b;">=</span> fn a
  <span style="color: #36648b;">Roll</span> ffa <span style="color: #b8860b;">&gt;&gt;=</span> fn <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> fmap (<span style="color: #b8860b;">&gt;&gt;=</span> fn) ffa
</code></pre>

<p>
ä½ ä¼šå‘ç° <code>&gt;&gt;=</code> ä¼šé€’å½’çš„ <code>fmap</code> åˆ° <code>Roll</code> ä¸Š, ç›´åˆ°æœ€åä¸€ä¸ª <code>Return</code>.
</p>

<p>
æ¯”å¦‚, å¦‚æœä½ æœ‰ä¸€ä¸ª program æœ‰ä¸‰ç§å‰¯ä½œç”¨ Eff1, Eff2, Eff3
</p>

<pre class="code"><code><span style="color: #00008b;">data</span> <span style="color: #36648b;">Eff</span> a <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Eff1</span> a <span style="color: #b8860b;">|</span> <span style="color: #36648b;">Eff2</span> a <span style="color: #b8860b;">|</span> <span style="color: #36648b;">Eff3</span> a
<span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #00008b;">do</span>
 a <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> 1
 b <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> 2
 c <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> 3
 return a <span style="color: #b8860b;">+</span> b <span style="color: #b8860b;">+</span> c
</code></pre>

<p>
å¦‚æœæˆ‘ä»¬æŠŠ program å±•å¼€, æ¯ä¸€æ­¥ <code>&gt;&gt;=</code> å¤§æ¦‚æ˜¯è¿™æ ·:
</p>

<pre class="code"><code>liftF <span style="color: #6a5acd;">$</span> <span style="color: #36648b;">Eff1</span> 1
</code></pre>

<p>
å±•å¼€æ—¢æ˜¯:
</p>

<pre class="code"><code><span style="color: #36648b;">Roll</span> (<span style="color: #36648b;">Eff1</span> (<span style="color: #36648b;">Return</span> 1))
</code></pre>

<p>
ä»£å…¥åˆ° program å³:
</p>
<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> (<span style="color: #36648b;">Eff1</span> (<span style="color: #36648b;">Return</span> 1)) <span style="color: #b8860b;">&gt;&gt;=</span> <span style="color: #b8860b;">\</span>a <span style="color: #b8860b;">-&gt;</span> <span style="color: #00008b;">do</span>
   b <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> 2
   c <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> 3
   return a <span style="color: #b8860b;">+</span> b <span style="color: #b8860b;">+</span> c
</code></pre>

<p>
ç”¨ Free çš„ <code>&gt;&gt;=</code> å…¬å¼ <code>Roll ffa &gt;&gt;= fn = Roll $ fmap (&gt;&gt;= fn) ffa</code> å»å±•å¼€ä¸Šé¢å°±å¾—åˆ°:
</p>

<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> (<span style="color: #36648b;">Return</span> 1 <span style="color: #b8860b;">&gt;&gt;=</span> fn1)) <span style="color: #00008b;">where</span>
  fn1 <span style="color: #b8860b;">=</span> <span style="color: #b8860b;">\</span>a <span style="color: #b8860b;">-&gt;</span> <span style="color: #00008b;">do</span>
   b <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> 2
   c <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> 3
   return a <span style="color: #b8860b;">+</span> b <span style="color: #b8860b;">+</span> c
</code></pre>

<p>
<code>Return 1 &gt;&gt;= fn1</code> æˆ‘ä»¬éƒ½çŸ¥é“æ€ä¹ˆå±•å¼€:
</p>

<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> (fn1 1) <span style="color: #00008b;">where</span>
  fn1 <span style="color: #b8860b;">=</span> <span style="color: #b8860b;">\</span>a <span style="color: #b8860b;">-&gt;</span> <span style="color: #00008b;">do</span>
   b <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> 2
   c <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> 3
   return a <span style="color: #b8860b;">+</span> b <span style="color: #b8860b;">+</span> c
</code></pre>

<p>
å±•å¼€ <code>fn1</code>
</p>

<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> <span style="color: #00008b;">do</span>
   b <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> 2
   c <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> 3
   return 1 <span style="color: #b8860b;">+</span> b <span style="color: #b8860b;">+</span> c
</code></pre>


<p>
åŒæ ·çš„æ­¥éª¤å±•å¼€ Eff2
</p>
<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> <span style="color: #00008b;">do</span>
   c <span style="color: #b8860b;">&lt;-</span> liftF <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> 3
   return 1 <span style="color: #b8860b;">+</span> 2 <span style="color: #b8860b;">+</span> c
</code></pre>

<p>
å’Œ Eff3
</p>

<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> <span style="color: #00008b;">do</span>
   return 1 <span style="color: #b8860b;">+</span> 2 <span style="color: #b8860b;">+</span> 3
</code></pre>

<p>
æœ€åçš„ program æ˜¯ä¸æ˜¯å¾ˆåƒ List çš„ Cons å’Œ Nil å‘¢?
</p>

<pre class="code"><code><span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff1</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff2</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Roll</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Eff3</span> <span style="color: #b8860b;">$</span> <span style="color: #36648b;">Return</span> 1 <span style="color: #b8860b;">+</span> 2 <span style="color: #b8860b;">+</span> 3
</code></pre>


<p>
ä½†æ˜¯, ç»†å¿ƒçš„ä½ å¯èƒ½æ—©éƒ½å‘ç°äº† <code>Eff</code> è¿™è´§å¿…é¡»æ˜¯ä¸ª <code>Functor</code> æ‰è¡Œ. é‚£æˆ‘ä»¬å¦‚ä½•éšä¾¿å®šä¹‰ä¸€ä¸ª <code>data Eff</code> ç›´æ¥èƒ½ç”Ÿæˆ <code>Functor Eff</code> çš„å®ä¾‹å‘¢?
</p>
</div>
</div>

<div id="outline-container-org66ee4d6" class="outline-4">
<h4 id="org66ee4d6">Coyoneda</h4>
<div class="outline-text-4" id="text-org66ee4d6">
<p>
å¸Œæœ›ä½ è¿˜ä¾ç„¶è®°å¾—ç¬¬ä¸€éƒ¨åˆ†çš„ç±³ç”° <del>å…±</del> å¼•ç†
</p>

<pre class="code"><code><span style="color: #00008b;">data</span> <span style="color: #36648b;">CoYoneda</span> f a <span style="color: #b8860b;">=</span> forall b<span style="color: #b8860b;">.</span> <span style="color: #36648b;">CoYoneda</span> (b <span style="color: #b8860b;">-&gt;</span> a) (f b)
</code></pre>


<figure>
<img src="images/p3-CoYoneda.png" alt="p3-CoYoneda.png">

</figure>

<p>
äº‹å®ä¸Šå¾ˆç®€å•å¯ä»¥æŠŠä»»ä½• <code>f</code> å˜æˆ <code>CoYoneda f</code>
</p>

<pre class="code"><code><span style="color: #6a5acd;">phi</span> <span style="color: #b8860b;">::</span> f a <span style="color: #b8860b;">-&gt;</span> <span style="color: #36648b;">CoYoneda</span> f a
<span style="color: #6a5acd;">phi</span> fa <span style="color: #b8860b;">=</span> <span style="color: #36648b;">CoYoneda</span> id fa
</code></pre>


<figure>
<img src="images/p3-CoYoneda-phi.png" alt="p3-CoYoneda-phi.png">

</figure>

<p>
è¯€çªå°±æ˜¯ <code>id</code>, ä¹Ÿå°±æ˜¯ä½ æŠŠ <code>b</code> å˜æˆ <code>a</code>, å†æŠŠ <code>fa</code> æ”¾åˆ° <code>CoYoneda</code> é‡Œå°±å¥½äº†
</p>

<p>
å½“ <code>f</code> æ˜¯ <code>Functor</code> æ—¶, åˆå¯ä»¥æŠŠ <code>CoYoneda</code> å˜æˆ <code>f</code>
</p>

<pre class="code"><code><span style="color: #6a5acd;">psi</span> <span style="color: #b8860b;">::</span> <span style="color: #36648b;">Functor</span> f <span style="color: #b8860b;">=&gt;</span> <span style="color: #36648b;">CoYoneda</span> f a <span style="color: #b8860b;">-&gt;</span> f a
<span style="color: #6a5acd;">psi</span> (<span style="color: #36648b;">CoYoneda</span> g fa) <span style="color: #b8860b;">=</span> fmap g fa
</code></pre>


<figure>
<img src="images/p3-CoYoneda-psi.png" alt="p3-CoYoneda-psi.png">

</figure>

<p>
åè¿‡æ¥çš„è¿™ä¸ªä¸é‡è¦, é‡è¦çš„æ˜¯ <code>phi</code>, å› ä¸ºå¦‚æœä½ å¯ä»¥æŠŠä»»ä½• <code>f</code> å˜æˆ <code>CoYoneda f</code>, è€Œ <code>CoYoneda f</code> åˆæ˜¯ <code>Functor</code>,
æˆ‘ä»¬ä¸å°±å…è´¹å¾—åˆ°ä¸€ä¸ª <code>Functor</code>?
</p>

<pre class="code"><code><span style="color: #00008b;">instance</span> <span style="color: #36648b;">Functor</span> (<span style="color: #36648b;">Coyoneda</span> f) <span style="color: #00008b;">where</span>
  fmap f (<span style="color: #36648b;">Coyoneda</span> g fb) <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Coyoneda</span> (f <span style="color: #b8860b;">.</span> g) fb
</code></pre>
</div>
</div>

<div id="outline-container-org3d94ff0" class="outline-4">
<h4 id="org3d94ff0">Free Functor</h4>
<div class="outline-text-4" id="text-org3d94ff0">
<p>
æ¯”å¦‚æˆ‘ä»¬çš„ <code>Eff</code> å°±å¯ä»¥ç›´æ¥é€šè¿‡ <code>phi</code> å˜æˆ <code>CoYoneda Eff</code>, ä»è€Œå¾—åˆ°å…è´¹çš„ Functor
</p>

<pre class="code"><code><span style="color: #00008b;">data</span> <span style="color: #36648b;">Eff</span> a <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Eff1</span> a <span style="color: #b8860b;">|</span> <span style="color: #36648b;">Eff2</span> a <span style="color: #b8860b;">|</span> <span style="color: #36648b;">Eff3</span> a
<span style="color: #6a5acd;">program</span> <span style="color: #b8860b;">=</span> <span style="color: #36648b;">Roll</span> (phi (<span style="color: #36648b;">Eff1</span> (<span style="color: #36648b;">Roll</span> (phi (<span style="color: #36648b;">Eff2</span> (<span style="color: #36648b;">Return</span> <span style="color: #36648b;">Int</span>))))))
</code></pre>


<figure>
<img src="images/p3-Free.png" alt="p3-Free.png">

</figure>
</div>
</div>

<div id="outline-container-org67c3737" class="outline-4">
<h4 id="org67c3737">Interpreter</h4>
<div class="outline-text-4" id="text-org67c3737">
<p>
æ„é€ å®Œä¸€ä¸ª free program å,æˆ‘ä»¬å¾—åˆ°çš„æ˜¯ä¸€ä¸ªåµŒå¥—çš„æ•°æ®ç»“æ„, å½“æˆ‘ä»¬éœ€è¦ run è¿™ä¸ª program æ—¶, æˆ‘ä»¬éœ€è¦ foldMap ä¸€ä¸ª
Interpreter å»ä¸€å±‚å±‚æ‹¨å¼€ è¿™ä¸ª free program.
</p>

<pre class="code"><code><span style="color: #6a5acd;">foldMap</span> <span style="color: #b8860b;">::</span> <span style="color: #36648b;">Monad</span> m <span style="color: #b8860b;">=&gt;</span> (<span style="color: #00008b;">forall</span> x <span style="color: #b8860b;">.</span> f x <span style="color: #b8860b;">-&gt;</span> m x) <span style="color: #b8860b;">-&gt;</span> <span style="color: #36648b;">Free</span> f a <span style="color: #b8860b;">-&gt;</span> m a
<span style="color: #6a5acd;">foldMap</span> <span style="color: #00008b;">_</span> (<span style="color: #36648b;">Return</span> a)  <span style="color: #b8860b;">=</span> return a
<span style="color: #6a5acd;">foldMap</span> f (<span style="color: #36648b;">Roll</span> a) <span style="color: #b8860b;">=</span> f a <span style="color: #b8860b;">&gt;&gt;=</span> foldMap f
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgf736452" class="outline-3">
<h3 id="orgf736452"><span class="todo TODO">TODO</span> Free Monoid</h3>
</div>
<div id="outline-container-org93965d0" class="outline-3">
<h3 id="org93965d0"><span class="todo TODO">TODO</span> Eff</h3>
</div>

<div id="outline-container-org6661053" class="outline-3">
<h3 id="org6661053"><span class="todo TODO">TODO</span> Comonad</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer>
  <p>Author: æ¬§é˜³ç»§è¶… <a aria-label="Follow @jcouyang on GitHub" data-count-aria-label="# followers on GitHub" data-count-api="/users/jcouyang#followers" data-count-href="/jcouyang/followers" href="https://github.com/jcouyang" class="github-button">Follow @jcouyang</a></p>
  <p>Modified: 2019-04-01 Mon 13:35</p>
  <p>Generated by: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.2.2) &#215; <a href="https://github.com/jcouyang/orgpress">OrgPress</a></p>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.
  <input type="swiftype" class="st-default-search-input" placeholder="Search"/>
  <a class="gumroad-button" href="https://gum.co/grokking-monad?wanted=true" target="_blank" data-gumroad-single-product="true">èŒƒç•´è®ºè£…é€¼æŒ‡å—ï¼Œè¯·è‡ªè§‰æ’é˜Ÿè£…é€¼</a>
  <div id="danmaku-comments"></div>
  <div id="disqus_thread"></div>
</footer>
</div>
</body>
</html>
