<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-09-17 Sat 08:03 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Write your AWS DevOps tool in Haskell for Great Good</title>
<meta name="author" content="Jichao Ouyang" />
<meta name="description" content="Why I rewrite all DevOps tools in Haskell, and you should too!" />
<meta name="keywords" content="devops,haskell,amazonka,amazon aws,aws" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/toc.css"/>
<link rel="stylesheet" href="/style/tufte.css"/>
<link rel="stylesheet" href="/style/main.css"/>
<link rel="alternate" type="application/rss+xml" title="Jichao Ouyang" href="https://feeds.oyanglul.us/JichaoOuyangsBlog"/>
<meta property="og:title" content="Write your AWS DevOps tool in Haskell for Great Good!" />
<meta property="og:description" content="Why I rewrite all DevOps tools in Haskell, and you should too!" />
<meta property="og:type" content="article" />
</head>
<body>
<div id="preamble" class="status">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJRFJGX"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header>
    <a accesskey="h" href="/index.html"> HOME </a> |
    <a href="#" id="edit-in-github">EDIT</a> |
    <a href="https://feeds.oyanglul.us/JichaoOuyangsBlog">RSS</a> |
    <a href="https://blog.oyanglul.us/theindex">INDEX</a> |
    <a accesskey="H" href="/jichao.ouyang.html">ABOUT</a> |
    <a href="https://github.com/jcouyang/blog">GITHUB</a>
</header>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Write your AWS DevOps tool in Haskell for Great Good</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6076402">List files in one S3 bucket</a>
<ul>
<li><a href="#orgb9db3a9">AWS CLI </a></li>
<li><a href="#org38a914e">Haskell Amazonka</a></li>
<li><a href="#org25f98e2">Go SDK </a></li>
</ul>
</li>
<li><a href="#org66a4fd4">List <span class="underline">ALL FILES</span> in a bucket</a>
<ul>
<li><a href="#org9b8191a">AWS CLI</a></li>
<li><a href="#orgf625280">Haskell Amazonka</a></li>
<li><a href="#orgf612558">Go SDK </a></li>
</ul>
</li>
<li><a href="#orgd166ea9">Query a DynamoDB table</a>
<ul>
<li><a href="#orgf7f2eb7">AWS CLI</a></li>
<li><a href="#org955c581">Haskell Amazonka</a></li>
<li><a href="#org0dd49f0">Go SDK</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
Let's just simply compare AWS CLI, Haskell Amazonka, and official Go SDK with the following very simple tasks:
</p>

<div id="outline-container-org6076402" class="outline-2">
<h2 id="org6076402">List files in one S3 bucket</h2>
<div class="outline-text-2" id="text-org6076402">
</div>
<div id="outline-container-orgb9db3a9" class="outline-3">
<h3 id="orgb9db3a9">AWS CLI <label for="1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="1" class="margin-toggle"/><span class="sidenote">
<a href="https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html">https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html</a> 
</span></h3>
<div class="outline-text-3" id="text-orgb9db3a9">
<pre class="code"><code>aws s3 ls s3://mybucket --recursive --page-size 100
</code></pre>
</div>
</div>

<div id="outline-container-org38a914e" class="outline-3">
<h3 id="org38a914e">Haskell Amazonka<label for="2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="2" class="margin-toggle"/><span class="sidenote">
<a href="https://hackage.haskell.org/package/amazonka-s3-1.6.1/docs/Network-AWS-S3-ListObjects.htm">https://hackage.haskell.org/package/amazonka-s3-1.6.1/docs/Network-AWS-S3-ListObjects.htm</a> 
</span></h3>
<div class="outline-text-3" id="text-org38a914e">
<pre class="code"><code>send <span style="font-weight: bold;">$</span> listObjects <span style="color: #D08770;">"mybucket"</span> <span style="font-weight: bold;">&amp;</span> loMaxKeys <span style="font-weight: bold;">~?</span> 100
</code></pre>

<div class="epigraph"><blockquote>
<p>
Of course the Haskell code is pure and lazy, so <code>send</code> just returns a data that describes the command and produce no side effect, to actually exec the command
we can create a function <code>awsRun</code> to execute the command:
</p>

<pre class="code"><code><span style="font-weight: bold;">awsRun</span> <span style="font-weight: bold;">=</span> runResourceT <span style="font-weight: bold;">.</span> runAWS (newEnv <span style="color: #81A1C1;">Discover</span> <span style="font-weight: bold;">&amp;</span> envLogger <span style="font-weight: bold;">.~</span> newLogger <span style="color: #81A1C1;">Info</span> stdout) <span style="font-weight: bold;">.</span> within <span style="color: #81A1C1;">Sydney</span>
</code></pre>

<p>
It is similar to the step that Go SDK need to create a session first:
</p>
<pre class="code"><code><span style="color: #81A1C1;">sess</span> := session.Must(session.NewSession(&amp;aws.Config{
    Region: aws.String(endpoints.ApSoutheast2RegionID),
}))
</code></pre>

</blockquote></div>
</div>
</div>

<div id="outline-container-org25f98e2" class="outline-3">
<h3 id="org25f98e2">Go SDK <label for="3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="3" class="margin-toggle"/><span class="sidenote">
<a href="https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjects">https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjects</a> 
</span></h3>
<div class="outline-text-3" id="text-org25f98e2">
<pre class="code"><code><span style="color: #81A1C1;">svc</span> := s3.New(session.New())
input := &amp;s3.ListObjectsInput{
    Bucket:  aws.String(<span style="color: #D08770;">"mybucket"</span>),
    MaxKeys: aws.Int64(100),
}

result, err := svc.ListObjects(input)
<span style="color: #81A1C1;">if</span> err != nil {
 ...
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org66a4fd4" class="outline-2">
<h2 id="org66a4fd4">List <span class="underline">ALL FILES</span> in a bucket</h2>
<div class="outline-text-2" id="text-org66a4fd4">
<p>
This time we need all, not just one page of files, let's compare
</p>
</div>

<div id="outline-container-org9b8191a" class="outline-3">
<h3 id="org9b8191a">AWS CLI</h3>
<div class="outline-text-3" id="text-org9b8191a">
<p>
Can't really do it&#x2026;if there are more than 1000 files ü§∑‚Äç‚ôÇ
</p>
<div class="epigraph"><blockquote>
<p>
&#x2013;page-size (integer) The number of results to return in each response to a list operation. The default value is 1000 (the maximum allowed) <label for="4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="4" class="margin-toggle"/><span class="sidenote">
<a href="https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html#options">https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html#options</a> 
</span>
</p>

</blockquote></div>
</div>
</div>

<div id="outline-container-orgf625280" class="outline-3">
<h3 id="orgf625280">Haskell Amazonka</h3>
<div class="outline-text-3" id="text-orgf625280">
<pre class="code"><code>paginate <span style="font-weight: bold;">$</span> listObjects <span style="color: #D08770;">"mybucket"</span> <span style="font-weight: bold;">&amp;</span> loMaxKeys <span style="font-weight: bold;">~?</span> 100
</code></pre>

<p>
Simply replace <code>send</code> with <code>paginate</code>, amazonka will automatically <b><b>pull</b></b> objects into a Conduit<label for="5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="5" class="margin-toggle"/><span class="sidenote">
<a href="https://github.com/snoyberg/conduit">https://github.com/snoyberg/conduit</a> 
</span> stream, you can simply map over the stream, <code>.| takeC 3</code> to go over only first 3 pages, or even <code>.| sinkList</code> to load the very large list into memory.
</p>
</div>
</div>

<div id="outline-container-orgf612558" class="outline-3">
<h3 id="orgf612558">Go SDK <label for="6" class="margin-toggle sidenote-number"></label><input type="checkbox" id="6" class="margin-toggle"/><span class="sidenote">
<a href="https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjectsPagesWithContext">https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjectsPagesWithContext</a> 
</span></h3>
<div class="outline-text-3" id="text-orgf612558">
<pre class="code"><code><span style="color: #81A1C1;">objects</span> := []string{}
<span style="color: #81A1C1;">err</span> := svc.ListObjectsPagesWithContext(ctx, &amp;s3.ListObjectsInput{
    Bucket: aws.String(myBucket),
}, func(<span style="color: #81A1C1;">p</span> *<span style="font-weight: bold;">s3</span>.ListObjectsOutput, <span style="color: #81A1C1;">lastPage</span> <span style="font-weight: bold;">bool</span>) bool {
    <span style="color: #81A1C1;">for</span> _, o := range p.Contents {
        objects = append(objects, aws.StringValue(o.Key))
    }
    <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">true</span> <span style="color: #677691;">// </span><span style="color: #677691;">continue paging</span>
})
<span style="color: #81A1C1;">if</span> err != nil {
    panic(fmt.Sprintf(<span style="color: #D08770;">"failed to list objects for bucket, %s, %v"</span>, myBucket, err))
}

fmt.Println(<span style="color: #D08770;">"Objects in bucket:"</span>, objects)
</code></pre>

<p>
Go SDK uses callback function to go over pages, it is less efficient then stream and more verbose.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd166ea9" class="outline-2">
<h2 id="orgd166ea9">Query a DynamoDB table</h2>
<div class="outline-text-2" id="text-orgd166ea9">
</div>
<div id="outline-container-orgf7f2eb7" class="outline-3">
<h3 id="orgf7f2eb7">AWS CLI<label for="7" class="margin-toggle sidenote-number"></label><input type="checkbox" id="7" class="margin-toggle"/><span class="sidenote">
<a href="https://docs.aws.amazon.com/cli/latest/reference/dynamodb/query.html">https://docs.aws.amazon.com/cli/latest/reference/dynamodb/query.html</a> 
</span></h3>
<div class="outline-text-3" id="text-orgf7f2eb7">
<pre class="code"><code>aws dynamodb query <span style="color: #D08770;">\</span>
    --expression-attribute-values file://put-a-json-here <span style="color: #D08770;">\</span>
    --key-condition-expression <span style="color: #D08770;">"Artist = :v1"</span> <span style="color: #D08770;">\</span>
    --projection-expression <span style="color: #D08770;">"SongTitle"</span> <span style="color: #D08770;">\</span>
    --table-name Music
</code></pre>
</div>
</div>
<div id="outline-container-org955c581" class="outline-3">
<h3 id="org955c581">Haskell Amazonka</h3>
<div class="outline-text-3" id="text-org955c581">
<pre class="code"><code>send <span style="font-weight: bold;">$</span> query <span style="color: #D08770;">"Music"</span>
  <span style="font-weight: bold;">&amp;</span> qExpressionAttributeValues <span style="font-weight: bold;">.~</span> HashMap.singleton <span style="color: #D08770;">":v1"</span> (attributeValue <span style="font-weight: bold;">&amp;</span> avS <span style="font-weight: bold;">?~</span> <span style="color: #D08770;">"No One You Know"</span>)
  <span style="font-weight: bold;">&amp;</span> qKeyConditionExpression <span style="font-weight: bold;">?~</span> <span style="color: #D08770;">"Artist = :v1"</span>
  <span style="font-weight: bold;">&amp;</span> qProjectionExpression <span style="font-weight: bold;">?~</span> <span style="color: #D08770;">"SongTitle"</span>
</code></pre>
</div>
</div>
<div id="outline-container-org0dd49f0" class="outline-3">
<h3 id="org0dd49f0">Go SDK</h3>
<div class="outline-text-3" id="text-org0dd49f0">
<pre class="code"><code><span style="color: #81A1C1;">svc</span> := dynamodb.New(session.New())
input := &amp;dynamodb.QueryInput{
    ExpressionAttributeValues: map[string]*dynamodb.AttributeValue{
        <span style="color: #D08770;">":v1"</span>: {
            S: aws.String(<span style="color: #D08770;">"No One You Know"</span>),
        },
    },
    KeyConditionExpression: aws.String(<span style="color: #D08770;">"Artist = :v1"</span>),
    ProjectionExpression:   aws.String(<span style="color: #D08770;">"SongTitle"</span>),
    TableName:              aws.String(<span style="color: #D08770;">"Music"</span>),
}

result, err := svc.Query(input)
<span style="color: #81A1C1;">if</span> err != nil {
    ...
</code></pre>

<p>
You should get the idea by now.
</p>

<p>
I guess anyone even can't read Haskell at all can identify the Haskell version is basically the same as AWS CLI, with some simple syntax mapping you can instantly translate any AWS CLI command into Haskell code.
</p>
<ul class="org-ul">
<li><code>--</code> to <code>&amp;</code></li>
<li>kebab-case to CamelCase</li>
<li>connect option name and value with <code>.~</code> instead of space, or <code>?~</code> when the option is optional</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html">https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://hackage.haskell.org/package/amazonka-s3-1.6.1/docs/Network-AWS-S3-ListObjects.htm">https://hackage.haskell.org/package/amazonka-s3-1.6.1/docs/Network-AWS-S3-ListObjects.htm</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjects">https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjects</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html#options">https://docs.aws.amazon.com/cli/latest/reference/s3/ls.html#options</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://github.com/snoyberg/conduit">https://github.com/snoyberg/conduit</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjectsPagesWithContext">https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#S3.ListObjectsPagesWithContext</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7" role="doc-backlink">7</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.aws.amazon.com/cli/latest/reference/dynamodb/query.html">https://docs.aws.amazon.com/cli/latest/reference/dynamodb/query.html</a> 
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<footer>
  <p>Author: Jichao Ouyang
    <a class="github-button" href="https://github.com/sponsors/jcouyang" data-icon="octicon-heart" aria-label="Sponsor @jcouyang on GitHub">Sponsor</a>
    <a aria-label="Follow @jcouyang on GitHub" data-count-aria-label="# followers on GitHub" data-count-api="/users/jcouyang#followers" data-count-href="/jcouyang/followers" href="https://github.com/jcouyang" class="github-button">Follow</a>
    <a href="https://twitter.com/oyanglulu" class="twitter-follow-button" data-show-screen-name="false" data-show-count="false">Follow @oyanglulu</a>
  </p>
  <p>Created: 2021-08-15 Sun 00:00</p>
  <p>Generated by: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.1 (<a href="https://orgmode.org">Org</a> mode 9.5.3) &#215; <a href="https://github.com/jcouyang/orgpress">OrgPress</a></p>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.
  <input type="swiftype" class="st-default-search-input" placeholder="Search"/>
  <a class="gumroad-button" href="https://gum.co/grokking-monad?wanted=true" target="_blank" data-gumroad-single-product="true">ËåÉÁï¥ËÆ∫Ë£ÖÈÄºÊåáÂçóÔºåËØ∑Ëá™ËßâÊéíÈòüË£ÖÈÄº</a>
  <div id="danmaku-comments"></div>
  <div id="disqus_thread"></div>
</footer>
</div>
</body>
</html>
