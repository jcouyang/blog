<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2020-05-08 Fri 12:21 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Clojure é£æ ¼çš„ JavaScript å¹¶å‘ç¼–ç¨‹</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Jichao Ouyang">
<meta name="description" content="ç”¨åŸç”Ÿ javascript es6 å®ç°ç±»ä¼¼clojure core.async é£æ ¼çš„å¼‚æ­¥ä»»åŠ¡, æ‹œæ‹œ callback hell"
>
<meta name="keywords" content="javascript, es6, clojure, clojurescript, core.async, ecmascript6, golang, go, callback hell">
<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/toc.css"/>
<link rel="stylesheet" href="/style/tufte.css"/>
<link rel="alternate" type="application/rss+xml" title="Jichao Ouyang" href="https://feeds.oyanglul.us/JichaoOuyangsBlog"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJRFJGX"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header>
    <a accesskey="h" href="/index.html"> HOME </a> |
    <a href="#" id="edit-in-github">EDIT</a> |
    <a href="https://feeds.oyanglul.us/JichaoOuyangsBlog">RSS</a> |
    <a href="https://blog.oyanglul.us/theindex">INDEX</a> |
    <a accesskey="H" href="/jichao.ouyang.html">ABOUT</a> |
    <a href="https://github.com/jcouyang/blog">GITHUB</a>
</header>
</div>
<div id="content">
<header>
<h1 class="title">Clojure é£æ ¼çš„ JavaScript å¹¶å‘ç¼–ç¨‹</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0354ed6">TL;DR SLIDES</a></li>
<li><a href="#org33ce530">Communicating Sequential Processes</a>
<ul>
<li><a href="#orgb4190ee">ä»€ä¹ˆæ˜¯å¹¶å‘</a></li>
<li><a href="#orgc6478a0">å¼‚æ­¥ä¸å¤šçº¿ç¨‹</a></li>
<li><a href="#orgdfe6285">CSP</a>
<ul>
<li><a href="#orgd6ccfb5">Event loop</a></li>
<li><a href="#org6ee5424">CSP, Channel, Goroutines</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org979763b">CSP in JavaScript</a>
<ul>
<li><a href="#org65a7890">Generator</a></li>
<li><a href="#org6eed5d9">Goroutines in JavaScript</a></li>
<li><a href="#org55e1325">timeout</a></li>
<li><a href="#org982fca9">take &lt;!</a></li>
<li><a href="#org71a70b1">put &gt;!</a></li>
<li><a href="#org1ee7eb7">JavaScript ç‰ˆæœ¬ çš„ CSP</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
<a href="https://blog.oyanglul.us/shutting-down-gulugulu">ğŸ“£ ä¸è¦å†æ‰¾äº†, å¼¹å¹•åŠŸèƒ½å·²å…³é—­</a>
</p>
<ul class="org-ul">
<li><b><a href="./clojure-core.async-essence-in-native-javascript.html">JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - å¹¶å‘ç¼–ç¨‹</a></b></li>
<li><a href="./clojure-essence-in-javascript-transducer.html">JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Transducer</a></li>
<li><a href="./clojure-essence-in-javascript-trampoline.html">JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Trampoline</a></li>
<li><a href="./clojure-essence-in-javascript-macro.html">JavaScriptç©è½¬Clojureå¤§æ³•ä¹‹ - Macro (1)</a></li>
</ul>

<p>
åœ¨çœ‹åˆ°ç¬¬ä¸€è¡ŒJavaScriptä»£ç ä¹‹å‰ï¼Œæˆ‘è¦å•°å—¦ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦ç”¨ clojure core.async çš„å¼‚æ­¥é£æ ¼ã€‚
</p>
<div id="outline-container-org0354ed6" class="outline-2">
<h2 id="org0354ed6">TL;DR SLIDES</h2>
<div class="outline-text-2" id="text-org0354ed6">
<iframe src="https://git.io/js-csp" width="800" height="600" seamless="true"></iframe>
</div>
</div>

<div id="outline-container-org33ce530" class="outline-2">
<h2 id="org33ce530">Communicating Sequential Processes</h2>
<div class="outline-text-2" id="text-org33ce530">
<p>
é€šä¿¡é¡ºåºè¿›ç¨‹, æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­ç”¨äºä¸€ç§æè¿°å¹¶å‘ç³»ç»Ÿä¸­äº¤äº’çš„å½¢å¼è¯­è¨€, ç®€ç§°CSP, æ¥æºäºC.A.R Hoare 1978å¹´çš„è®ºæ–‡. 
æ²¡é”™äº†, Hoareå°±æ˜¯å‘æ˜ <del>è®©æˆ‘ä»¬ç®—æ³•è¯¾çº ç»“å¾—å¿«æŒ‚ç§‘çš„</del> å¿«æ’ç®—æ³•çš„é‚£ä½å¤§ç‰›. 
</p>

<p>
CSPæœ€è¿‘ç”±äºGoè¯­è¨€çš„å…´èµ·çªç„¶å¤æ´», <a href="http://talks.golang.org/2012/concurrency.slide#1">Go</a>å®ç°äº†CSPå¹¶å‘ç¼–ç¨‹, å¹¶ä¸”èµ·åå« <i>goroutines and channels</i>, ç”±äºå®åœ¨æ˜¯å¤ªå¥½ç”¨äº†, Clojure ä¹ŸåŠ å…¥äº†
CSPçš„é˜µè¥, å«åš Core.async.
</p>
</div>

<div id="outline-container-orgb4190ee" class="outline-3">
<h3 id="orgb4190ee">ä»€ä¹ˆæ˜¯å¹¶å‘</h3>
<div class="outline-text-3" id="text-orgb4190ee">
<p>
å¹¶å‘å¯èƒ½å¾ˆå®¹æ˜“å’Œå¹¶è¡Œæ··æ·†, ä½†æ˜¯ç»“åˆæˆ‘ä»¬è‡ªå·±æƒ³ä¸€æƒ³,è¿˜æ˜¯å¾ˆå®¹æ˜“åˆ†å¾—æ¸…çš„.
</p>


<figure>
<img src="./images/typing.gif" alt="typing.gif">

</figure>

<p>
å¦‚æœæˆ‘æ­£åœ¨ä¸Šç­å†™ä»£ç ,æƒ³åŠ ä¸ªç­ç„¶åå‘ä¸ªçŸ­ä¿¡ç»™è€å©†è¯´æ™šç‚¹å›, å‘å®Œä»¥åç»§ç»­æ•²ä»£ç . é‚£ä¹ˆå‘çŸ­ä¿¡å’Œæ•²ä»£ç ä¸¤ä¸ªä»»åŠ¡å°±æ˜¯ <b>å¹¶å‘</b>.
</p>

<p>
ä½†å¦‚æœæˆ‘è¿˜ç‰¹åˆ«å–œæ¬¢éŸ³ä¹, æ‰€ä»¥æˆ‘è¾¹å¬éŸ³ä¹è¾¹æ•²ä»£ç , é‚£ä¹ˆäº¤ä»£å—å’Œå¬éŸ³ä¹ä¸¤ä¸ªä»»åŠ¡å°±æ˜¯å¹¶è¡Œäº†.
</p>

<p>
æ‰€ä»¥è¯´, å¹¶è¡Œä¸å¹¶å‘çš„æœ€å¤§åŒºåˆ«å°±æ˜¯åè€…ä»»åŠ¡ä¹‹é—´æ˜¯äº’ç›¸é˜»å¡çš„, ä»»åŠ¡ä¸èƒ½åŒæ—¶è¿è¡Œ,å› æ­¤åœ¨æ‰§è¡Œä¸€ä¸ªä»»åŠ¡æ—¶å°±å¾—é˜»å¡å¦å¤–ä¸€ä¸ªä»»åŠ¡.
</p>
</div>
</div>

<div id="outline-container-orgc6478a0" class="outline-3">
<h3 id="orgc6478a0">å¼‚æ­¥ä¸å¤šçº¿ç¨‹</h3>
<div class="outline-text-3" id="text-orgc6478a0">
<p>
è¯´åˆ°å¹¶å‘, å¤§æ¦‚éƒ½ä¼šè”æƒ³åˆ°å¤šçº¿ç¨‹.
</p>

<p>
ç»§ç»­æ•²ä»£ç è¿™ä¸ªä¾‹å­, æˆ‘ç°åœ¨forkå‡ºæ¥ä¸€ä¸ªæ‰‹å‘çŸ­ä¿¡, ä½†æ˜¯æˆ‘è¿˜æ˜¯åªæœ‰ä¸€ä¸ªè„‘è¢‹, åœ¨å‘çŸ­ä¿¡çš„æ—¶å€™æˆ‘çš„è„‘å­è¿˜æ˜¯åªèƒ½é›†ä¸­åœ¨
å¦‚ä½•ç¼–åˆ¶ä¸€ä¸ªç†ç”±å‘è€å©†è¯·å‡, è€Œå¦å¤–ä¸¤åªæ‰‹åªèƒ½æ”¾åœ¨é”®ç›˜ä¸Šä»€ä¹ˆä¹Ÿæ”¹ä¸äº†, ç›´åˆ°çŸ­ä¿¡å‘å‡ºå», å†ç»§ç»­å†™ä»£ç .
</p>


<figure>
<img src="./images/octo-leela.gif" alt="octo-leela.gif">

</figure>

<p>
æ‰€ä»¥å¤šçº¿ç¨‹å¼€é”€è¿˜æ˜¯å¾ˆå¤§(æˆ‘å¾—å†é•¿ä¸€ä¸ªæ‰‹&#x2026;å®Œäº†è¿˜è¦ç¼©å›å»&#x2026;), è€Œä¸”å…¶ä»–ä¸¤åªæ‰‹å…¶å®æ˜¯é—²ç½®(é˜»å¡)ç€çš„.
</p>


<figure>
<img src="https://www.evernote.com/shard/s23/sh/a65f9743-792e-4f57-8108-ede856b3f464/725cdaf31754164ac80e82f1cbf6f5d6/deep/0/Csp.png" alt="Csp.png">

</figure>

<p>
å› æ­¤, å¦å¤–ä¸€ç§æ›´çœèµ„æºçš„å¤„ç†å¹¶å‘çš„æ–¹å¼å°±å‡ºç°äº†&#x2013;å¼‚æ­¥. å¯¹äº†, å°±æ˜¯æˆ‘ä»¬åœ¨jsé‡Œç»å¸¸å‘ajaxçš„é‚£ä¸ªå¼‚æ­¥.
</p>

<p>
æ¯”å¦‚æˆ‘è¿˜æ˜¯ä¸¤åªæ‰‹, æˆ‘å‘å®ŒçŸ­ä¿¡ç»§ç»­å°±æ•²ä»£ç äº†, è¿™æ—¶, è€å©†ç»™æˆ‘å›äº†ä¸€æ¡çŸ­ä¿¡, é‚£æˆ‘æ”¾ä¸‹æ‰‹ä¸­çš„æ´», æ‹¿èµ·æ‰‹æœºçœ‹çœ‹å±…ç„¶è¯´
åŒæ„, äºæ˜¯æ”¾ä¸‹æ‰‹æœºç»§ç»­æ•²ä»£ç äº†.
</p>

<p>
æ³¨æ„è¿™æ®µåŠ¨ä½œä¸ä¹‹å‰å¤šçº¿ç¨‹çš„åŒºåˆ«, å¤šçº¿ç¨‹çš„åœºæ™¯æ˜¯æˆ‘forkäº†ç¬¬ä¸‰åªæ‰‹, è€Œé‚£åªæ‰‹åœ¨æˆ‘æ•²ä»£ç æ˜¯ä¸€ç›´æ¡ç€æ‰‹æœº, ç­‰å¾…ç€è€å©†çš„å›å¤.
äºæ˜¯å¼‚æ­¥æ˜¯ä¸æ˜¯æ¯”å¤šçº¿ç¨‹çš„æƒ…å†µå°‘ç”¨äº†åªèƒ³è†Šè€Œä¸”åˆ©ç”¨ç‡æ›´é«˜å‘¢.
</p>
</div>
</div>

<div id="outline-container-orgdfe6285" class="outline-3">
<h3 id="orgdfe6285">CSP</h3>
<div class="outline-text-3" id="text-orgdfe6285">
<p>
é‚£ä¹ˆä½ å°±è¦é—®äº†, ä½ æ˜¯æ€ä¹ˆçŸ¥é“æ‰‹æœºå“çš„, è¿˜ä¸æ˜¯è¦å¼€ä¸€ä¸ªçº¿ç¨‹è®©è€³æœµç›‘å¬ç€. å¯¹çš„, ä½†æ˜¯å¼‚æ­¥åªéœ€è¦å¾ˆå°‘çš„æœ‰é™ä¸ªçº¿ç¨‹å°±å¥½äº†, æ¯”å¦‚æˆ‘æœ‰åä¸ªæ‰‹æœº
è¦å‘ç»™åä¸ªè€å©†, æˆ‘è¿˜æ˜¯ä¸¤ä¸ªçº¿ç¨‹, è€Œå¦‚æœæ˜¯å¤šçº¿ç¨‹çš„è¯æˆ‘è¦forkå‡ºæ¥ååªæ‰‹. JSçš„å¼‚æ­¥å°±æ˜¯è¿™ä¹ˆå¹²çš„, ä¸€ä¸ªä¸“é—¨
çš„ <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/EventLoop">event loop</a> ç”¨äºæŒ‚å„ç§éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡.
</p>
</div>

<div id="outline-container-orgd6ccfb5" class="outline-4">
<h4 id="orgd6ccfb5">Event loop</h4>
<div class="outline-text-4" id="text-orgd6ccfb5">
<p>
Event loop æ¨¡å¼éå¸¸ç®€å•, æµè§ˆå™¨è¿è¡Œjavascriptå°±æ˜¯ä» event loop é‡Œé¢å–ä»»åŠ¡, é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ¥æºä¸ºå‡½æ•°è°ƒç”¨æ ˆä¸äº‹ä»¶ç»‘å®š.æ¯”å¦‚
</p>
<ul class="org-ul">
<li>æ¯å†™ä¸€è¡Œ <code>f()</code>, å°±ä¼šåŠ åˆ°event loopçš„é˜Ÿåˆ—ä¸­, event loopè¿è¡Œè¯¥ä»»åŠ¡ç›´åˆ°è°ƒç”¨æ ˆ</li>
<li>æ¯å†™ä¸€æ¬¡æ‰§è¡Œåˆ° <code>setTimeout(somefunction,0)</code>, ä¼šç«‹é©¬å¾€é˜Ÿåˆ—åŠ å…¥ <code>somefunction</code> (å¦‚æœä¸æ˜¯0, åˆ™æ˜¯né•¿æ—¶é—´ååŠ å…¥é˜Ÿåˆ—)</li>
</ul>


<figure>
<img src="https://www.evernote.com/shard/s23/sh/609488c9-b816-425e-9031-f0a2b1ac72f8/a3b5af41e63435d2b3fef4bff653b790/deep/0/Csp.png" alt="Csp.png">

</figure>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">a</span>(){
  console.log(<span style="color: #8b0000;">'a'</span>);
}
<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">b</span>(){
  console.log(<span style="color: #8b0000;">'b'</span>);
}
<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">timeout</span>(){
  console.log(<span style="color: #8b0000;">'timeout'</span>);
}
setTimeout(timeout,0);
a();
b();
<span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">=&gt; "a"</span>
<span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">=&gt; "b"</span>
<span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">=&gt; "timeout"</span>
</pre>
</div>

<p>
æ‰€ä»¥è¿™æ ·ä¸€è¡Œä»£ç çš„æ¶ˆæ¯é˜Ÿåˆ—åº”è¯¥æ˜¯è¿™æ ·çš„(å¤„ç†é¡ºåºä»å·¦è‡³å³)
</p>

<p>
<del>-----------</del>-----<del>-----</del>---&#x2013;&#x2014;+
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">setTimeout</td>
<td class="org-left">a</td>
<td class="org-left">b</td>
<td class="org-left">timeout</td>
</tr>
</tbody>
</table>
<p>
<del>-----------</del>-----<del>-----</del>---&#x2013;&#x2014;+
</p>


<p>
ç°åœ¨æˆ‘ä»¬ç”¨JSçš„å¼‚æ­¥æ¨¡å‹æ¥å†å®ç°ä¸€ä¸‹å‰é¢çš„ä¾‹å­
</p>

<a class="jsbin-embed" href="https://jsbin.com/jobope/2/embed?js,console">JS Bin</a><script src="https://static.jsbin.com/js/embed.js"></script>

<p>
jsæŠŠåˆ¤æ–­è€å©†åŒä¸åŒæ„çš„å‡½æ•°æŒ‚åˆ°äº†event loopé˜Ÿåˆ—ä¸­, å°±ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä»»åŠ¡, å¦‚æœæœ‰çŸ­ä¿¡å›å¤çš„äº‹ä»¶è§¦å‘,é‚£ä¹ˆå°±æ‰§è¡Œè¿™ä¸ªå‡½æ•°,ä¹Ÿå°±æ˜¯çœ‹çœ‹çŸ­ä¿¡è€å©†åŒä¸åŒæ„.
</p>

<p>
ç”¨event loopè¿™ç§äº‹ä»¶å›è°ƒçš„å½¢å¼çœ‹èµ·æ¥è¿˜æŒºé«˜æ•ˆçš„, è€Œä¸”jsä¸€ç›´ä¹Ÿæ˜¯è¿™ä¹ˆç”¨çš„, ä½†æ˜¯å½“äº‹ä»¶å¤šäº†ä¹‹åå°±ä¼šå‡ºç° <i>Callback hell</i>,
ä¸ºä»€ä¹ˆè¯´æ˜¯ callback hell å‘¢, ä»”ç»†çœ‹çœ‹å‰é¢ä¾‹å­ä¸­
</p>


<figure>
<img src="https://seajones.co.uk/content/images/2014/12/callback-hell.png" alt="callback-hell.png">

</figure>

<p>
åªè¦æœ‰ä¸€ä¸ªå‡½æ•°å¼callback,é‚£ä¹ˆæ‰€æœ‰è°ƒç”¨ä»–çš„å‡½æ•°éƒ½è¦å˜æˆcallbackäº†
</p>

<p>
äºæ˜¯JSä¸–ç•Œåˆå‡ºç°äº† Promises, è€Œä¸”å¾ˆå¿«çº¢ç«äº†èµ·æ¥, å› ä¸ºä»–èƒ½å¹³é“ºå¼€è¿™äº›callbackå‡½æ•°. å…¶å®å°±æ˜¯æŠŠå‡½æ•°ä½“å†…çš„callbackæ”¾åˆ°äº† <code>then</code> é‡Œç„¶å <code>chain</code> èµ·æ¥.
</p>

<div class="epigraph"><blockquote>
<p>
ä½†æ˜¯callback hell å˜æˆäº†ä¸²è”çš„ callback hell, åŸæ¥æ˜¯ä¸€å¤§å¨,ç°åœ¨æ˜¯ä¸²èµ·æ¥çš„ä¸€å¤§å¨
</p>

</blockquote></div>

<p>
äºæ˜¯CSPåŠæ—¶è·‘å‡ºæ¥æŠŠå¤§å®¶ä»callback hellä¸­æ‹¯æ•‘å‡ºæ¥.
</p>
</div>
</div>

<div id="outline-container-org6ee5424" class="outline-4">
<h4 id="org6ee5424">CSP, Channel, Goroutines</h4>
<div class="outline-text-4" id="text-org6ee5424">
<p>
CSP çš„æ¦‚å¿µéå¸¸ç®€å•, æƒ³è±¡ä¸€ä¸‹ event loop
</p>

<ol class="org-ol">
<li>CSP æŠŠè¿™ä¸ªevent loopçš„æ¶ˆæ¯é˜Ÿåˆ—è½¬æ¢æˆä¸€ä¸ªæ•°æ®é˜Ÿåˆ—, æŠŠè¿™ä¸ªé˜Ÿåˆ—å«åš <i>channel</i></li>
<li>ä»»åŠ¡ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ•°æ®</li>
</ol>


<figure>
<img src="https://www.evernote.com/shard/s23/sh/8c5eadb4-678b-4aec-b7df-ca03ffc36da5/775db9fd0da008539b45b924d30c1c50/deep/0/Csp.png" alt="Csp.png">

</figure>

<p>
è¿™æ ·å°±æˆåŠŸçš„æŠŠä»»åŠ¡å’Œå¼‚æ­¥æ•°æ®æˆåŠŸä» callback hell åˆ†ç¦»å¼€æ¥.
</p>

<p>
ç­‰ç­‰, è¿˜æ˜¯åˆšæ‰å‘çŸ­ä¿¡çš„ä¾‹å­, æˆ‘ä»¬æ¥ç”¨CSPå®ç°ä¸€é
</p>

<div class="org-src-container">
<pre class="src src-clojure">(<span style="color: #00008b;">def</span> <span style="color: #b8860b;">working</span> (chan))
(<span style="color: #00008b;">def</span> <span style="color: #b8860b;">texting</span> (chan))

(<span style="color: #00008b;">defn</span> <span style="color: #6a5acd;">boss-yelling</span> []
  (go-loop [no 1]
    (&lt;! (timeout 1000))
    (&gt;! working (str <span style="color: #8b0000;">"bose say: work "</span> no))
    (<span style="color: #00008b;">recur</span> (+ no 1))))

<span id="coderef-wife" class="coderef-off">(<span style="color: #00008b;">defn</span> <span style="color: #6a5acd;">wife-texting</span> []</span>
  (go-loop []
    (&lt;! (timeout 4000))
    (&gt;! texting <span style="color: #8b0000;">"wife say: come home!"</span>)
    (<span style="color: #00008b;">recur</span>)))

<span id="coderef-reading" class="coderef-off">(<span style="color: #00008b;">defn</span> <span style="color: #6a5acd;">reading-text</span> []</span>
  (go-loop []
    (println (&lt;! texting) <span style="color: #8b0000;">"me: ignore"</span>)
    (<span style="color: #00008b;">recur</span>)))

(<span style="color: #00008b;">defn</span> <span style="color: #6a5acd;">work</span> []
  (go-loop []
    (println (&lt;! working) <span style="color: #8b0000;">" me: working"</span>)
    (<span style="color: #00008b;">recur</span>)))

(boss-yelling)
(wife-texting)
(work)
(reading-text)

</pre>
</div>
<a class="jsbin-embed" href="https://jsbin.com/muliva/2/embed?console">JS Bin</a><script src="https://static.jsbin.com/js/embed.js"></script>

<p>
ä¸æ‡‚clojureæ²¡æœ‰å…³ç³»,æˆ‘å¯ä»¥è§£é‡Š <del>æˆ‘ä¸å¬æˆ‘ä¸å¬æˆ‘ä¸å¬!</del> è€Œä¸”æˆ‘è¿˜ä¼šåœ¨åé¢ç”¨JSå®ç°ä¸€é
</p>
<ul class="org-ul">
<li>å¯ä»¥çœ‹å‡º boss yelling, wife texting, me working å’Œ reading text å››ä¸ªä»»åŠ¡æ˜¯ <b>å¹¶å‘</b> è¿›è¡Œçš„</li>
<li>æ‰€æœ‰ä»»åŠ¡éƒ½ç›¸äº’æ²¡æœ‰ä¾èµ–, å®Œå…¨æ²¡æœ‰callback, æ²¡æœ‰å“ªä¸ªä»»åŠ¡æ˜¯å¦ä¸€ä¸ªä»»åŠ¡çš„callback, ä»–ä»¬éƒ½åªä¾èµ–äº <code>working</code> å’Œ <code>texting</code> ä¸¤ä¸ªchannel</li>
<li>å…¶ä¸­çš„ <code>go-loop</code> ç¥å¥‡çš„åœ°æ–¹æ˜¯, å®ƒå¾ªç¯è·å–channelä¸­çš„æ•°æ®, å½“é˜Ÿåˆ—ç©ºæ—¶,å®ƒä¼š <del>é˜»å¡</del> parking, å› ä¸ºå¹¶æ²¡æœ‰é˜»å¡çº¿ç¨‹, è€Œæ˜¯ä¿å­˜å½“å‰çŠ¶æ€, ç»§ç»­å»è¯•å¦ä¸€ä¸ª <code>go</code> è¯­å¥.</li>
<li>æ‹¿ <code>work</code> æ¥è¯´, <code>(&lt;! texting)</code> å°±æ˜¯ä» channel texting ä¸­å–æ•°æ®, å¦‚æœtextingä¸ºç©º,åˆ™parking</li>
<li>è€Œå¯¹äºä»»åŠ¡ <code>wife-texting</code>, <code>(&gt;! texting "wife say: come home!")</code> æ˜¯å¾€ channel texting ä¸­åŠ æ•°æ®, å¦‚æœ channel å·²æ»¡, åˆ™ parking</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-org979763b" class="outline-2">
<h2 id="org979763b">CSP in JavaScript<label for="1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="1" class="margin-toggle"/><span class="sidenote">
é‡Œé¢çš„goçš„å®ç°æ¥è‡ª <a href="https://swannodette.github.io/2013/08/24/es6-generators-and-csp/">https://swannodette.github.io/2013/08/24/es6-generators-and-csp/</a>
</span></h2>
<div class="outline-text-2" id="text-org979763b">
<p>
ç…ç…æˆ‘ä»¬éƒ½è¦å®ç°å†™ä»€ä¹ˆ
</p>
<ul class="org-ul">
<li>goroutines</li>
<li>timeout</li>
<li>take (&lt;!)</li>
<li>put (&gt;!)</li>
</ul>
<p>
å½“ç„¶é¦–å…ˆè¦å®ç°æœ€é‡è¦çš„ goroutines, ä½†æ˜¯åœ¨è¿™ä¹‹å‰, è®©æˆ‘ä»¬çœ‹çœ‹JavaScriptä¸€ä¸ªç¢‰å ¡çš„æ–°feature &#x2013; <i>generator</i>
</p>
</div>

<div id="outline-container-org65a7890" class="outline-3">
<h3 id="org65a7890">Generator</h3>
<div class="outline-text-3" id="text-org65a7890">
<p>
<a href="https://blog.dev/javascript/essential-ecmascript6.html#sec-9">ES6 ç»ˆäºæ”¯æŒäº†Generator</a>, ç›®å‰Firefoxä¸Chromeéƒ½å·²ç»å®ç°.<label for="2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="2" class="margin-toggle"/><span class="sidenote">
Chromeæœ‰ä¸€ä¸ª feature toggle å¯ä»¥æ‰“å¼€éƒ¨åˆ† es6 åŠŸèƒ½.  æ‰“å¼€ <code>chrome://flags/#enable-javascript-harmony</code> è®¾ç½®ä¸º <code>true</code>
</span> Generatoråœ¨æ¯æ¬¡è¢«è°ƒç”¨æ—¶æ”¾å› <code>yield</code> çš„å€¼, å¹¶ä¿å­˜çŠ¶æ€, ä¸‹æ¬¡è°ƒç”¨æ—¶ç»§ç»­è¿è¡Œ. 
è¿™ç§åŠŸèƒ½å¬èµ·æ¥åˆšå¥½ç¬¦åˆä¸Šä¾‹ä¸­ç¥å¥‡çš„ parking çš„è¡Œä¸º, å› æ­¤å®Œå…¨å¯ä»¥ç”¨ generator æ¥å®ç° CSP.
</p>


<figure>
<img src="./images/bender-generator.gif" alt="bender-generator.gif">

</figure>
</div>
</div>


<div id="outline-container-org6eed5d9" class="outline-3">
<h3 id="org6eed5d9">Goroutines in JavaScript</h3>
<div class="outline-text-3" id="text-org6eed5d9">
<p>
goroutines å…¶å®å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœº, generatorä¸ºè¾“å…¥
</p>
<ul class="org-ul">
<li>ä¸€ä¸ªå‡½æ•°</li>
<li>ä»–å¯ä»¥æ¥å—ä¸€ä¸ª <a href="#coderef-generator" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-generator');" onmouseout="CodeHighlightOff(this, 'coderef-generator');">generator</a></li>
<li>å¦‚æœgeneratoræ²¡æœ‰ä¸‹ä¸€æ­¥,åˆ™ç»“æŸ</li>
<li>å¦‚æœè¯¥æ­¥çš„è¿”å›å€¼çŠ¶æ€ä¸º park, <a href="#coderef-parking" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-parking');" onmouseout="CodeHighlightOff(this, 'coderef-parking');">é‚£ä¹ˆå°±æ˜¯ä»€ä¹ˆä¹Ÿä¸åš, è¿‡ä¸€ä¼šå†æ¥è¿›å…¥çŠ¶æ€æœºå°è¯•</a></li>
<li>å¦‚æœä¸º continue, <a href="#coderef-continue" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-continue');" onmouseout="CodeHighlightOff(this, 'coderef-continue');">è¿™æ¥ç€generatorä¸‹ä¸€æ­¥, ç»§ç»­å¾ªç¯</a></li>
</ul>
<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">go_</span>(<span style="color: #b8860b;">machine</span>, <span style="color: #b8860b;">step</span>) {
  <span style="color: #00008b;">while</span>(!step.done) {
    <span style="color: #00008b;">var</span> <span style="color: #b8860b;">arr</span>   = step.value(),
        state = arr[0],
        value = arr[1];
    <span style="color: #00008b;">switch</span> (state) {
      <span style="color: #00008b;">case</span> <span style="color: #8b0000;">"park"</span>:
<span id="coderef-parking" class="coderef-off">        setTimeout(<span style="color: #00008b;">function</span>() { go_(machine, step); },0);</span>
        <span style="color: #00008b;">return</span>;
      <span style="color: #00008b;">case</span> <span style="color: #8b0000;">"continue"</span>:
<span id="coderef-continue" class="coderef-off">        step = machine.next(value);</span>
        <span style="color: #00008b;">break</span>;
    }
  }
}

<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">go</span>(<span style="color: #b8860b;">machine</span>) {
<span id="coderef-generator" class="coderef-off">  <span style="color: #00008b;">var</span> <span style="color: #b8860b;">gen</span> = machine();</span>
  go_(gen, gen.next());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org55e1325" class="outline-3">
<h3 id="org55e1325">timeout</h3>
<div class="outline-text-3" id="text-org55e1325">
<p>
ä¸€ä¸ªç±»ä¼¼äº thread sleep çš„åŠŸèƒ½, æƒ³è®©ä»»åŠ¡èƒ½ç­‰å¾…ä¸ªä¸€æ®µæ—¶é—´å†æ‰§è¡Œ,
åªéœ€è¦åœ¨ <code>go_</code> ä¸­åŠ å…¥ä¸€ä¸ª timeout çš„ <code>case</code> å°±å¥½äº†
</p>
<div class="org-src-container">
<pre class="src src-javascript">...
  <span style="color: #00008b;">case</span> <span style="color: #8b0000;">'timeout'</span>:
    setTimeout(<span style="color: #00008b;">function</span>(){ go_(machine, machine.next());}, value);
    <span style="color: #00008b;">return</span>;
...
</pre>
</div>
<p>
å¦‚æœçŠ¶æ€æ˜¯timeout, é‚£ä¹ˆç­‰å¾… <code>value</code> é‚£ä¹ˆé•¿çš„æ—¶é—´å†æ‰§è¡Œgeneratorä¸‹ä¸€æ­¥.
</p>

<p>
å¦å¤–è¿˜éœ€è¦ä¸€ä¸ªè¿”å› timeout channel çš„å‡½æ•°
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">timeout</span>(<span style="color: #b8860b;">interval</span>){
  <span style="color: #00008b;">var</span> <span style="color: #b8860b;">chan</span> = [interval];
  chan.name = <span style="color: #8b0000;">'timeout'</span>;
  <span style="color: #00008b;">return</span> chan;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org982fca9" class="outline-3">
<h3 id="org982fca9">take &lt;!</h3>
<div class="outline-text-3" id="text-org982fca9">
<p>
å½“ generator ä» channel ä¸­ take æ•°æ®æ—¶
</p>
<ul class="org-ul">
<li>å¦‚æœ channel ç©º, çŠ¶æ€å˜ä¸º park</li>
<li>å¦‚æœ channel éç©º, è·å¾—æ•°æ®, çŠ¶æ€æ”¹æˆ continue</li>
<li>å¦‚æœæ˜¯ timeout channel, çŠ¶æ€ç½®æˆ timeout</li>
</ul>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">take</span>(<span style="color: #b8860b;">chan</span>) {
  <span style="color: #00008b;">return</span> <span style="color: #00008b;">function</span>() {
    <span style="color: #00008b;">if</span>(chan.name === <span style="color: #8b0000;">'timeout'</span>){
      <span style="color: #00008b;">return</span> [<span style="color: #8b0000;">'timeout'</span>, chan.pop()];
    }<span style="color: #00008b;">else</span> <span style="color: #00008b;">if</span>(chan.length === 0) {
      <span style="color: #00008b;">return</span> [<span style="color: #8b0000;">"park"</span>, <span style="color: #6b8e23;">null</span>];
    } <span style="color: #00008b;">else</span> {
      <span style="color: #00008b;">var</span> <span style="color: #b8860b;">val</span> = chan.pop();
      <span style="color: #00008b;">return</span> [<span style="color: #8b0000;">"continue"</span>, val];
    }
  };
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org71a70b1" class="outline-3">
<h3 id="org71a70b1">put &gt;!</h3>
<div class="outline-text-3" id="text-org71a70b1">
<p>
å½“ generator å¾€ channel ä¸­ put æ•°æ®
</p>
<ul class="org-ul">
<li>å¦‚æœ channel ç©º, çŠ¶æ€å˜ä¸º continue, æ”¾å…¥æ•°æ®</li>
<li>å¦‚æœ channel éç©º, parking</li>
</ul>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">put</span>(<span style="color: #b8860b;">chan</span>, <span style="color: #b8860b;">val</span>) {
  <span style="color: #00008b;">return</span> <span style="color: #00008b;">function</span>() {
    <span style="color: #00008b;">if</span>(chan.length === 0) {
      chan.unshift(val);
      <span style="color: #00008b;">return</span> [<span style="color: #8b0000;">"continue"</span>, <span style="color: #6b8e23;">null</span>];
    } <span style="color: #00008b;">else</span> {
      <span style="color: #00008b;">return</span> [<span style="color: #8b0000;">"park"</span>, <span style="color: #6b8e23;">null</span>];
    }
  };
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1ee7eb7" class="outline-3">
<h3 id="org1ee7eb7">JavaScript ç‰ˆæœ¬ çš„ CSP</h3>
<div class="outline-text-3" id="text-org1ee7eb7">
<p>
ç°åœ¨å¯ä»¥åŸåŸæœ¬æœ¬çš„å°†ä¹‹å‰çš„clojureçš„ä¾‹å­ç¿»è¯‘æˆJavaScriptäº†
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">boss_yelling</span>(){
  go(<span style="color: #00008b;">function</span>*(){
    <span style="color: #00008b;">for</span>(<span style="color: #00008b;">var</span> <span style="color: #b8860b;">i</span>=0;;i++){
      <span style="color: #00008b;">yield</span> take(timeout(1000));
      <span style="color: #00008b;">yield</span> put(work, <span style="color: #8b0000;">"boss say: work "</span>+i);
    }
  });
}

<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">wife_texting</span>(){
  go(<span style="color: #00008b;">function</span>*(){
    <span style="color: #00008b;">for</span>(;;){
      <span style="color: #00008b;">yield</span> take(timeout(4000));
      <span style="color: #00008b;">yield</span> put(text, <span style="color: #8b0000;">"wife say: come home"</span>);
    }
  });
}

<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">working</span>(){
  go(<span style="color: #00008b;">function</span>*(){
    <span style="color: #00008b;">for</span>(;;){
      <span style="color: #00008b;">var</span> <span style="color: #b8860b;">task</span> = <span style="color: #00008b;">yield</span> take(work);
      console.log(task, <span style="color: #8b0000;">"me working"</span>);
    }
  });
}

<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">texting</span>(){
  go(<span style="color: #00008b;">function</span>*(){
    <span style="color: #00008b;">for</span>(;;){
      <span style="color: #00008b;">var</span> <span style="color: #b8860b;">read</span> = <span style="color: #00008b;">yield</span> take(text);
      console.log(read, <span style="color: #8b0000;">"me ignoring"</span>);
    }
  });
}
boss_yelling();
wife_texting();
working();
texting();
</pre>
</div>

<p>
å®Œæ•´ä»£ç 
</p>
<a class="jsbin-embed" href="https://jsbin.com/savepe/5/embed?js,console">JS Bin</a><script src="https://static.jsbin.com/js/embed.js"></script>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
é‡Œé¢çš„goçš„å®ç°æ¥è‡ª <a href="https://swannodette.github.io/2013/08/24/es6-generators-and-csp/">https://swannodette.github.io/2013/08/24/es6-generators-and-csp/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
Chromeæœ‰ä¸€ä¸ª feature toggle å¯ä»¥æ‰“å¼€éƒ¨åˆ† es6 åŠŸèƒ½.  æ‰“å¼€ <code>chrome://flags/#enable-javascript-harmony</code> è®¾ç½®ä¸º <code>true</code>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<footer>
  <p>Author: Jichao Ouyang
    <a class="github-button" href="https://github.com/sponsors/jcouyang" data-icon="octicon-heart" aria-label="Sponsor @jcouyang on GitHub">Sponsor</a>
    <a aria-label="Follow @jcouyang on GitHub" data-count-aria-label="# followers on GitHub" data-count-api="/users/jcouyang#followers" data-count-href="/jcouyang/followers" href="https://github.com/jcouyang" class="github-button">Follow</a>
  </p>
  <p>Created: 2015-04-28 Tue 00:00</p>
  <p>Generated by: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.3.6) &#215; <a href="https://github.com/jcouyang/orgpress">OrgPress</a></p>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.
  <input type="swiftype" class="st-default-search-input" placeholder="Search"/>
  <a class="gumroad-button" href="https://gum.co/grokking-monad?wanted=true" target="_blank" data-gumroad-single-product="true">èŒƒç•´è®ºè£…é€¼æŒ‡å—ï¼Œè¯·è‡ªè§‰æ’é˜Ÿè£…é€¼</a>
  <div id="danmaku-comments"></div>
  <div id="disqus_thread"></div>
</footer>
</div>
</body>
</html>
