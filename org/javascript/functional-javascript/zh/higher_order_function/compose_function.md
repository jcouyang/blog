# å‡½æ•°ç»„åˆ function composition

é€šè¿‡å‰é¢ä»‹ç»çš„é«˜é˜¶å‡½æ•°,  map, fold ä»¥åŠæŸ¯é‡ŒåŒ–, å…¶å®å·²ç»è§è¯†åˆ°ä»€ä¹ˆæ˜¯å‡½æ•°ç»„åˆäº†.
å¦‚ä¹‹å‰ä¾‹å­ä¸­çš„ map å°±æ˜¯ ç”± fold å‡½æ•°ä¸ reverse å‡½æ•°ç»„åˆå‡ºæ¥çš„.

è¿™å°±æ˜¯å‡½æ•°å¼çš„æ€æƒ³, ä¸æ–­åœ°ç”¨å·²æœ‰å‡½æ•°, æ¥ç»„åˆå‡ºæ–°çš„å‡½æ•°.

![](http://turner.faculty.swau.edu/mathematics/materialslibrary/images/composition.jpg)

å¦‚å›¾å°±æ˜¯å‡½æ•°ç»„åˆï¼Œæ¥è‡ª[Catgory Theory](https://en.wikipedia.org/wiki/Category_theory)ï¼ˆFuntor ä¹Ÿæ˜¯ä»è¿™æ¥çš„ï¼Œåé¢ä¼šè®²åˆ°ï¼‰, æ—¢ç„¶ä» Aåˆ°B æœ‰å¯¹åº”çš„æ˜ å°„fï¼ŒBåˆ° Cæœ‰å¯¹åº”çš„æ˜ å°„gï¼Œ é‚£ä¹ˆ`(g.f)(x)`ä¹Ÿå°±æ˜¯ `f` ä¸ `g`
çš„ç»„åˆ`g(f(x))`å°±æ˜¯ Aåˆ° C çš„æ˜ å°„ã€‚ä¸Šä¸€ç« å®ç°çš„ map å‡½æ•°å°±ç›¸å½“äº `reverse.fold`.

### compose

æˆ‘ä»¬å¯ä»¥ç”¨ Eweda éå¸¸æ–¹ä¾¿çš„ compose æ–¹æ³•æ¥ç»„åˆå‡½æ•°
```js
var gf = E.compose(f, g)
```

è¯´åˆ°äº†å‡½æ•°ç»„åˆ, æŸ¯é‡ŒåŒ–, æˆ‘æƒ³ç°åœ¨ç»ˆäºå¯ä»¥è§£é‡Šæ¸…æ¥šä¸ºä»€ä¹ˆåœ¨è¿™é‡Œé€‰ç”¨ Eweda/Ramda è€Œä¸æ˜¯ Underscore äº†.

ä¸¾è¿‡ä¾‹å­ğŸŒ° å¦‚æœæˆ‘ç°åœ¨æƒ³è¦ tasks åˆ—è¡¨ä¸­æ‰€æœ‰å±æ€§ä¸º` completed`ä¸º` true` çš„å…ƒç´ , å¹¶æŒ‰ç…§` id` æ’åº.

underscore é‡Œä¼šè¿™æ ·å†™:
```js
_(tasks)
    .chain()
    .filter( task => task.completed===true)
    .sortBy( task => task.id).value();
```

è¿™ç§æ–¹å¼æ€ä¹ˆçœ‹éƒ½ä¸æ˜¯å‡½æ•°å¼, è€Œæ˜¯ä»¥å¯¹è±¡/å®¹å™¨ä¸ºä¸­å¿ƒçš„ä¸²è”ï¼Œæœ‰äº›åƒ jquery å¯¹è±¡çš„é“¾å¼è°ƒç”¨,
æˆ–è€…æˆ‘ä»¬å¯ä»¥å†™çš„å‡½æ•°å¼ä¸€äº›, å¦‚
```js
_.sortBy(_.filter(tasks, task => task.completed===true), task => task.id)
```

æ©æ©, çœ‹èµ·æ¥ä¸é”™å˜›, ä½†æ˜¯æœ‰è°æ˜¯è¿™ä¹ˆç”¨ underscoreçš„å‘¢. ä¸€èˆ¬éƒ½ä¼šåªè§è¿‡
é“¾å¼è°ƒç”¨æ‰æ˜¯ underscore çš„æ ‡å‡†å†™æ³•ã€‚

æ¥å¯¹æ¯”ä¸€ä¸‹ç”¨ Eweda/Ramda è§£å†³çš„è¿‡ç¨‹ :
```js
compose(sortBy(task=>task.id), filter(task=>task.completed===true))(tasks)
```
å¥½åƒæ²¡ä»€ä¹ˆåŒºåˆ«å•Š? ä¸å°±æ˜¯ç”¨äº† compose å—?

åŒºåˆ«å¤§äº†è¿™, çœ‹è§` tasks` æ˜¯æœ€åå½“å‚æ•°ä¼ ç»™`E.compose()`çš„å—? è€Œä¸æ˜¯å†™æ­»åœ¨filter çš„å‚æ•°ä¸­. è¿™æ„å‘³ç€åœ¨æ¥åˆ°éœ€è¦å¤„ç†çš„æ•°æ®å‰, æˆ‘å·²ç»ç»„åˆå¥½ä¸€ä¸ªæ–°çš„å‡½æ•°åœ¨ç­‰å¾…æ•°æ®, è€Œä¸æ˜¯æŠŠæ•°æ®æ··æ‚åœ¨ä¸­é—´, æˆ–æ˜¯ä¿æŒåœ¨ä¸€ä¸ªä¸­é—´å¯¹è±¡ä¸­. è€Œ underscore çš„å†™æ³•å¯¼è‡´è¿™ä¸€é•¿ä¸²`_.sortBy(_.filter())`å…¶å®æ ¹æœ¬æ— æ³•é‡ç”¨ã€‚

å¥½å§å¦‚æœä½ è¿˜çœ‹ä¸å‡ºæ¥è¿™æ ·åšçš„å¥½å¤„. é‚£ä¹ˆæ¥å¦‚æœæˆ‘æœ‰ä¸€ä¸ªåŒ…å«å‡ ç»„ tasksçš„åˆ—è¡¨ groupedTasks, æˆ‘è¦æŒ‰ç±»å‹é€‰å‡º completed ä¸º true å¹¶æŒ‰ id æ’åº. å¦‚æˆ‘ç°åœ¨æ•°æ®æ˜¯è¿™ä¸ªï¼š
```json
groupedTasks = [
  [{completed:false, id:1},{completed:true, id:2}],
  [{completed:false, id:4},{completed:true, id:3}]
]
```

underscore:
```js
_.map(groupedTasks,
   tasks => _.sortBy(_.filter(tasks, task => task.completed===true), task => task.id))

```
çœ‹è§æˆ‘ä»¬åˆæŠŠ`_.sortBy(_.filter())`è¿™ä¸€é•¿ä¸²åŸå°ä¸åŠ¨çš„æ‹·è´åˆ°äº† map é‡Œã€‚
å› ä¸ºunderscore ä¸€å¼€å§‹å°±è¦æ¶ˆè´¹æ•°æ®ï¼Œä½¿å¾—å¾ˆéš¾é‡ç”¨ï¼Œé™¤éåœ¨å¥—åœ¨å¦ä¸€ä¸ªå‡½æ•°é‡Œï¼š
```js
function completedAndSorted(tasks){
  return _.sortBy(_.filter(tasks, task => task.completed===true), task => task.id))
}
_.map(groupedTasks, completedAndSorted)
```
åªæœ‰è¿™æ ·æ‰èƒ½é‡ç”¨å·²æœ‰çš„ä¸€äº›å‡½æ•°ã€‚æˆ–è€…è™½ç„¶ underscore ä¹Ÿæœ‰`_.compose` æ–¹æ³•ï¼Œä½†æ˜¯
å‡ ä¹æ‰€æœ‰ underscore çš„æ–¹æ³•éƒ½æ˜¯å…ˆæ¶ˆè´¹æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ•°æ®ï¼‰ï¼Œä½¿å¾—å¾ˆéš¾æ”¾åˆ°
`compose` æ–¹æ³•ä¸­ï¼Œä¸ä¿¡å¯ä»¥å°è¯•æŠŠ filter å’Œ sortBy æè¿›å»ï¼Œåæ­£æˆ‘æ˜¯åšä¸åˆ°ã€‚

æ¥çœ‹çœ‹çœŸæ­£çš„å‡½æ•°ç»„åˆ
```js
var completedAndSorted = compose(sortBy(task=>task.id),
                                 filter(task=>task.completed===true))
map(completedAndSorted, groupedTasks)
```
çœ‹å‡ºæ¥æ€æƒ³å®Œå…¨ä¸ä¸€æ ·äº†å§.

ç”±äº Eweda/Ramda çš„å‡½æ•°éƒ½æ˜¯è‡ªåŠ¨æŸ¯é‡ŒåŒ–,è€Œä¸”æ•°æ®æ€»æ˜¯æœ€åä¸€ä¸ªå‚æ•°, å› æ­¤å¯ä»¥éšæ„ç»„åˆ, æœ€ç»ˆå°†éœ€è¦å¤„ç†çš„æ•°æ®æ‰”ç»™ç»„åˆå¥½çš„å‡½æ•°å°±å¥½äº†. è¿™æ‰æ˜¯å‡½æ•°å¼çš„æ€æƒ³. å…ˆå†™å¥½ä¸€ä¸ªå…¬å¼ï¼Œåœ¨æŠŠæ•°æ®æ‰”ç»™
å…¬å¼ã€‚è€Œä¸æ˜¯ç®—å¥½ä¸€éƒ¨åˆ†å†æŠŠç»“æœç»™å¦ä¸€ä¸ªå…¬å¼ã€‚

![](http://www.moebiusnoodles.com/s/wp-content/uploads/2012/09/ThreeFunctionMachines.jpg)

è€Œ underscore è¦ä¹ˆæ˜¯ä»¥å¯¹è±¡ä¿æŒä¸­é—´æ•°æ®, ç”¨ chaining çš„æ–¹å¼å¯¹ç›®æ ‡åº”ç”¨å„ç§å‡½æ•°ï¼ˆä¹¦ä¸Šä¼šå†™è¿™æ˜¯Flow-Base programmingï¼Œä½†æˆ‘è§‰å¾—å…¶å®æ˜¯ Monadï¼Œä¼šåœ¨ä¸‹ä¸€ç« ä¸­ä»‹ç»ï¼‰, è¦ä¹ˆç”¨å‡½æ•°åµŒå¥—å‡½æ•°, å°†ç›®æ ‡ä¸€å±‚å±‚ä¼ é€’ä¸‹å».

###pipe

ç±»ä¼¼ compose, eweda/ramda è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•å« pipe, pipe çš„å‡½æ•°æ‰§è¡Œæ–¹å‘åˆšå¥½ä¸ compose ç›¸å. æ¯”å¦‚ `pipe(f, g)`, `f`ä¼šå…ˆæ‰§è¡Œ, ç„¶åç»“æœä¼ ç»™` g`, æ˜¯ä¸æ˜¯è®©ä½ æƒ³èµ·äº† bash çš„ pipe
```
find / | grep porno
```
å®é™…ä¸Šå°±æ˜¯`pipe(find, grep(porno))(/)`

æ²¡é”™,ä»–ä»¬éƒ½æ˜¯ä¸€ä¸ªæ„æ€. è€Œä¸”è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ–¹å‘æ›´é€‚åˆäººè„‘ç¼–è¯‘(å¯è¯»)ä¸€äº›.

å¦‚æœä½ å·²ç»ä¹ æƒ¯ underscore çš„è¿™ç§å†™æ³•
```js
_(data)
  .chain()
  .map(data1,fn1)
  .filter(data2, fn2)
  .value()
```
é‚£ä¹ˆè½¬æ¢æˆ pipe æ˜¯å¾ˆå®¹æ˜“çš„ä¸€ä»¶äº‹æƒ…ï¼Œè€Œä¸”æ›´ç®€å•æ˜äº†æ˜“äºé‡ç”¨å’Œç»„åˆã€‚
```js
pipe(
  map(fn1),
  filter(fn2)
)(data)
```

[å®Œæ•´ä»£ç ](http://jsbin.com/hivaje/1/edit?js)
