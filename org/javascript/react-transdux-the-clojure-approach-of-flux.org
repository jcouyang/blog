#+TITLE: çœ‹æˆ‘ä»¬3å¤© hackday éƒ½å¹²äº†äº›ä»€ä¹ˆ
#+author: æ¬§é˜³ç»§è¶…
#+LANGUAGE: zh-CN
#+date:<2015-11-22 Sun>
#+keywords: hackday, clojure,clojurescript,javascript,react,flux,redux,transdux

 å¥½ä¸å®¹æ˜“æœ‰3å¤©å±äº hacker çš„æ—¥å­ï¼Œ ä» idea åˆ°äº§å“ï¼Œæˆ‘ä»¬åˆ°åº•èƒ½åšäº›ä»€ä¹ˆï¼Ÿä» *ç—›ç‚¹* å‡ºå‘ï¼Œæœ€è¿‘çš„é¡¹ç›®è¢« React å’Œ React Router è™çš„ä¸ç®—è½»ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå› ä¸ºæˆ‘ä»¬æ˜¯åŠè·¯æ¥æ‰‹çš„ã€‚çœŸçš„ç®—æ˜¯å‰äºº +ç“¦ğŸ––è‚¯+ åäºº +æ¤æ ‘+ æ“¦å±è‚¡ã€‚

#+BEGIN_QUOTE
  åˆ°åº•å¹²äº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ ä¸“ä¸šå‰§é€ ğŸ¶ 30å¹´æç¤ºæ‚¨è¯·çœ‹ url ğŸ‘†ï¸ å¹¶ç‚¹è¿™é‡Œ ğŸ‘‰ [[https://github.com/jcouyang/transdux]]
#+END_QUOTE
* COMMENT require
#+BEGIN_SRC emacs-lisp
(require 'ob-dot)
#+END_SRC

#+RESULTS:
: ob-dot

* Rationale

é‰´äºå¤§éƒ¨åˆ† React åˆå­¦è€…éƒ½å›°æƒ‘çš„é—®é¢˜ï¼Œæˆ‘åœ¨[[http://blog.oyanglul.us/javascript/react-cookbook-mini.html#orgheadline39][æµ“ç¼© React ç…®ä¹¦]]ä¸­ä¹Ÿè®²è¿‡

#+BEGIN_QUOTE
å¦‚æœä¸¤ä¸ª Component ä¸æ˜¯çˆ¶å­å…³ç³»æˆ–è€…å…„å¼Ÿæˆ–è€…ä¼¯çˆ¶ä¾„å¥³ï¼Œè¯¥å¦‚ä½•äº¤äº’
#+END_QUOTE

æˆ‘å½“æ—¶çš„å›ç­”æ˜¯
#+BEGIN_QUOTE
å¦‚æœä¸¤ä¸ª Component ä¸æ˜¯çˆ¶å­å…³ç³»æˆ–è€…å…„å¼Ÿæˆ–è€…ä¼¯çˆ¶ä¾„å¥³ï¼Œä»–ä»¬çœŸçš„éœ€è¦äº¤äº’å—ï¼Ÿ
#+END_QUOTE

æ‰€ä»¥æ¯«æ— æ¡†æ¶çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æ‰¾åˆ°ä¸¤ä¸ª component çš„å…±åŒçˆ¶å…ƒç´ ï¼Œä¸€å±‚ä¸€å±‚å›è°ƒä¸Šå»ï¼Œåœ¨ä¸€å±‚ä¸€å±‚ props ä¼ å¯¼ å¦ä¸€ä¸ª componentã€‚

#+BEGIN_SRC dot :file images/share-parent-components.png  :exports results
digraph {
 çˆ·çˆ·çš„çˆ·çˆ·-> çˆ·çˆ·çš„ç²‘ç²‘
çˆ·çˆ·çš„ç²‘ç²‘ -> çˆ·çˆ·çš„çˆ·çˆ·  [xlabel=æˆ‘å¨ƒçš„å­™è¢«ç‚¹äº†ä¸€ä¸‹]
çˆ·çˆ·çš„ç²‘ç²‘ ->  çˆ·çˆ·
çˆ·çˆ· -> çˆ·çˆ·çš„ç²‘ç²‘ [xlabel=æˆ‘å­™ç‚¹äº†ä¸€ä¸‹]
  çˆ·çˆ· -> ç²‘ç²‘
 ç²‘ç²‘ -> çˆ·çˆ· [xlabel=æˆ‘å¨ƒè¢«ç‚¹äº†ä¸€ä¸‹]
ç²‘ç²‘ -> A
 A -> ç²‘ç²‘ [xlabel=æˆ‘è¢«ç‚¹äº†ä¸€ä¸‹]

 çˆ·çˆ·çš„çˆ·çˆ·-> çˆ·çˆ·çš„å”å”
çˆ·çˆ·çš„å”å” ->  çˆ·çˆ·çš„å ‚å…„
  çˆ·çˆ·çš„å ‚å…„ ->  ç²‘ç²‘çš„å”å”çš„å¨ƒ 
ç²‘ç²‘çš„å”å”çš„å¨ƒ  -> B
}
#+END_SRC

#+RESULTS:
[[file:images/share-parent-components.png]]


å¥½å§ï¼Œå¦‚æœ component æ ‘çš„å±‚æ¬¡å¤ªå¤šï¼Œé‚£ä¹ˆå†™ callback å°±ä¼šè·Ÿè¿™ä¸ªå›¾ä¸Šå¿äº²æˆšä¸€æ ·æ™•ï¼Œè€Œä¸”ä¸€æ—¦ä¸­é—´è°åœ¨å¾€äº†ä¼ è¿™ä¸ª callback å°±ä¼šæŒ‚æ‰ã€‚

** flux
äºæ˜¯ï¼Œå¯¹äºå¤æ‚ component äº¤äº’çš„æƒ…æ™¯ï¼Œfacebook æä¾›äº† flux æ¶æ„è®¾è®¡ï¼ˆå½“ç„¶ä¹Ÿå®ç°äº†https://github.com/facebook/fluxï¼‰

#+caption: flux æ¶æ„
[[https://raw.githubusercontent.com/facebook/flux/master/docs/img/flux-diagram-white-background.png]]

è¿™ä¸ªå›¾ä¼°è®¡å¤§å®¶è¢«å„ç§ facebook çš„ jsconf æ´—è¿‡è„‘äº†ï¼Œå•å‘çš„æ•°æ®æµï¼Œä¸­é—´åŠ äº†ä¸€å¤§å †ä¸œè¥¿

[[./images/brainwashing-frog.gif]]

- actionï¼šè¦å¹²ä»€ä¹ˆ
- dispatcherï¼šåˆ°å“ªé‡Œå»
- storeï¼šå˜ä»€ä¹ˆ/å¦‚ä½•å˜


åŸºæœ¬æ€æƒ³å°±æ˜¯æŠŠä¸€ä¸ª component æƒ³å¹²çš„äº‹æƒ…å¼„æˆ actionï¼Œdispatcher ä¼šä¸ºä¸åŒçš„ action è°ƒç”¨ä¸ç”¨çš„ store ä¸­çš„ reducerï¼Œstore çœŸæ­£ç®¡ç†ç€ component çš„çŠ¶æ€ã€‚ æŠŠå¼•èµ·çŠ¶æ€å˜åŒ–çš„æ¯ä¸€éƒ¨éƒ½åˆ†è§£å‡ºæ¥ã€‚æ©ï¼Œå¤§å‹é¡¹ç›®ä¸€å®šè¦è¿™ä¹ˆåˆ†è§£æ‰ç®—å¤§å‹ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚

åŸæ–‡æ€æƒ³å¦‚ä¸‹ï¼Œfacebook çš„è¡¨è¾¾èƒ½åŠ›æˆ‘ä¹Ÿæ˜¯ç»™è·ªäº†:
#+BEGIN_QUOTE
All data flows through the dispatcher as a central hub. Actions most often originate from user interactions with the views, and action creators are nothing more than a call into the dispatcher. The dispatcher then invokes the callbacks that the stores have registered with it, effectively dispatching the data payload contained in the actions to all stores. Within their registered callbacks, stores determine which actions they are interested in, and respond accordingly. The stores then emit a "change" event to alert the controller-views that a change to the data layer has occurred. Controller-views listen for these events and retrieve data from the stores in an event handler. The controller-views call their own render() method via setState() or forceUpdate(), updating themselves and all of their children.
#+END_QUOTE

æ€æƒ³æ˜¯ä¸é”™ï¼Œä½†æ˜¯çœ‹çœ‹ä¾‹å­ï¼Œè¿™ä¸ªdispacher æ˜¯æ€ä¹ˆä¸ªå›äº‹
#+BEGIN_SRC js
AppDispatcher.register(function(action) {
  var text;

  switch(action.actionType) {
    case TodoConstants.TODO_CREATE:
      text = action.text.trim();
      if (text !== '') {
        create(text);
        TodoStore.emitChange();
      }
      break;

    case TodoConstants.TODO_TOGGLE_COMPLETE_ALL:
      if (TodoStore.areAllComplete()) {
        updateAll({complete: false});
      } else {
        updateAll({complete: true});
      }
      TodoStore.emitChange();
      break;
...
#+END_SRC
 æˆ‘ä¸€ç›´ä»¥ä¸º dispatcher åº”è¯¥è‡ªåŠ¨ç»™æˆ‘ dispatcher æ‰å¯¹ï¼Œæˆ‘è‡ªå·±éƒ½ dispatcher å®Œäº†è¿˜è¦ dispatcher å¹²ä»€ä¹ˆï¼Ÿ

** redux
äºæ˜¯ redux å‡ºæ¥æŠŠ dispatcher è¿™ä¸€æ­¥å»æ‰äº†ï¼Œç„¶åæ”¾åˆ°äº† reducer é‡Œï¼š
#+BEGIN_SRC js
function counter(state = 0, action) {
  switch (action.type) {
  case 'INCREMENT':
    return state + 1
  case 'DECREMENT':
    return state - 1
  default:
    return state
  }
}
#+END_SRC


 ç„¶åå°±è·å¾—äº†ä¸€ç‰‡å¥½è¯„
#+BEGIN_QUOTE
    â€œLove what youâ€™re doing with Reduxâ€
    Jing Chen, creator of Flux

    â€œI asked for comments on Redux in FB's internal JS discussion group, and it was universally praised. Really awesome work.â€
    Bill Fisher, author of Flux documentation

    â€œIt's cool that you are inventing a better Flux by not doing Flux at all.â€
 AndrÃ© Staltz, creator of Cycle

#+END_QUOTE

 æˆ‘ç«Ÿæ— è¨€ä»¥å¯¹...

[[./images/wait-your-serious.gif]]

* Clojure Avengers æ¥ç›¸åŠ©
å¥½äº†ï¼Œç°åœ¨çš„é—®é¢˜å¾ˆæ˜ç¡®ï¼Œç”¨ä¸€å † *switch case* æ¥ *dispatch* ä¸ç®¡æ”¾åˆ° dispatcher é‡Œè¿˜æ˜¯ store é‡Œéƒ½ä¸€æ ·çš„ *éš¾çœ‹ï¼éš¾çœ‹ï¼éš¾çœ‹ï¼* è€Œä¸” ç”¨æˆ·ä¸ºä»€ä¹ˆéœ€è¦åšä¸€äº›è·Ÿä¸šåŠ¡æ— å…³çš„äº‹æƒ…ï¼Œå¦‚æœä½ çœ‹ä¸€ä¸‹ redux todomvc çš„ä¾‹å­ï¼š

- ç”¨æˆ·éœ€è¦è‡ªå·±åˆ›å»ºä¸€ä¸ªå…¨å±€çš„ storeï¼Ÿ
[[https://www.evernote.com/l/ABf1E2CyquRCkZOYQjiSKL5ycV3_OiR1inMB/image.png]]

- ç”¨æˆ·éœ€è¦â€œè¿æ¥â€å¸¦æœ‰ action çš„ props å’Œ App Componentï¼Ÿ
[[https://www.evernote.com/l/ABeCF0zsoQhPPJnRP4wQK0hxMbkT8zuBsS0B/image.png]]

-  ç”¨æˆ·éœ€è¦æŠŠ action å½“ props ä¼ ä¸‹å»ï¼Ÿè·Ÿä¼  callback ä¸€æ ·ï¼Ÿ
[[https://www.evernote.com/l/ABccOUGGTZVMxoqeT3GOAsoQNX1-S0b4r4MB/image.png]]

æ¥çœ‹çœ‹ Clojure æä¾›äº†å“ªäº›ä¼˜é›…çš„ä¸œè¥¿èƒ½å¸®åŠ©æˆ‘ä»¬æ¶ˆé™¤è¿™äº›çœ‹èµ·æ¥ä¸é¡ºçœ¼çš„è®¾è®¡...

** Channels
Channel æ˜¯ CSP[fn:1] çš„æ¦‚å¿µï¼Œç±»ä¼¼ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€è¾¹è¿›ï¼Œä¸€è¾¹å‡ºã€‚ ä¸è¿‡è¿›å’Œå‡ºéƒ½æ˜¯å¼‚æ­¥çš„

#+BEGIN_SRC js
const {chan, take, put} = require('con.js/async').async
let c = chan()
take(c).then(_=>console.log(_))
put(c, 'hehe')
// "hehe"
#+END_SRC

** PubSub
Pub(blication) å¯ä»¥æŒ‡å®šæŠŠ Channel çš„æŸä¸€éƒ¨åˆ†å‘å¸ƒå‡ºå»ï¼Œè®© Sub(scribe) æ¥ è®¢é˜…ã€‚

#+BEGIN_SRC js
const {chan, take, put, pub, sub} = require('con.js/async').async
let inputChan = chan()
let actionPub = pub(inputChan, _=>_.action)
let outputChan = chan()
let actionSub = sub(actionPub, 'greeting', outputChan)
put(inputChan, {action: 'greeting', value: 'Hello Clojure pubsub'})
put(inputChan, {action: 'party', value: 'wheeeee'})
take(outputChan).then(_=>console.log(_))
// {action: 'greeting', value: 'Hello Clojure pubsub'}
#+END_SRC

 ç»‘å®šåˆ° outputChan çš„ sub åªä¼šæ¥æ”¶ action ä¸º greeting çš„æ¶ˆæ¯

** Transducers
é¦–å…ˆå£°æ˜ï¼šTransducer ä¸æ˜¯æŸ¯é‡ŒåŒ–ï¼Œä¸æ˜¯æŸ¯é‡ŒåŒ–ï¼Œä¸æ˜¯æŸ¯é‡ŒåŒ–ï¼

åœ¨ Clojure 1.7 ä¹‹åï¼Œå½“ mapï¼Œfilterä¹‹ç±»çš„å‡½æ•°åªæ¥æ”¶ä¸€ä¸ªå‡½æ•°æ—¶è¿”å› transducerã€‚transducers æ˜¯å¯ä»¥é‡ç”¨ï¼Œç»„åˆï¼Œåº”ç”¨åˆ°å„ç§é›†åˆä¸ Channel ä¸Šçš„ç‰¹æ®Šå‡½æ•°ã€‚[fn:2]

#+BEGIN_SRC js
const {chan, map, take, put} = require('con.js/async').async
let xf = map(_=>_*2)
let c = chan(32, xf)
put(c, 3)
take(c, _=>console.log(_))
// 6
#+END_SRC

** Atom
åŸå­è¿™ä¸ªåå­—èµ·å¾—å¥½ï¼Œå‡½æ•°å¼ç¼–ç¨‹çš„æ•°æ®ç»“æ„éƒ½æ˜¯ immutable çš„ï¼Œå¦‚æœå¤šçº¿ç¨‹éœ€è¦å…±äº«èµ„æºï¼Œé‚£ä¹ˆå‡½æ•°å¼å¦‚ä½•è§£å†³ï¼Ÿ

è§£å†³å¤šçº¿ç¨‹é€šå¸¸æˆ‘ä»¬ä¼šåŠ é”ï¼Œæœ‰é”çš„æ“ä½œå°±ç›¸å½“äºåŸå­æ“ä½œï¼Œåœ¨æ“ä½œå…±äº«èµ„æºçš„æ—¶å€™ï¼Œä¸ç”¨æ“å¿ƒå€¼ä¼šçªç„¶è¢«åˆ«çš„çº¿ç¨‹æ”¹æ‰ã€‚

ä½†æ˜¯ atom ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹å¼å®ç°åŸå­æ“ä½œï¼Œ atom ç±»ä¼¼å®¹å™¨ï¼Œref ä¼šæŒ‡åˆ°å½“å‰çš„å€¼åˆ°åº•æ˜¯å“ªä¸€ä¸ªã€‚ç„¶åï¼Œæ“ä½œ atom å¿…é¡»ä½¿ç”¨åŸå­æ“ä½œ swap!ï¼Œswap! èƒ½ä¿éšœ åŸå­æ€§çš„åŸç†éå¸¸ç®€å•ï¼Œå°±æ˜¯å°è¯•å°†æ–°å€¼æ”¾åˆ° atom ä¸­ï¼Œå¦‚æœå½“å‰ ref å’Œ æ¢å‡ºæ¥çš„å€¼ä¸ä¸€æ ·äº†ï¼Œè¯´æ˜å¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨ swap!  è¿™ä¸ª atomã€‚swap! ä¼šä»å¤´å†æ¥ä¸€éã€‚

å½“æˆ‘ä»¬æœ‰å¾ˆå¤šçš„ channel æ˜¯ä¼šå¹¶å‘çš„æ“ä½œ stateï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ atom æ¥ä¿è¯æˆ‘ä»¬çš„ setState æ˜¯åŸå­æ“ä½œã€‚

/ç”±äºæ˜¯ä½¿ç”¨ transducer æ¥æ›¿ä»£ redux çš„ reducerï¼Œæˆ‘ç»™æ–°æ¡†æ¶ +å±±å¯¨+ å“äº®çš„å«åš Transdux ï¼/

* Day 0 - Inception
åœ¨è§£é‡Šäº†ä¸€é€šæˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„ Clojure æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¼€å§‹è¯•è¯•å°†ä»–ä»¬èåˆåˆ°ä¸€èµ·ï¼Œæ¥ç®¡ç†æˆ‘ä»¬çš„ Component çš„ stateã€‚

ç»è¿‡æˆ‘ä»¬ä¸€ä¸‹åˆï¼ˆæ—©ä¸Šæ˜¯ kickoffå’Œè§£é‡Šä¸Šé¢è¿™ä¸€å †æ•°æ®ç»“æ„) æ¿€ +æƒ…+ çƒˆçš„è®¨è®ºï¼Œç»ˆäºåˆæ­¥æœ‰äº† transdux çš„é›å½¢

#+caption: transdux åŸå‹è‰ç¨¿
[[https://www.evernote.com/l/ABd31BSoVoxMGJ66lygc0t2mK0cAmW3VQ60B/image.png]]

1. ä» ClojureScript æŠŠ transducerï¼Œchannelï¼Œpubï¼Œsub ä¹‹ç±»çš„ export å‡ºæ¥ï¼Œcompile æˆ JavaScriptã€‚å€Ÿç”¨ moriï¼Œ[[https://medium.com/@oyanglulu/i-just-fork-mori-and-add-core-async-to-it-3cea689e9259#.fzwrn6ofm][fork ä¸€ä¸‹æ”¹æ”¹å®Œæˆäº†]]ï¼Œæˆ‘æŠŠå®ƒå« [[http://github.com/jcouyang/conjs][conjs]]
2. ä½¿ç”¨ pubsub æ¥æ›¿ä»£ dispatcherï¼Œå½“ sub äº† action çš„ä¸åŒç±»å‹ä¹‹åï¼Œè‡ªç„¶ä¹Ÿè‡ªåŠ¨åªæ¥æ”¶ subscribe çš„æ¶ˆæ¯ã€‚æ‰€ä»¥è¿™é‡Œæ¡†æ¶ä¼šä¸ºæ¯ä¸€ä¸ª action ç”Ÿæˆä¸€ä¸ª sub
3. æ¡†æ¶è¿˜éœ€è¦ä¸ºæ¯ä¸€ä¸ª sub å‡†å¤‡ä¸€ä¸ªè¾“å‡º channelï¼Œç„¶åä½¿ç”¨ transducer å°†ç”¨æˆ·çš„ä¸šåŠ¡é€»è¾‘ç»‘åˆ°è¾“å‡º channel ä¸Šã€‚è¿™æ ·æ¯æ¬¡ç»è¿‡è¿™ä¸ªè¾“å‡ºçš„ channel çš„æ¶ˆæ¯ï¼Œéƒ½ä¼šè¢«ç”¨æˆ·çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå¾—å‡ºæ–°çš„ stateã€‚

å¥½äº†ï¼Œå¤§è‡´å°±è¿™æ ·äº†ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å¼€å§‹åšå‘¢ï¼Ÿå›åˆ°æˆ‘ä»¬åšè¿™ä¸ªæ¡†æ¶çš„åˆå¿ƒï¼Œæ˜¯ä¸ºäº†ç”¨æˆ·å†™å‡ºæ›´ç®€æ´çš„ä»£ç ï¼ŒåŒæ—¶è¿˜èƒ½è·å¾— [fl|re]dux çš„å¥½å¤„ã€‚

é‚£ä¹ˆæˆ‘ä»¬å°± EDDï¼ˆExample Driven Developmentï¼Œéªšå¹´ï¼Œåˆ«æŸ¥äº†ï¼Œæˆ‘éšä¾¿ç¼–çš„è¯ï¼‰ ä¸€æŠŠå¥½äº†ã€‚EDD çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„
1. å» redux çš„ repo æŠŠé‚£ä¸ªä¸‘ä¸‘çš„ todomvc ä¾‹å­è€ƒè¿‡æ¥
2. æŠŠæ‰€æœ‰ redux æ¡†æ¶ +æ±¡æŸ“+ è¦†ç›–çš„åœ°æ–¹éƒ½åˆ æ‰ï¼Œéƒ½åˆ æ‰ï¼Œåˆ æ‰ï¼Œæ‰...
3. å¥½äº†ï¼Œä¾‹å­åœ¨æ²¡æœ‰ redux ä¹‹åè‚¯å®šä¼šæŒ‚æ‰äº†ï¼Œé‚£ä¹ˆç°åœ¨ï¼Œç”¨å‰é¢è§£é‡Šçš„æ‹‰ä¸€å¤§å † Clojure çš„æ•°æ®ç»“æ„æŠŠ todomvc åœ¨ç»™å®ç°äº†ã€‚

* Day 1 - Hack Hack Hack...
#+BEGIN_QUOTE
æ³¨æ„ï¼Œæˆ‘å·²ç»æŠŠè¦ç”¨åˆ°çš„è¿™ä¸€å † Clojure æ•°æ®æœºæ„éƒ½ export å¹¶ compile æˆäº† javascriptã€‚æƒ³å…·ä½“äº†è§£çš„å¯ä»¥çœ‹[[https://medium.com/@oyanglulu/i-just-fork-mori-and-add-core-async-to-it-3cea689e9259#.fzwrn6ofm][è¿™ç¯‡æ–‡ç« ]]å’Œ [[http://github.com/jcouyang/conjs][conjs æºç ]]
#+END_QUOTE

** åˆç‰ˆï¼Œåªå®ç°ä¸€ä¸ªåŠŸèƒ½
æ¥çœ‹çœ‹æˆ‘ä»¬ EDD çš„[[https://github.com/jcouyang/transdux/blob/5da5107cb2de11414c5b3c2659cf19e790264ff9/src/components/MainSection.jsx#L33][ç¬¬ä¸€ç‰ˆå®ç°]]ï¼Œæ˜¯å¤šä¹ˆçš„ç®€å•
#+BEGIN_SRC js -n -r
  componentDidMount(){
    // -------vv code user should write vv------------------
    function complete(msg){  (ref:complete)
      return state=>map(todo=>{
        if(todo.get('id')==msg.id)
          return updateIn(todo, ['completed'], _=>!_ )
          return todo
      }, state)
    }
    // ---------------------------------

    // ---------- code should extract to transdux -------------------
    let tx = map((msg)=>{
      return toJs(complete(msg)(extra.toClj(this.state.todos)))
    });

    let completeChan = chan(1, tx);
    
    sub(this.props.pub, "Todo.complete", completeChan);
    
    function takeloop(chan, action){
      take(chan).then(action).then(takeloop.bind(null, chan,action))
    }
    takeloop(completeChan, (newtodos)=>{
      this.setState({todos: newtodos})
    })
    // ----------
  }
#+END_SRC

 æ²¡æœ‰é”™ï¼Œè·Ÿ TDD ä¸€æ ·ï¼Œå…ˆå®ç°ï¼Œåœ¨é‡æ„
ç›®çš„éå¸¸æ˜ç¡®ï¼Œç”¨æˆ·åªéœ€è¦å®šä¹‰ï¼Œæˆ‘è¿™ä¸ª component èƒ½å¹²ä»€ä¹ˆï¼Œæ‰€ä»¥è¿™é‡Œç¬¬[[(complete)][(complete)]]è¡Œï¼Œå°±è¯´æˆ‘ æ˜¯ todo æˆ‘èƒ½ complete

ç„¶ååä¸½çš„åˆ†å‰²çº¿ä¸‹é¢æ˜¯æˆ‘ä»¬æ¡†æ¶è¦åšçš„äº‹æƒ…
1. ä¸€ä¸ªç”¨ç”¨æˆ·æä¾›çš„ action ç»„æˆçš„ transducer
2. ä¸€ä¸ª action channelï¼Œç”¨æ¥ç»‘å®š transducer
3. ä¸€ä¸ª subï¼Œ åªè®¢é˜… â€œtodo.completeâ€ çš„æ¶ˆæ¯
4. ä¸€ä¸ª loopï¼Œä¸åœçš„å» action channel é‚£æ–°çš„ state

é‚£ä¹ˆåœ¨ä½¿ç”¨çš„åœ°æ–¹ï¼Œåªéœ€è¦å‘ä¸€ä¸ª action ä¸ºâ€œtodo.completeâ€ çš„æ¶ˆæ¯å³å¯

** æå–æ¡†æ¶

å½“ç„¶æˆ‘ä»¬éœ€è¦å°è£…è¿™äº›è£¸è£¸çš„å®ç°ï¼Œå½“ç„¶æå–è¿™ä¸€ç¥¨ä»£ç å—ç‰¹åˆ«ç®€å•ï¼Œå†™ä¸€ä¸ª mixin è®©éœ€è¦ç”¨åˆ°çš„ component è‡ªå·± mixin è¿›æ¥å°±å¥½ã€‚

é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸ª Component ç”¨åˆ°çš„ input channnel å’Œ publication æ˜¯è°ã€‚
*** ä¼ é€’ inputChan å’Œ action çš„ publication
æˆ‘ä¸ä¼šä½¿ç”¨ redux é‚£æ ·ç¬¨ç¬¨çš„è®©ç”¨æˆ·ä¸€å±‚å±‚ä¼ ä¸‹å»çš„æ–¹å¼ï¼Œæœ‰è¿™åŠŸå¤«æˆ‘å¯ä»¥ä¼  callbackï¼Œé‚£æ¡†æ¶åˆ°åº•ä¸ºæˆ‘åšäº†ä»€ä¹ˆï¼Ÿ

æ‰€ä»¥ï¼Œtransdux æä¾›ä¸€ä¸ª wrapper component /Transdux/
#+BEGIN_SRC html
<Transdux>
    <App/>
</Transdux>
#+END_SRC

 åªéœ€è¦ç”¨ Transdux component åŒ…ä½ä½ çš„ component å³å¯ï¼Œå¦‚æœä½ æœ‰ä¸¤ä¸ª Appï¼Œé‚£ä¹ˆåˆ†åˆ« wrap å¯ä»¥ä¿è¯ä»–ä»¬ç”¨çš„æ˜¯ä¸¤å¥— transdux çš„ channelï¼Œpubsubè€Œäº’ç›¸ä¸å—å¹²æ‰°ã€‚
 #+BEGIN_SRC html
<div>
  <Transdux>
    <App/>
  </Transdux>
  <Transdux>
    <App2/>
  </Transdux>
</div> 
 #+END_SRC

 å…·ä½“å®ç°ä¹Ÿä¸éš¾ï¼Œåˆ©ç”¨ React çš„ child context

#+BEGIN_SRC js
childContextTypes: {
    transduxChannel: React.PropTypes.object,
    transduxPublication: React.PropTypes.object,
  },
  getChildContext(){
    let inputchan = chan();
    return {
      transduxChannel: inputchan,
      transduxPublication: pub(inputchan, _=>_['action']),
    }
  },
#+END_SRC

[[https://facebook.github.io/react/docs/context.html][child context]] æ˜¯ React ä¸€ä¸ª ç»™å­ component ä¼ é€’ context æ˜¯ä¸€ç§æ–¹å¼ï¼Œ é€šè¿‡è¿™æ ·å°±æ— éœ€çˆ¶ component ä¸€å±‚ä¸€å±‚ä¼ ä¸‹å»ï¼Œè€Œåœ¨æ‰€æœ‰çš„å­ component éƒ½éšæ—¶å¯ä»¥ä» =this.context= ä¸­æ‰¾åˆ°çˆ¶ component =getChildContext=  è¿”å›çš„å€¼ã€‚

äºæ˜¯æ— éœ€ä»»ä½•ä¼ é€’ï¼Œ æ‰€æœ‰å­ componentéƒ½èƒ½è·å¾— transdux çš„ channel ä»¥åŠ publicationã€‚

*** åˆ†è¾¨ä¸åŒçš„ ReactClass 
 å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬åœ¨ dispatch çš„æ—¶å€™ï¼Œå¦‚ä½•çŸ¥é“ç»™é‚£ä¸ª component å‘æ¶ˆæ¯å‘¢ï¼Ÿæœ€ç›´æ¥çš„æ–¹å¼æ˜¯ï¼ŒæŠŠéœ€è¦æ¥å—æ¶ˆæ¯çš„ component require è¿›æ¥
#+BEGIN_QUOTE
 ä½ è¿‡æ¥ï¼Œæˆ‘ä¿è¯ä¸æ‰“ä½ 
#+END_QUOTE
#+BEGIN_SRC js
import MainSection from './MainSection'
let TodoItem = React.createClass({
    mixins: [TxMixin],
 ...
           this.dispatch(MainSection, 'complete',{id:todo.id})
...
    }
})
#+END_SRC

è¿™æ ·çš„æ¶ˆæ¯éå¸¸æ¸…æ™°ï¼Œè€Œä¸”æ°¸è¿œä¸å¯èƒ½å‘é”™æ¶ˆæ¯ï¼Œé™¤é require é”™äº† componentã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œdispatch å¿…é¡»èƒ½æ ¹æ®è¿™ä¸ª React Class åˆ†è¾¨ï¼Ÿ

*transdux* ä¸ºæ¯ä¸€ç»‘å®š actions çš„ component ç”Ÿæˆä¸€ä¸ª uuid
*** bindActions
åœ¨æœ‰äº† channel å’Œ publication ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ç»‘å®šç”¨æˆ·çš„ action åˆ° action channel ä¸Šï¼Œå¹¶ç”Ÿæˆç›¸å¯¹åº”çš„ sub
 
æŠŠç¬¬ä¸€ç‰ˆå®ç°çš„ä»£ç åŒ…åˆ° mixin ä¸­ï¼Œä¼šæ˜¯è¿™æ ·çš„ï¼š
#+BEGIN_SRC js -n -r
  bindActions(actions, imm=id, unimm=id) {
    let atomState = atom(imm(this.getInitialState()))
    for(let name in actions){
      let tx = map((msg)=>{
        let result = swap(atomState, (state,v)=>actions[name](v,state), msg.value)  (ref:swap)
        this.setState(unimm(result))
        return result
      });
      let actionChan = chan(32,tx); (ref:actionChan)
      sub(this.context.transduxPublication, genUuid(this.constructor)+name, actionChan); (ref:sub)
      observe(actionChan, (newstate)=>{});  (ref:observe)
    }
  },
#+END_SRC

- è¿˜è®°å¾—ä¹‹å‰è¯´çš„ atom å—ï¼Ÿ[[(swap)][è¿™é‡Œ]] swap å°è¯•å°† =msg.value= å’Œ =state= ä¼ å…¥ =actions[name]= ï¼Œå°†å…¶è¿”å›å€¼æ¢å…¥ atom å†…ã€‚
- ç¬¬[[(actionChan)][(actionChan)]]è¡Œå°†ä¹‹å‰ map è¿”å›çš„ transducer æ”¾åˆ° actionChan ä¸Šï¼Œå…¶ä¸­çš„32ä»£è¡¨ channel çš„é•¿åº¦ä¸º32ã€‚ *æ³¨æ„ä»€ä¹ˆæ—¶å€™è¿™ä¸ª transducer æ˜¯ lazy çš„ï¼Œæ‰€ä»¥åªæœ‰ take çš„æ—¶å€™ä¼šåº”ç”¨ action åˆ° channel çš„å…ƒç´ ä¸Š* ã€‚æ‰€ä»¥ transducer çœŸä¸æ˜¯æŸ¯é‡ŒåŒ–ï¼Œä¸æ˜¯æŸ¯é‡ŒåŒ–ï¼ŒæŸ¯é‡ŒåŒ–ï¼Œé‡ŒåŒ–ï¼ŒåŒ–...
- åœ¨ç¬¬[[(sub)][(sub)]]è¡ŒæŠŠè¯¥ class ç”Ÿæˆçš„ uuid å’Œ action çš„åå­—ä½œä¸º action çš„å”¯ä¸€æ ‡è¯†ã€‚ç”±äºæ˜¯ mixinï¼Œæ‰€ä»¥ç›´æ¥èƒ½è·å¾—è¯¥ component ä¸Šçš„ publication
- æœ€å observe ä¸€ä¸‹å°±å¥½äº†ï¼Œå…¶å® observer ä»€ä¹ˆéƒ½æ²¡å¹²ï¼Œå…¶å®å¯ä»¥çœ‹çœ‹æˆ‘çš„ [[https://github.com/jcouyang/conjs/blob/master/src/mori/core.async.cljs#L17][observe å®ç°]]ï¼Œåªæ˜¯ä¸€ä¸ªç®€å•çš„ go-loopï¼Œä¸åœçš„ take channel çš„æ¶ˆæ¯ã€‚ä¸ç„¶æ²¡äºº take æ¶ˆæ¯ä¼šå †ç§¯æ»¡ï¼Œå°±å†ä¹Ÿ put ä¸è¿›æ¥äº†ã€‚
#+BEGIN_SRC clojure
(defn ^:export observe [chan cb]
  (go-loop []
    (let [v (async/<! chan)]
      (cb v)
      (recur))))
#+END_SRC


* Day 2 - Show Case
æ‰˜äº† clojure çš„ç¦ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å†™å¤šå°‘ä»£ç ï¼Œå°±è½»æ¾å®ç°äº†ä¸€ä¸ªå¯¹ç”¨æˆ·æ›´å‹å¥½çš„ flux like æ¡†æ¶ã€‚åœ¨æ ¸å¿ƒåŠŸèƒ½å®ç°åï¼Œæˆ‘ä»¬å¼€å§‹è¿›è¡Œ opensource project çš„ routine
- å†™ [[https://github.com/jcouyang/transdux/blob/master/README.org][readme]]
- å†™ä¾‹å­ [[https://github.com/jcouyang/transdux/tree/master/examples/todomvc][todomvc]]
- é€‰ä¸ª [[http://choosealicense.com/][license]]
- [[https://www.npmjs.com/package/transdux][npm publish]]
- å‡†å¤‡èƒ½æŠŠå¤§å®¶å°†æ‡‚çš„ slide

#+caption: æ­¤å¤„åº”æœ‰æŒå£°
[[./images/applause.jpg]]

* Recap

#+caption: The Big Picture of Transdux
[[https://www.evernote.com/l/ABe_8eE6o2dGlZMCmNnBap_fXy83GvJe6gcB/image.jpg]]

 æ‰€ä»¥ï¼Œä½¿ç”¨ transdux  ç»™ react component äº¤äº’ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºæ¡†æ¶æä¾›ä¸¤ä»¶äº‹æƒ…
** 1. æŠŠä½ çš„ component åŒ…åˆ° Transdux é‡Œ
#+BEGIN_SRC html
  <Transdux>
      <App/>
  </Transdux>
#+END_SRC
** 2. å®šä¹‰ä½ çš„ component èƒ½å¹²ä»€ä¹ˆï¼Ÿä½ çš„çŠ¶æ€èƒ½æ€ä¹ˆå˜ï¼Ÿ
#+BEGIN_SRC js
// MainSection.jsx
import {TxMixin} from 'transdux'
let actions = {
  complete(msg, state){
    return {
      todos:state.todos.map(todo=>{
        if(todo.id==msg.id)
          todo.completed = !todo.completed
        return todo
      })
    }
  },
  clear(msg,state){
    return {
      todos: state.todos.filter(todo=>todo.completed==false)
    }
  }
}
let MainSection = React.createClass({
  mixins: [TxMixin],
  componentDidMount(){
    this.bindActions(actions)
  },
  ...
})
#+END_SRC

ç„¶åï¼Œå°±å¯ä»¥å¼€å§‹ *å‘æ¶ˆæ¯* äº†
#+BEGIN_SRC jsx
    //TodoItem.jsx
    import MainSection from './MainSection'
    let TodoItem = React.createClass({
        mixins: [TxMixin],
        ...
          this.dispatch(MainSection, 'complete',{id:todo.id})
        ...
        }
    })
#+END_SRC

 æœ€åï¼Œè¦æ„Ÿè°¢æˆ‘ä»¬æ£’æ£’çš„ Team member [[https://github.com/SanCoder-Q][@SanCoder-Q]] [[https://github.com/zhangyaxuan][@zhangyaxuan]] [[https://github.com/nihaokid][@nihaokid]] [[https://github.com/xiaoyanzhuzzh][@xiaoyanzhuzzh]] 

#+HTML: æœ€åï¼Œæ¬¢è¿ <a aria-label="Star jcouyang/transdux on GitHub" data-count-aria-label="# stargazers on GitHub" data-count-api="/repos/jcouyang/transdux#stargazers_count" data-count-href="/jcouyang/transdux/stargazers" data-style="mega" href="https://github.com/jcouyang/transdux" class="github-button">Fork me on Github</a>

/æ‰€æœ‰å›¾ç‰‡æ¥æºäº giphy.com, copyright/ @[[http://www.cc.com/shows/futurama][Futurama]]

* Footnotes

[fn:2]  ä¸“é—¨å†™è¿‡ä¸€ç¯‡æ–‡ç« ä»‹ç»è¿‡ http://blog.oyanglul.us/javascript/clojure-essence-in-javascript-transducer.html

[fn:1] å…·ä½“å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç«  http://blog.oyanglul.us/javascript/clojure-core.async-essence-in-native-javascript.html
