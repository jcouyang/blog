<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-10-05 Wed 06:27 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2019 Year in Review</title>
<meta name="author" content="Jichao Ouyang" />
<meta name="description" content="Highlights about what happened last year." />
<meta name="keywords" content="Scala,Free,Monad,MTL,ReaderT,Kleisli,Grokking Monad,Zhuyu,Jujiu,Luci" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style/toc.css"/>
<link rel="stylesheet" href="/style/tufte.css"/>
<link rel="stylesheet" href="/style/main.css"/>
<link rel="alternate" type="application/rss+xml" title="Jichao Ouyang" href="https://feeds.oyanglul.us/JichaoOuyangsBlog"/>
<meta property="og:title" content="2019 Year in Review" />
<meta property="og:description" content="2019 Year in Review" />
<meta property="og:type" content="article" />
<meta content="https://blog.oyanglul.us/images/Screenshot_2020-01-01%20jcouyang%20-%20Overview.png" property="og:image">
</head>
<body>
<div id="preamble" class="status">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJRFJGX"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header>
    <a accesskey="h" href="/index.html"> HOME </a> |
    <a href="#" id="edit-in-github">EDIT</a> |
    <a href="https://feeds.oyanglul.us/JichaoOuyangsBlog">RSS</a> |
    <a href="https://blog.oyanglul.us/theindex">INDEX</a> |
    <a accesskey="H" href="/jichao.ouyang.html">ABOUT</a> |
    <a href="https://github.com/jcouyang/blog">GITHUB</a>
</header>
</div>
<div id="content" class="content">
<header>
<h1 class="title">2019 Year in Review</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0d5918f">3 Layer Scala Cake</a></li>
<li><a href="#org162a9df">Grokking Monad</a></li>
<li><a href="#orga224c82">Kleisli{F{_}, -A, B}</a></li>
<li><a href="#org04cd33a">Zhuyu</a></li>
<li><a href="#orga1cff1a">IndexOf at Type Level</a></li>
<li><a href="#org32d1285">Type Driven Development with PureScript</a></li>
<li><a href="#orgde53a05">Functional Scala Cachinng</a></li>
<li><a href="#org2443914">Owlet</a></li>
</ul>
</div>
</nav>
<p>
I've 2210 commits over the whole year.
</p>


<figure id="org0de5c5a">
<img src="./images/Screenshot_2020-01-01%20jcouyang%20-%20Overview.png" alt="Screenshot_2020-01-01%20jcouyang%20-%20Overview.png">

</figure>

<p>
But actually only 450 is for open source, it is been a busy year in MYOB.
</p>

<div id="outline-container-org0d5918f" class="outline-2">
<h2 id="org0d5918f"><a href="./scala/3-layer-cake.html">3 Layer Scala Cake</a></h2>
<div class="outline-text-2" id="text-org0d5918f">
<p>
By introducing the 3 layer cake concept to Scala,
I also published the <a href="https://github.com/jcouyang/luci">luci</a> lib to help building extensible Free Monad effects.
</p>
</div>
</div>

<div id="outline-container-org162a9df" class="outline-2">
<h2 id="org162a9df"><a href="https://gumroad.com/l/grokking-monad">Grokking Monad</a></h2>
<div class="outline-text-2" id="text-org162a9df">

<figure id="orgdaa8ae5">
<img src="./images/Screenshot_2020-01-01%20Gumroad%20-%20Analytics.png" alt="Screenshot_2020-01-01%20Gumroad%20-%20Analytics.png">

</figure>

<p>
I was not actively updating this book in 2019.
I hope all my readers are happy, I was told it is the best book
about Category Theory in Chinese.
Hoping there will be more time can be focus on updating it in 2020.
</p>

<p>
<a href="https://gumroad.com/l/grokking-monad">Buy one</a> if you can read Chinese and curious about Monad, now examples are available in
both Haskell and Scala.
</p>
</div>
</div>

<div id="outline-container-orga224c82" class="outline-2">
<h2 id="orga224c82"><a href="https://typelevel.org/cats/api/cats/data/Kleisli.html">Kleisli{F{_}, -A, B}</a></h2>
<div class="outline-text-2" id="text-orga224c82">
<p>
I made a change to the <code>Kleisli</code> type so <code>A</code> is now contravariant <code>-A</code>.
By Scala subtyping system, we can save a lot of contramaping.
</p>

<p>
If you want to flatmap different input type of Kleisli before:
</p>
<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">for</span> {
  k1 <span style="color: #81A1C1;">&lt;-</span> <span style="color: #81A1C1;">Kleisli</span>((a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A1</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">List</span>(<span style="color: #81A1C1;">1</span>)).local(identity[<span style="color: #81A1C1;">A1</span> <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">A2</span> <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">A3</span>])
  k2 <span style="color: #81A1C1;">&lt;-</span> <span style="color: #81A1C1;">Kleisli</span>((a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A2</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">List</span>(<span style="color: #D08770;">"2"</span>)).local(identity[<span style="color: #81A1C1;">A1</span> <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">A2</span> <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">A3</span>])
  k3 <span style="color: #81A1C1;">&lt;-</span> <span style="color: #81A1C1;">Kleisli</span>((a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A3</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">List</span>(<span style="color: #81A1C1;">true</span>)).local(identity[<span style="color: #81A1C1;">A1</span> <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">A2</span> <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">A3</span>])
} <span style="color: #81A1C1;">yield</span> (k1, k2, k3)
</code></pre>

<p>
after cats 2.0 you can just:
</p>
<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">for</span> {
  k1 <span style="color: #81A1C1;">&lt;-</span> <span style="color: #81A1C1;">Kleisli</span>((a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A1</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">List</span>(<span style="color: #81A1C1;">1</span>))
  k2 <span style="color: #81A1C1;">&lt;-</span> <span style="color: #81A1C1;">Kleisli</span>((a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A2</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">List</span>(<span style="color: #D08770;">"2"</span>))
  k3 <span style="color: #81A1C1;">&lt;-</span> <span style="color: #81A1C1;">Kleisli</span>((a<span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">A3</span>) <span style="color: #81A1C1;">=&gt;</span> <span style="color: #81A1C1;">List</span>(<span style="color: #81A1C1;">true</span>))
} <span style="color: #81A1C1;">yield</span> (k1, k2, k3)
</code></pre>

<p>
since <code>-A</code> is contravariant, Scala can tell the <code>program</code> has type <code>Kleisli[List, A1 with A2 with A3, (Int, String, Boolean)]</code>
</p>

<p>
The power of Kleisli subtyping lead to a very powerful lib that I recently
published for our team - Zhuyu.
</p>
</div>
</div>

<div id="outline-container-org04cd33a" class="outline-2">
<h2 id="org04cd33a"><a href="https://github.com/jcouyang/zhuyu">Zhuyu</a></h2>
<div class="outline-text-2" id="text-org04cd33a">
<p>
With the power of Kleisli, now all kind of effect is composable:
</p>
<pre class="code"><code><span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">program</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">for</span> {
 <span style="color: #81A1C1;">_</span> <span style="color: #81A1C1;">&lt;-</span> effects.<span style="color: #81A1C1;">Http4s</span>(<span style="color: #81A1C1;">_</span>.status(<span style="color: #81A1C1;">GET</span>(uri<span style="color: #D08770;">"https://blog.oyanglul.us"</span>)))
 <span style="color: #81A1C1;">_</span> <span style="color: #81A1C1;">&lt;-</span> effects.<span style="color: #81A1C1;">S3</span>(<span style="color: #81A1C1;">_</span>.putObject(<span style="color: #D08770;">"example-bucket"</span>, <span style="color: #D08770;">"filename"</span>, <span style="color: #D08770;">"content"</span>))
 <span style="color: #81A1C1;">_</span> <span style="color: #81A1C1;">&lt;-</span> effects.<span style="color: #81A1C1;">Doobie</span>(sql<span style="color: #D08770;">"select 250"</span>.query[<span style="color: #81A1C1;">Int</span>].unique)
} <span style="color: #81A1C1;">yield</span>()
<span style="color: #677691;">// </span><span style="color: #677691;">Kleisli[IO, HasHttp4s with HasS3 with HasDoobie, Unit]</span>
</code></pre>

<p>
More importantly Zhuyu provide a typesafe SQS worker, so you can safely consume
messages from SQS, even spread more message back to the SQS, without worry about
causing any loop in the queue, because now we can count at type level with shapeless.
All these check happen in compile time so you know your code will cause a loop
if it didn't compile.
</p>

<p>
If you need a worker that consume SQS, just
</p>

<pre class="example" id="org2b9f939">
sbt new jcouyang/zhuyu.g8
</pre>

<p>
There is also a simple tutorial video in <a href="https://github.com/jcouyang/zhuyu.g8">README</a>
</p>
</div>
</div>

<div id="outline-container-orga1cff1a" class="outline-2">
<h2 id="orga1cff1a"><a href="https://github.com/milessabin/shapeless/blob/8626f15ed92b922a6381a9e11c3a34b76b55e337/core/src/main/scala/shapeless/ops/coproduct.scala#L107">IndexOf at Type Level</a></h2>
<div class="outline-text-2" id="text-orga1cff1a">
<p>
Since zhuyu needs to find out the position of a type in coproduct type,
I also made change to <a href="https://github.com/milessabin/shapeless">shapeless</a> so we can find out the index of
a specific type in coproduct
</p>
<pre class="code"><code>  <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">S</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">String</span>; <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">I</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Int</span>; <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">D</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Double</span>; <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">C</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Char</span>
  <span style="color: #81A1C1;">type</span> <span style="color: #81A1C1;">SIDC</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">S</span> :+: <span style="color: #81A1C1;">I</span> :+: <span style="color: #81A1C1;">D</span> :+: <span style="color: #81A1C1;">C</span> :+: <span style="color: #81A1C1;">CNil</span>

  {
    <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">r1</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">IndexOf</span>[<span style="color: #81A1C1;">SIDC</span>, <span style="color: #81A1C1;">S</span>].value
    assertTypedEquals(<span style="color: #81A1C1;">0</span>, r1)

    <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">r2</span><span style="color: #81A1C1;">:</span> <span style="color: #81A1C1;">Nat</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">IndexOf</span>[<span style="color: #81A1C1;">SIDC</span>, <span style="color: #81A1C1;">I</span>].apply()
    assertTypedEquals(<span style="color: #81A1C1;">Nat</span>._1, r2)

    <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">r3</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">Coproduct</span>[<span style="color: #81A1C1;">SIDC</span>](<span style="color: #81A1C1;">1</span>).indexOf[<span style="color: #81A1C1;">D</span>]
    assertTypedEquals(<span style="color: #81A1C1;">Nat</span>._2, r3)

    <span style="color: #81A1C1;">val</span> <span style="font-weight: bold;">r4</span> <span style="color: #81A1C1;">=</span> <span style="color: #81A1C1;">IndexOf</span>[<span style="color: #81A1C1;">SIDC</span>, <span style="color: #81A1C1;">C</span>].value
    assertTypedEquals(<span style="color: #81A1C1;">3</span>, r4)
  }
}
</code></pre>
</div>
</div>

<div id="outline-container-org32d1285" class="outline-2">
<h2 id="org32d1285"><a href="./purescript/type-driven-development-with-purescript/index.html">Type Driven Development with PureScript</a></h2>
<div class="outline-text-2" id="text-org32d1285">
<p>
We are migrating our production UI codebase from TypeScript to PureScript.
</p>

<p>
<a href="https://paper.dropbox.com/doc/PureScript-on-Production--AriMP07VB6jhwgqcUJnKSnaLAg-ST0wPhRDvFST3UemcvdVY">Here is detail why and how.</a>
</p>

<p>
At the end
</p>
<ul class="org-ul">
<li>we have 10% of PureScript on production.</li>
<li>code quality are increasing</li>
<li>bug rate decreasing</li>
<li>members are uplifted with functional programming skill</li>
<li>line of code decresing</li>
<li>React eco system and purescript coexist well so far</li>
</ul>

<p>
Read the <a href="https://blog.oyanglul.us/purescript/cheatsheet">cheatsheet</a> to find out how easy to convert from JS to PureScript
</p>
</div>
</div>

<div id="outline-container-orgde53a05" class="outline-2">
<h2 id="orgde53a05"><a href="https://blog.oyanglul.us/scala/functional-caching">Functional Scala Cachinng</a></h2>
<div class="outline-text-2" id="text-orgde53a05">
<p>
We need to cache a lot of stuff on production, but it is hard to find a
caching library with good functional DSL.
</p>

<p>
So here is my answer <a href="https://github.com/jcouyang/jujiu">Jujiu</a>
</p>

<p>
It is just Kleisli and with fine with Tagless final as well.
</p>

<p>
It is easy to compose your caching logic into your existing logic using the DSL
, and run it on different interpreter later on. The builtin interpreter is <a href="https://github.com/ben-manes/caffeine">Caffeine</a>
and it's easy to <a href="https://github.com/jcouyang/jujiu#extensible">add Reddis support as well.</a>
</p>
</div>
</div>

<div id="outline-container-org2443914" class="outline-2">
<h2 id="org2443914">Owlet</h2>
<div class="outline-text-2" id="text-org2443914">
<p>
<a href="https://github.com/jcouyang/owlet">Owlet</a> is now available in <a href="https://scalafiddle.io/sf/mDggvjd">ScalaFiddle</a>, please try it out online.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer>
  <p>Author: Jichao Ouyang
    <a class="github-button" href="https://github.com/sponsors/jcouyang" data-icon="octicon-heart" aria-label="Sponsor @jcouyang on GitHub">Sponsor</a>
    <a aria-label="Follow @jcouyang on GitHub" data-count-aria-label="# followers on GitHub" data-count-api="/users/jcouyang#followers" data-count-href="/jcouyang/followers" href="https://github.com/jcouyang" class="github-button">Follow</a>
    <a href="https://twitter.com/oyanglulu" class="twitter-follow-button" data-show-screen-name="false" data-show-count="false">Follow @oyanglulu</a>
  </p>
  <p>Created: 2020-01-01 Wed 00:00</p>
  <p>Generated by: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 28.1 (<a href="https://orgmode.org">Org</a> mode 9.5.3) &#215; <a href="https://github.com/jcouyang/orgpress">OrgPress</a></p>
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a>.
  <input type="swiftype" class="st-default-search-input" placeholder="Search"/>
  <a class="gumroad-button" href="https://gum.co/grokking-monad?wanted=true" target="_blank" data-gumroad-single-product="true">范畴论装逼指南，请自觉排队装逼</a>
  <div id="danmaku-comments"></div>
  <div id="disqus_thread"></div>
</footer>
</div>
</body>
</html>
